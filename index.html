<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BOMB BUSTERS</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <style>
    :root { --bg:#ffffff; --ink:#111; --muted:#6b7280; --brand:#111827; --card:#f3f4f6; --accent:#e5e7eb; --shadow:0 6px 20px rgba(0,0,0,.08); --radius:16px; }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:var(--ink);background:var(--bg)}
    .app{min-height:100%;display:grid;grid-template-rows:auto 1fr}
    header{position:sticky;top:0;z-index:10;background:var(--bg);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;padding:12px 16px;gap:8px}
    .title{font-weight:800;letter-spacing:.02em;font-size:20px}
    .sub{color:var(--muted);font-size:12px}
    .right-tools{display:flex;align-items:center;gap:8px}
    .btn{appearance:none;border:0;background:var(--brand);color:#fff;padding:10px 14px;border-radius:999px;font-weight:700;font-size:14px;box-shadow:var(--shadow)}
    .btn[disabled]{opacity:.5}
    .btn-ghost{background:transparent;color:var(--brand);border:1px solid var(--accent)}
    .chip{font-size:12px;background:var(--accent);padding:4px 10px;border-radius:999px}
    .main{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;max-width:520px;margin:0 auto 80px}
    .lists-panel{position:relative;border:1px solid var(--accent);border-radius:var(--radius);background:#fff;overflow:clip;box-shadow:var(--shadow)}
    .lists-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#fafafa;border-bottom:1px solid var(--accent)}
    .lists{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px}
    .list{background:var(--card);border-radius:12px;padding:8px}
    .list h4{margin:0 0 6px;font-size:12px;color:var(--muted)}
    .list ul{list-style:none;margin:0;padding:0;display:grid;gap:6px}
    .pill{padding:6px 10px;background:#fff;border-radius:999px;border:1px solid var(--accent);font-size:13px}
    .card{background:#fff;border:1px solid var(--accent);border-radius:var(--radius);box-shadow:var(--shadow);overflow:clip}
    .card .card-h{padding:12px;background:#fafafa;border-bottom:1px solid var(--accent);font-weight:700}
    .card .card-c{padding:12px;display:grid;gap:10px}
    .row{display:grid;grid-template-columns:90px 1fr;align-items:center;gap:8px}
    .row input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--accent);font-size:14px}
    .table{display:grid;gap:12px}
    .players{display:grid;gap:12px}
    .player{border:1px solid var(--accent);border-radius:14px;overflow:clip;background:#fff}
    .player-h{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#fafafa;border-bottom:1px solid var(--accent)}
    .player-h .name{font-weight:700}
    .tags{display:flex;gap:6px;align-items:center}
    .hand{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(36px,1fr);gap:6px;padding:10px;overflow-x:auto}
    .cardv{aspect-ratio:3/4;border-radius:8px;display:grid;place-items:center;font-weight:800;font-size:16px;background:#fff;border:1px solid var(--accent);position:relative}
    .cardv.revealed{background:#fff}
    .cardv.face-down{background:#f9fafb}
    .cardv img{width:100%;height:100%;object-fit:cover;border-radius:8px}
    .muted{color:var(--muted)}
    .fab{position:fixed;right:16px;bottom:16px;z-index:30;display:none}
    .fab .gear{width:56px;height:56px;border-radius:999px;background:var(--brand);color:#fff;display:grid;place-items:center;box-shadow:var(--shadow);border:none}
    .menu{position:absolute;right:0;bottom:70px;background:#fff;border:1px solid var(--accent);border-radius:12px;box-shadow:var(--shadow);display:none;min-width:200px;overflow:hidden}
    .menu button{width:100%;display:block;padding:12px;text-align:left;border:none;background:#fff}
    .menu button:hover{background:#fafafa}
    dialog{border:1px solid var(--accent);border-radius:16px;padding:0;box-shadow:var(--shadow)}
    .modal-h{padding:12px;font-weight:700;border-bottom:1px solid var(--accent);background:#fafafa}
    .modal-c{padding:12px;display:grid;gap:8px}
    .modal-f{display:flex;justify-content:flex-end;gap:8px;padding:12px;border-top:1px solid var(--accent)}
    @media (min-width:480px){.main{grid-template-columns:1fr 210px;align-items:start}.lists-panel{position:sticky;top:72px}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="title">BOMB&nbsp;BUSTERS</div>
        <div class="sub">スマホ向けUI＋Firestore同期（GitHub Pages対応）</div>
      </div>
      <div class="right-tools">
        <span id="roomStatus" class="chip">未入室</span>
        <button id="startBtn" class="btn" disabled>爆弾を解除！</button>
      </div>
    </header>

    <main class="main">
      <section class="table">
        <div id="lobby" class="card">
          <div class="card-h">入室</div>
          <div class="card-c">
            <div class="row"><label for="room">ルーム</label><input id="room" inputmode="numeric" pattern="[0-9]*" placeholder="4桁コード" /></div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button id="joinBtn" class="btn">入室</button>
              <span class="muted" style="font-size:12px;">同じルームコードで同室へ（名前は自動割当）</span>
            </div>
          </div>
        </div>

        <div id="tableArea" class="players" hidden></div>
        <p class="muted" style="font-size:12px;margin:0 6px;">※ 裏向きカード画像のファイル名は「code裏.png」。無ければグレー表示。</p>
      </section>

      <aside id="listsWrap" class="lists-panel">
        <div class="lists-header"><div>現在の部屋</div><div class="chip" id="roomLabel">----</div></div>
        <div class="lists">
          <div class="list"><h4>参加者</h4><ul id="participants"></ul></div>
          <div class="list"><h4>観戦者</h4><ul id="spectators"></ul></div>
        </div>
      </aside>
    </main>

    <div class="fab" id="hostFab">
      <button class="gear" id="gearBtn" aria-label="設定">⚙️</button>
      <div class="menu" id="hostMenu"><button id="resetBtn">やり直し</button></div>
    </div>
  </div>

  <dialog id="roleModal">
    <div class="modal-h">役割を選択</div>
    <div class="modal-c">
      <button id="asPlayer" class="btn">参加者として入室</button>
      <button id="asSpectator" class="btn btn-ghost">観戦者として入室</button>
      <p class="muted" style="font-size:12px;margin:6px 0 0;">ゲーム開始後は参加で入っても観戦になります。やり直し後は参加者に戻ります。</p>
    </div>
    <div class="modal-f"><button id="closeRole" class="btn btn-ghost">閉じる</button></div>
  </dialog>

  <script>
    // =======================
    // Firebase 初期化（あなたの設定を組込済み）
    // =======================
    const firebaseConfig = {
      apiKey: "AIzaSyBpSx_lEcg1j9ExMJsVl5lBqAxOCfmFmSnI",
      authDomain: "chat-68c4c.firebaseapp.com",
      databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
      projectId: "chat-68c4c",
      storageBucket: "chat-68c4c.appspot.com",
      messagingSenderId: "172284325975",
      appId: "1:172284325975:web:6f9bdd77e822c0ea39dd92"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    auth.signInAnonymously().catch(console.error);

    // =======================
    // 状態とDOM
    // =======================
    const el = (id)=>document.getElementById(id);
    const participantsUl = el('participants');
    const spectatorsUl = el('spectators');
    const startBtn = el('startBtn');
    const roomStatus = el('roomStatus');
    const roomLabel = el('roomLabel');
    const tableArea = el('tableArea');
    const listsWrap = el('listsWrap');
    const lobbyCard = el('lobby');
    const hostFab = el('hostFab');
    const hostMenu = el('hostMenu');

    let self = { id:null, name:"", room:null, role:null, preferredRole:null, isHost:false };
    let unsubRoom = null, unsubPlayers = null;

    // ランダム名（日本語＋ID）
    function randomName(){
      const animals = ['ネコ','イヌ','タヌキ','キツネ','フクロウ','ペンギン','パンダ','クマ','トラ','イルカ','ウサギ'];
      const adj = ['静かな','元気な','速い','勇敢な','器用な','賢い','鋭い','陽気な','影の','白い','黒い'];
      const a = animals[Math.floor(Math.random()*animals.length)];
      const b = adj[Math.floor(Math.random()*adj.length)];
      const id = Math.random().toString(36).slice(2,6);
      return `${b}${a}-${id}`;
    }

    // 裏面画像の有無
    let backImageAvailable = false; (function(){ const t=new Image(); t.onload=()=>backImageAvailable=true; t.onerror=()=>backImageAvailable=false; t.src='code裏.png'; })();

    function sortAscending(a){ return [...a].sort((x,y)=>x-y); }

    function renderLists(players){
      participantsUl.innerHTML=''; spectatorsUl.innerHTML='';
      players.filter(p=>p.role==='player').forEach(p=>{
        const li=document.createElement('li'); li.className='pill';
        li.textContent=`${p.name}${p.isHost?'（ホスト）':''}${p.id===self.id?'（自分）':''}`; participantsUl.appendChild(li);
      });
      players.filter(p=>p.role==='spectator').forEach(p=>{
        const li=document.createElement('li'); li.className='pill'; li.textContent=`${p.name}${p.id===self.id?'（自分）':''}`; spectatorsUl.appendChild(li);
      });
    }

    function renderTable(players, roomState){
      tableArea.innerHTML='';
      const ps = players.filter(p=>p.role==='player');
      ps.forEach(p=>{
        const wrap=document.createElement('div'); wrap.className='player';
        const head=document.createElement('div'); head.className='player-h';
        const name=document.createElement('div'); name.className='name'; name.textContent=p.name+(p.id===self.id?'（自分）':'');
        const tags=document.createElement('div'); tags.className='tags'; if(p.isHost){ const t=document.createElement('span'); t.className='chip'; t.textContent='ホスト'; tags.appendChild(t);} head.appendChild(name); head.appendChild(tags); wrap.appendChild(head);

        const hand=document.createElement('div'); hand.className='hand';
        const reveals=new Set(p.publicReveals||[]);
        if(p.id===self.id){
          (p.hand||[]).forEach((n,idx)=>{ const c=document.createElement('div'); c.className='cardv revealed'; c.textContent=n; c.title=`#${idx+1}`; hand.appendChild(c); });
        } else {
          (p.hand||[]).forEach((n,idx)=>{
            const key=`${p.id}:${idx}`; const isRevealed=reveals.has(key);
            const c=document.createElement('div'); c.className='cardv '+(isRevealed?'revealed':'face-down');
            if(isRevealed){ c.textContent=n; }
            else {
              if(backImageAvailable){ const img=document.createElement('img'); img.alt='裏'; img.src='code裏.png'; c.appendChild(img);} else { c.textContent='裏'; }
              if(roomState.gameStarted){
                c.style.cursor='pointer'; c.title='クリックで公開';
                c.addEventListener('click', async ()=>{
                  // トグル公開
                  const roomRef = db.collection('rooms').doc(self.room);
                  const pRef = roomRef.collection('players').doc(p.id);
                  await db.runTransaction(async (tx)=>{
                    const snap = await tx.get(pRef); const data=snap.data()||{}; const arr=new Set(data.publicReveals||[]);
                    if(arr.has(key)) arr.delete(key); else arr.add(key);
                    tx.update(pRef,{ publicReveals:[...arr] });
                  });
                });
              }
            }
            hand.appendChild(c);
          });
        }
        wrap.appendChild(hand); tableArea.appendChild(wrap);
      });

      if(!ps.length){ const empty=document.createElement('div'); empty.className='card'; empty.innerHTML='<div class="card-h">テーブル</div><div class="card-c"><span class="muted">参加者がいません。参加者が揃うとここにカードが表示されます。</span></div>'; tableArea.appendChild(empty); }
    }

    function updateChrome(roomState, players){
      roomStatus.textContent = self.room ? `ルーム ${self.room}` : '未入室';
      roomLabel.textContent = self.room || '----';

      const me = players.find(p=>p.id===self.id) || self;
      const amHost = !!(roomState.hostId === self.id);
      const canStart = amHost && !roomState.gameStarted && players.some(p=>p.role==='player');
      startBtn.disabled = !canStart;
      hostFab.style.display = (amHost && roomState.gameStarted) ? 'block' : 'none';
      listsWrap.style.display = roomState.gameStarted ? 'none' : 'block';
      lobbyCard.style.display = self.room ? 'none' : 'block';
      tableArea.hidden = !self.room;
    }

    function buildDeck(){ const d=[]; for(let n=1;n<=12;n++){ d.push(n,n); } return d.sort(()=>Math.random()-0.5); }

    function isValidPlayerCount(count){
      // 24枚を余りなく配る: 24 % count === 0
      const divisors = [1,2,3,4,6,8,12,24];
      return divisors.includes(count);
    }

    async function startGame(roomRef){
      const playersSnap = await roomRef.collection('players').where('role','==','player').orderBy('joinedAt','asc').get();
      const players = playersSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      const pc = players.length;
      if(!pc){ alert('参加者が必要です'); return; }
      if(!isValidPlayerCount(pc)){ alert(`参加者の人数を 1,2,3,4,6,8,12,24 のいずれかにしてください（24枚を余りなく配るため）
現在: ${pc}人`); return; }

      const deck = buildDeck();
      const hands = {}; players.forEach(p=>hands[p.id]=[]);
      let i=0; while(deck.length){ hands[players[i%pc].id].push(deck.pop()); i++; }
      for(const p of players){ hands[p.id].sort((a,b)=>a-b); }

      const batch = db.batch();
      players.forEach(p=>{ batch.update(roomRef.collection('players').doc(p.id), { hand:hands[p.id], publicReveals:[] }); });
      batch.update(roomRef, { gameStarted:true });
      await batch.commit();
    }

    async function resetGame(roomRef){
      const playersSnap = await roomRef.collection('players').get();
      const batch = db.batch();
      // やり直し後は preferredRole==='player' の人を player に戻す
      playersSnap.forEach(doc=>{
        const data = doc.data() || {};
        const nextRole = (data.preferredRole === 'player') ? 'player' : data.role;
        batch.update(doc.ref, { hand:[], publicReveals:[], role: nextRole });
      });
      batch.update(roomRef, { gameStarted:false });
      await batch.commit();
    }

    function watchRoom(roomCode){
      const roomRef = db.collection('rooms').doc(roomCode);
      // 初期作成（存在しなければ）
      roomRef.get().then(s=>{ if(!s.exists){ roomRef.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp(), gameStarted:false, hostId:self.id }); } });

      if(unsubRoom) unsubRoom(); if(unsubPlayers) unsubPlayers();

      unsubRoom = roomRef.onSnapshot(snap=>{
        const data = snap.data() || { gameStarted:false, hostId:null };
        if(!data.hostId){ roomRef.update({ hostId: self.id }); }
        currentRoomState = data; rerender();
      });

      unsubPlayers = roomRef.collection('players').orderBy('joinedAt','asc').onSnapshot(snap=>{
        currentPlayers = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        rerender();
      });

      // UIイベント
      startBtn.onclick = ()=> startGame(roomRef);
      el('resetBtn').onclick = async ()=> { if(confirm('やり直しますか？')) await resetGame(roomRef); };
    }

    // 現在のスナップショットを保持
    let currentRoomState = { gameStarted:false, hostId:null };
    let currentPlayers = [];

    function rerender(){
      self.isHost = (currentRoomState.hostId === self.id);
      renderLists(currentPlayers);
      renderTable(currentPlayers, currentRoomState);
      updateChrome(currentRoomState, currentPlayers);
    }

    // 入室フロー（ルームコードのみ、名前は自動）
    const roleModal = el('roleModal');
    el('joinBtn').addEventListener('click', ()=>{
      const room=el('room').value.trim();
      if(!room){ alert('ルームコードを入力してください'); return; }
      self.name = randomName();
      self.room = room;
      roomStatus.textContent=`ルーム ${room}`; roomLabel.textContent=room; roleModal.showModal();
    });
    el('closeRole').addEventListener('click', ()=> roleModal.close());

    async function joinWithRole(role){
      const uid = auth.currentUser?.uid || Math.random().toString(36).slice(2,10);
      self.id = uid; self.role = role; self.preferredRole = role;
      const roomRef = db.collection('rooms').doc(self.room);
      watchRoom(self.room);
      const pRef = roomRef.collection('players').doc(uid);
      const roomSnap = await roomRef.get(); const gameStarted = roomSnap.exists ? !!roomSnap.data().gameStarted : false;
      const effectiveRole = (gameStarted && role==='player') ? 'spectator' : role;
      await pRef.set({ name:self.name, role:effectiveRole, preferredRole: role, isHost:false, hand:[], publicReveals:[], joinedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      // 最初の人をホストに
      const playersSnap = await roomRef.collection('players').get();
      if(playersSnap.size===1){ await roomRef.update({ hostId: uid }); await pRef.update({ isHost:true }); self.isHost=true; }
      else {
        const hostId = (await roomRef.get()).data().hostId; await pRef.update({ isHost: hostId===uid });
      }
      roleModal.close();
    }

    el('asPlayer').onclick = ()=> joinWithRole('player');
    el('asSpectator').onclick = ()=> joinWithRole('spectator');

    // 設定メニュー表示切替
    el('gearBtn').addEventListener('click', ()=>{ hostMenu.style.display = hostMenu.style.display==='block' ? 'none' : 'block'; });
    document.addEventListener('click', (e)=>{ if(!hostMenu.contains(e.target) && e.target !== el('gearBtn')) hostMenu.style.display='none'; });

    // 退室時のクリーンアップ（簡易）
    window.addEventListener('beforeunload', async ()=>{
      try{
        if(self.room && self.id){
          const roomRef = db.collection('rooms').doc(self.room);
          await roomRef.collection('players').doc(self.id).delete();
          const ps = await roomRef.collection('players').orderBy('joinedAt','asc').get();
          if(!ps.empty){ const newHost = ps.docs[0].id; await roomRef.update({ hostId: newHost }); }
          else { await roomRef.delete().catch(()=>{}); }
        }
      }catch(e){ /* noop */ }
    });
  </script>

  <!--
  ==========================
  Firestore ルール（デモ用）
  ==========================
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /rooms/{room} {
        allow read, write: if true; // デモ用。本番では認可を実装
        match /players/{player} { allow read, write: if true; }
      }
    }
  }
  -->
</body>
</html>
