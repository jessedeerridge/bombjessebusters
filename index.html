<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BOMB BUSTERS</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<style>
  
    :root { --bg:#ffffff; --ink:#111; --muted:#6b7280; --brand:#111827; --card:#f3f4f6; --accent:#e5e7eb; --shadow:0 6px 20px rgba(0,0,0,.08); --radius:16px; }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:var(--ink);background:var(--bg)}
    .app{min-height:100%;display:grid;grid-template-rows:auto 1fr}
    header{position:sticky;top:0;z-index:10;background:var(--bg);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;padding:12px 16px;gap:8px}
    .title{font-weight:800;letter-spacing:.02em;font-size:20px}
    .sub{color:var(--muted);font-size:12px}
    .right-tools{display:flex;align-items:center;gap:8px}
    .btn{appearance:none;border:0;background:var(--brand);color:#fff;padding:10px 14px;border-radius:999px;font-weight:700;font-size:14px;box-shadow:var(--shadow)}
    .btn[disabled]{opacity:.5}
    .btn-ghost{background:transparent;color:var(--brand);border:1px solid var(--accent)}
    .chip{font-size:12px;background:var(--accent);padding:4px 10px;border-radius:999px}
    .main{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;max-width:520px;margin:0 auto 80px}
    .lists-panel{position:relative;border:1px solid var(--accent);border-radius:var(--radius);background:#fff;overflow:clip;box-shadow:var(--shadow)}
    .lists-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#fafafa;border-bottom:1px solid var(--accent)}
    .lists{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px}
    .list{background:var(--card);border-radius:12px;padding:8px}
    .list h4{margin:0 0 6px;font-size:12px;color:var(--muted)}
    .list ul{list-style:none;margin:0;padding:0;display:grid;gap:6px}
    .pill{padding:6px 10px;background:#fff;border-radius:999px;border:1px solid var(--accent);font-size:13px}
    .card{background:#fff;border:1px solid var(--accent);border-radius:var(--radius);box-shadow:var(--shadow);overflow:clip}
    .card .card-h{padding:12px;background:#fafafa;border-bottom:1px solid var(--accent);font-weight:700}
    .card .card-c{padding:12px;display:grid;gap:10px}
    .row{display:grid;grid-template-columns:90px 1fr;align-items:center;gap:8px}
    .row input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--accent);font-size:14px}
    .table{display:grid;gap:12px}
    .players{display:grid;gap:12px}
    .player{border:1px solid var(--accent);border-radius:14px;overflow:clip;background:#fff}
    .player-h{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#fafafa;border-bottom:1px solid var(--accent)}
    .player-h .name{font-weight:700}
    .tags{display:flex;gap:6px;align-items:center}
    .hand{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(36px,1fr);gap:6px;padding:10px;overflow-x:auto}
    .cardv{aspect-ratio:3/4;border-radius:8px;display:grid;place-items:center;font-weight:800;font-size:16px;background:#fff;border:1px solid var(--accent);position:relative}
    .cardv.revealed{background:#fff}
    .cardv.face-down{background:#f9fafb}
    .cardv img{width:100%;height:100%;object-fit:cover;border-radius:8px}
    .muted{color:var(--muted)}
    .fab{position:fixed;right:16px;bottom:16px;z-index:30;display:none}
    .fab .gear{width:56px;height:56px;border-radius:999px;background:var(--brand);color:#fff;display:grid;place-items:center;box-shadow:var(--shadow);border:none}
    .menu{position:absolute;right:0;bottom:70px;background:#fff;border:1px solid var(--accent);border-radius:12px;box-shadow:var(--shadow);display:none;min-width:200px;overflow:hidden}
    .menu button{width:100%;display:block;padding:12px;text-align:left;border:none;background:#fff}
    .menu button:hover{background:#fafafa}
    dialog{border:1px solid var(--accent);border-radius:16px;padding:0;box-shadow:var(--shadow)}
    .modal-h{padding:12px;font-weight:700;border-bottom:1px solid var(--accent);background:#fafafa}
    .modal-c{padding:12px;display:grid;gap:8px}
    .modal-f{display:flex;justify-content:flex-end;gap:8px;padding:12px;border-top:1px solid var(--accent)}
    @media (min-width:480px){.main{grid-template-columns:1fr 210px;align-items:start}.lists-panel{position:sticky;top:72px}}
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="title">BOMB&nbsp;BUSTERS</div>
        <div class="sub">ã‚¹ãƒãƒ›å‘ã‘UIï¼‹FirestoreåŒæœŸï¼ˆæœ€å°å®Ÿè£…ï¼‰</div>
      </div>
      <div class="right-tools">
        <span id="roomStatus" class="chip">æœªå…¥å®¤</span>
        <button id="startBtn" class="btn" disabled>ã‚²ãƒ¼ãƒ é–‹å§‹</button>
      </div>
    </header>

    <main class="main">
      <section class="table">
        <div id="lobby" class="card">
          <div class="card-h">å…¥å®¤</div>
          <div class="card-c">
            <div class="row"><label for="name">åå‰</label><input id="name" maxlength="12" placeholder="ãŸã‚ã†" /></div>
            <div class="row"><label for="room">ãƒ«ãƒ¼ãƒ </label><input id="room" inputmode="numeric" pattern="[0-9]*" placeholder="4æ¡ã‚³ãƒ¼ãƒ‰" /></div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button id="joinBtn" class="btn">å…¥å®¤</button>
              <span class="muted" style="font-size:12px;">åŒã˜ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã§åŒå®¤ã¸ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰</span>
            </div>
          </div>
        </div>

        <div id="tableArea" class="players" hidden></div>
        <p class="muted" style="font-size:12px;margin:0 6px;">â€» è£å‘ãã‚«ãƒ¼ãƒ‰ç”»åƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œcodeè£.pngã€ã€‚ç„¡ã‘ã‚Œã°ã‚°ãƒ¬ãƒ¼è¡¨ç¤ºã€‚</p>
      </section>

      <aside id="listsWrap" class="lists-panel">
        <div class="lists-header"><div>ç¾åœ¨ã®éƒ¨å±‹</div><div class="chip" id="roomLabel">----</div></div>
        <div class="lists">
          <div class="list"><h4>å‚åŠ è€…</h4><ul id="participants"></ul></div>
          <div class="list"><h4>è¦³æˆ¦è€…</h4><ul id="spectators"></ul></div>
        </div>
      </aside>
    </main>

    <div class="fab" id="hostFab">
      <button class="gear" id="gearBtn" aria-label="è¨­å®š">âš™ï¸</button>
      <div class="menu" id="hostMenu"><button id="resetBtn">ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ</button></div>
    </div>
  </div>

  <dialog id="roleModal">
    <div class="modal-h">å½¹å‰²ã‚’é¸æŠ</div>
    <div class="modal-c">
      <button id="asPlayer" class="btn">å‚åŠ è€…ã¨ã—ã¦å…¥å®¤</button>
      <button id="asSpectator" class="btn btn-ghost">è¦³æˆ¦è€…ã¨ã—ã¦å…¥å®¤</button>
      <p class="muted" id="joinNote" style="font-size:12px;margin:6px 0 0;">ã‚²ãƒ¼ãƒ é–‹å§‹å¾Œã¯å‚åŠ ã§å…¥ã£ã¦ã‚‚è¦³æˆ¦ã«ãªã‚Šã¾ã™ã€‚</p>
    </div>
    <div class="modal-f"><button id="closeRole" class="btn btn-ghost">é–‰ã˜ã‚‹</button></div>
  </dialog>

  <script>
    // =======================
    // ğŸ”§ Firebase åˆæœŸåŒ–
    // =======================
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
    auth.signInAnonymously().catch(console.error);

    // =======================
    // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹
    // =======================
    const el = (id)=>document.getElementById(id);
    const participantsUl = el('participants');
    const spectatorsUl = el('spectators');
    const startBtn = el('startBtn');
    const roomStatus = el('roomStatus');
    const roomLabel = el('roomLabel');
    const tableArea = el('tableArea');
    const listsWrap = el('listsWrap');
    const lobbyCard = el('lobby');
    const hostFab = el('hostFab');
    const hostMenu = el('hostMenu');

    let self = { id:null, name:"", room:null, role:null, isHost:false };
    let unsubRoom = null, unsubPlayers = null;
    let backImageAvailable = false; (function(){ const t=new Image(); t.onload=()=>backImageAvailable=true; t.onerror=()=>backImageAvailable=false; t.src='codeè£.png'; })();

    function sortAscending(a){ return [...a].sort((x,y)=>x-y); }

    function renderLists(players){
      participantsUl.innerHTML=''; spectatorsUl.innerHTML='';
      players.filter(p=>p.role==='player').forEach(p=>{
        const li=document.createElement('li'); li.className='pill';
        li.textContent=`${p.name}${p.isHost?'ï¼ˆãƒ›ã‚¹ãƒˆï¼‰':''}${p.id===self.id?'ï¼ˆè‡ªåˆ†ï¼‰':''}`; participantsUl.appendChild(li);
      });
      players.filter(p=>p.role==='spectator').forEach(p=>{
        const li=document.createElement('li'); li.className='pill'; li.textContent=`${p.name}${p.id===self.id?'ï¼ˆè‡ªåˆ†ï¼‰':''}`; spectatorsUl.appendChild(li);
      });
    }

    function renderTable(players, state){
      tableArea.innerHTML='';
      const ps = players.filter(p=>p.role==='player');
      ps.forEach(p=>{
        const wrap=document.createElement('div'); wrap.className='player';
        const head=document.createElement('div'); head.className='player-h';
        const name=document.createElement('div'); name.className='name'; name.textContent=p.name+(p.id===self.id?'ï¼ˆè‡ªåˆ†ï¼‰':'');
        const tags=document.createElement('div'); tags.className='tags'; if(p.isHost){ const t=document.createElement('span'); t.className='chip'; t.textContent='ãƒ›ã‚¹ãƒˆ'; tags.appendChild(t);} head.appendChild(name); head.appendChild(tags); wrap.appendChild(head);

        const hand=document.createElement('div'); hand.className='hand';
        const reveals=new Set(p.publicReveals||[]);
        if(p.id===self.id){
          (p.hand||[]).forEach((n,idx)=>{ const c=document.createElement('div'); c.className='cardv revealed'; c.textContent=n; c.title=`#${idx+1}`; hand.appendChild(c); });
        } else {
          (p.hand||[]).forEach((n,idx)=>{
            const key=`${p.id}:${idx}`; const isRevealed=reveals.has(key);
            const c=document.createElement('div'); c.className='cardv '+(isRevealed?'revealed':'face-down');
            if(isRevealed){ c.textContent=n; }
            else {
              if(backImageAvailable){ const img=document.createElement('img'); img.alt='è£'; img.src='codeè£.png'; c.appendChild(img);} else { c.textContent='è£'; }
              if(state.gameStarted){
                c.style.cursor='pointer'; c.title='ã‚¯ãƒªãƒƒã‚¯ã§å…¬é–‹';
                c.addEventListener('click', async ()=>{
                  // å…¬é–‹ã¯èª°ãŒæŠ¼ã—ã¦ã‚‚å…¨ä½“ã«åæ˜ ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
                  const roomRef = db.collection('rooms').doc(self.room);
                  const pRef = roomRef.collection('players').doc(p.id);
                  await db.runTransaction(async (tx)=>{
                    const snap = await tx.get(pRef); const data=snap.data()||{}; const arr=new Set(data.publicReveals||[]); arr.add(key); tx.update(pRef,{ publicReveals:[...arr] });
                  });
                });
              }
            }
            hand.appendChild(c);
          });
        }
        wrap.appendChild(hand); tableArea.appendChild(wrap);
      });

      if(!ps.length){ const empty=document.createElement('div'); empty.className='card'; empty.innerHTML='<div class="card-h">ãƒ†ãƒ¼ãƒ–ãƒ«</div><div class="card-c"><span class="muted">å‚åŠ è€…ãŒã„ã¾ã›ã‚“ã€‚å‚åŠ è€…ãŒæƒã†ã¨ã“ã“ã«ã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</span></div>'; tableArea.appendChild(empty); }
    }

    function updateChrome(roomState, players){
      roomStatus.textContent = self.room ? `ãƒ«ãƒ¼ãƒ  ${self.room}` : 'æœªå…¥å®¤';
      roomLabel.textContent = self.room || '----';

      const me = players.find(p=>p.id===self.id) || self;
      const amHost = !!me.isHost; const canStart = amHost && !roomState.gameStarted && players.some(p=>p.role==='player');
      startBtn.disabled = !canStart;
      hostFab.style.display = (amHost && roomState.gameStarted) ? 'block' : 'none';
      listsWrap.style.display = roomState.gameStarted ? 'none' : 'block';
      lobbyCard.style.display = self.room ? 'none' : 'block';
      tableArea.hidden = !self.room;
    }

    function buildDeck(){ const d=[]; for(let n=1;n<=12;n++){ d.push(n,n); } return d.sort(()=>Math.random()-0.5); }

    async function startGame(roomRef){
      const playersSnap = await roomRef.collection('players').where('role','==','player').get();
      const players = playersSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      if(!players.length) { alert('å‚åŠ è€…ãŒå¿…è¦ã§ã™'); return; }
      const deck = buildDeck();
      const hands = {}; players.forEach(p=>hands[p.id]=[]);
      let i=0; while(deck.length){ hands[players[i%players.length].id].push(deck.pop()); i++; }
      for(const p of players){ hands[p.id].sort((a,b)=>a-b); }
      const batch = db.batch();
      players.forEach(p=>{ batch.update(roomRef.collection('players').doc(p.id), { hand:hands[p.id], publicReveals:[] }); });
      batch.update(roomRef, { gameStarted:true });
      await batch.commit();
    }

    async function resetGame(roomRef){
      const playersSnap = await roomRef.collection('players').get();
      const batch = db.batch();
      playersSnap.forEach(doc=> batch.update(doc.ref, { hand:[], publicReveals:[] }) );
      batch.update(roomRef, { gameStarted:false });
      await batch.commit();
    }

    function watchRoom(roomCode){
      const roomRef = db.collection('rooms').doc(roomCode);
      // ãƒ«ãƒ¼ãƒ ã®åˆæœŸä½œæˆï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°ï¼‰
      roomRef.get().then(s=>{ if(!s.exists){ roomRef.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp(), gameStarted:false, hostId:self.id }); } });

      if(unsubRoom) unsubRoom(); if(unsubPlayers) unsubPlayers();

      unsubRoom = roomRef.onSnapshot(snap=>{
        const data = snap.data() || { gameStarted:false, hostId:null };
        // ãƒ›ã‚¹ãƒˆã®å¼•ãç¶™ãï¼ˆæœ€åˆã®å‚åŠ è€…ãŒãƒ›ã‚¹ãƒˆï¼‰
        if(!data.hostId){ roomRef.update({ hostId: self.id }); }
        currentRoomState = data; rerender();
      });

      unsubPlayers = roomRef.collection('players').orderBy('joinedAt','asc').onSnapshot(snap=>{
        currentPlayers = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        rerender();
      });

      // UIã‚¤ãƒ™ãƒ³ãƒˆ
      startBtn.onclick = ()=> startGame(roomRef);
      el('resetBtn').onclick = async ()=> { if(confirm('ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) await resetGame(roomRef); };
    }

    // ç¾åœ¨ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿æŒ
    let currentRoomState = { gameStarted:false, hostId:null };
    let currentPlayers = [];

    function rerender(){
      // è‡ªåˆ†ã®ãƒ›ã‚¹ãƒˆåˆ¤å®š
      const me = currentPlayers.find(p=>p.id===self.id);
      self.isHost = !!(me && currentRoomState.hostId === self.id);

      renderLists(currentPlayers);
      renderTable(currentPlayers, currentRoomState);
      updateChrome(currentRoomState, currentPlayers);
    }

    // å…¥å®¤ãƒ•ãƒ­ãƒ¼
    const roleModal = el('roleModal');
    el('joinBtn').addEventListener('click', ()=>{
      const name=el('name').value.trim(); const room=el('room').value.trim();
      if(!name||!room){ alert('åå‰ã¨ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      self.name=name; self.room=room; roomStatus.textContent=`ãƒ«ãƒ¼ãƒ  ${room}`; roomLabel.textContent=room; roleModal.showModal();
    });
    el('closeRole').addEventListener('click', ()=> roleModal.close());

    async function joinWithRole(role){
      const uid = auth.currentUser?.uid || Math.random().toString(36).slice(2,10);
      self.id = uid; self.role = role;
      const roomRef = db.collection('rooms').doc(self.room);
      // ãƒ«ãƒ¼ãƒ ç›£è¦–é–‹å§‹
      watchRoom(self.room);
      // å‚åŠ ç™»éŒ²ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯UIDã§ä¸€æ„ã«ï¼‰
      const pRef = roomRef.collection('players').doc(uid);
      const roomSnap = await roomRef.get(); const gameStarted = roomSnap.exists ? !!roomSnap.data().gameStarted : false;
      const effectiveRole = (gameStarted && role==='player') ? 'spectator' : role;
      await pRef.set({ name:self.name, role:effectiveRole, isHost:false, hand:[], publicReveals:[], joinedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      // æœ€åˆã®äººã‚’ãƒ›ã‚¹ãƒˆã«
      const playersSnap = await roomRef.collection('players').get();
      if(playersSnap.size===1){ await roomRef.update({ hostId: uid }); await pRef.update({ isHost:true }); self.isHost=true; }
      else {
        // æ—¢å­˜ãƒ›ã‚¹ãƒˆã‚’åæ˜ 
        const hostId = (await roomRef.get()).data().hostId; await pRef.update({ isHost: hostId===uid });
      }
      roleModal.close();
    }

    el('asPlayer').onclick = ()=> joinWithRole('player');
    el('asSpectator').onclick = ()=> joinWithRole('spectator');

    // è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºåˆ‡æ›¿
    el('gearBtn').addEventListener('click', ()=>{ hostMenu.style.display = hostMenu.style.display==='block' ? 'none' : 'block'; });
    document.addEventListener('click', (e)=>{ if(!hostMenu.contains(e.target) && e.target !== el('gearBtn')) hostMenu.style.display='none'; });

    // é€€å®¤æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆç°¡æ˜“ï¼‰
    window.addEventListener('beforeunload', async ()=>{
      try{
        if(self.room && self.id){
          const roomRef = db.collection('rooms').doc(self.room);
          await roomRef.collection('players').doc(self.id).delete();
          // ãƒ›ã‚¹ãƒˆãŒã„ãªããªã£ãŸã‚‰æ¬¡ã®äººã«å¼•ãç¶™ã
          const ps = await roomRef.collection('players').orderBy('joinedAt','asc').get();
          if(!ps.empty){ await roomRef.update({ hostId: ps.docs[0].id }); }
          else { await roomRef.delete().catch(()=>{}); }
        }
      }catch(e){ /* noop */ }
    });
  </script>

  <!--
  ==========================
  Firestore ãƒ«ãƒ¼ãƒ«ï¼ˆç›®å®‰ï¼‰
  ==========================
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /rooms/{room} {
        allow read, write: if true; // ãƒ‡ãƒ¢ç”¨ï¼ˆæœ¬ç•ªã¯èªå¯ã‚’å®Ÿè£…ï¼‰
        match /players/{player} { allow read, write: if true; }
      }
    }
  }
  -->
</body>
</html>

<script>
/* ====== Firebaseè¨­å®šï¼ˆã‚ãªãŸã®å€¤ã«å·®ã—æ›¿ãˆã‚‹ï¼‰ ====== */
const firebaseConfig = {
  apiKey: "ã‚ãªãŸã®APIã‚­ãƒ¼",
  authDomain: "chat-68c4c.firebaseapp.com",
  projectId: "chat-68c4c",
  databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
  appId: "ã‚ãªãŸã®App ID"
};

/* ====== åˆæœŸåŒ– ====== */
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ====== JavaScriptæœ¬ä½“ï¼ˆå‰å›ã¨åŒã˜ï¼‰ ====== */
/* ã“ã“ã«ã‚­ãƒ£ãƒ³ãƒã‚¹ç‰ˆã®<script>å†…ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ */
</script>
</body>
</html>
