<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BOMB BUSTERS</title>
<style>
  :root{
    --gap:10px;
    --cardW:24px;   /* æ‰‹æœ­ã‚«ãƒ¼ãƒ‰ å¹… */
    --cardH:50px;   /* æ‰‹æœ­ã‚«ãƒ¼ãƒ‰ é«˜ã• */
    --cardGap:3px;  /* æ‰‹æœ­ã‚«ãƒ¼ãƒ‰é–“ */
    --labelW:48px;  /* å·¦ãƒ©ãƒ™ãƒ«åˆ—ï¼ˆæ•°å­—ï¼‹ä¸‹ç·šï¼‹ã‚­ãƒ£ãƒ©ã‚«ãƒ¼ãƒ‰ï¼‰ */
    --avatarW:40px; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ å¹… */
    --avatarH:60px; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ é«˜ã• */
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:#fff;color:#111}
  header{padding:16px;border-bottom:1px solid #eee;text-align:center;font-weight:800;letter-spacing:.04em}
  .container{display:flex;gap:var(--gap);padding:12px}
  .main{flex:1;min-width:0}
  .panel{border:1px solid #eee;border-radius:14px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff}
  .side{width:280px}
  .hidden{display:none !important}
  input[type="text"], input[type="number"]{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px}
  button{padding:10px 14px;border:1px solid #ddd;background:#fff;border-radius:12px;cursor:pointer}
  button.primary{background:#111;color:#fff;border-color:#111}
  button:disabled{opacity:.55;cursor:not-allowed}
  .row{display:flex;gap:10px;align-items:center}
  .row>*{flex:1}
  .muted{color:#666;font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #eee;padding:6px 10px;border-radius:999px;font-size:13px;background:#fafafa}
  .list{display:flex;flex-direction:column;gap:6px;max-height:40vh;overflow:auto}

  /* ====== ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¸­ï¼‰ ====== */
  .table{border:1px solid #eee;border-radius:12px;padding:8px;margin-bottom:10px}
  .tableRow{display:grid;grid-template-columns: var(--labelW) 1fr; gap:8px; align-items:stretch}
  .tableLabel{display:flex;flex-direction:column;align-items:center;gap:4px}
  .tableLabel .num{font-size:12px;font-weight:700;line-height:1}
  .tableLabel .underline{width:100%;border-top:2px solid #111;margin-top:2px}
  .avatar{width:var(--avatarW);height:var(--avatarH);border:1px solid #ccc;border-radius:6px;cursor:pointer;background:#fff center/cover no-repeat}

  /* ç€å¸­è€…åï¼ˆå°ï¼‰ */
  .occupant{font-size:11px;color:#444;margin-bottom:4px}

  /* æ‰‹æœ­ï¼šæ¨ªä¸€åˆ—15æšæƒ³å®šï¼ˆnowrapï¼‰ */
  .handWrap{overflow-x:auto;padding-bottom:6px}
  .hand{display:flex;gap:var(--cardGap);flex-wrap:nowrap}

  /* 1æšï¼ˆã‚«ãƒ¼ãƒ‰ï¼‹ä¸‹ã®æ–‡å­—ï¼‰ */
  .cardWrap{display:flex;flex-direction:column;align-items:center;position:relative}
  .swapMark{position:absolute;top:-10px;left:50%;transform:translateX(-50%);font-size:12px}

  .letterCell{width:var(--cardW);border:1px solid #eee;border-radius:4px;display:flex;flex-direction:column;align-items:center;gap:2px;padding:2px;margin-top:2px}
  .letterLabel{font-size:10px;line-height:1;cursor:pointer;user-select:none}
  .token{font-size:10px;font-weight:700}
  .eqMark{font-size:10px;font-weight:700;padding:2px 4px;border-radius:6px;background:#ffd9b3;border:1px solid #e2a56a;color:#000;cursor:pointer}
  .neqMark{font-size:10px;font-weight:700;padding:2px 4px;border-radius:6px;background:#cfefff;border:1px solid #74b6e3;color:#000;cursor:pointer}

  /* æµ®ã‹ã›ã‚‹å°ã‚¿ãƒ–ï¼ˆå…±é€šï¼‰ */
  .floatTab{position:absolute;font-size:11px;padding:6px 8px;border-radius:10px;border:1px solid #ccc;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.12);z-index:40}

  /* ====== æ‰‹æœ­ã‚«ãƒ¼ãƒ‰ ====== */
  .card{width:var(--cardW);height:var(--cardH);border-radius:6px;border:1px solid #000;overflow:hidden;user-select:none;position:relative}
  .cardInner{display:grid;grid-template-rows:16px 1fr;height:100%}
  .numTop{display:grid;place-items:center;font-weight:bold;font-size:16px} /* æŒ‡å®šã©ãŠã‚Š */
  .lowerArea{width:100%;height:100%}

  .isBack{
    background:
      url("codeback.png") center/cover no-repeat,
      repeating-linear-gradient(45deg,#f3f3f3,#f3f3f3 8px,#e5e5e5 8px,#e5e5e5 16px);
    border-color:#ccc;
  }
  .isBack .numTop{visibility:hidden}

  .isFacePrivate{background:#bbb;color:#fff;border-color:#bbb}
  .isFacePrivate .lowerArea{background:url("codenumber.png") center bottom/contain no-repeat}

  .isFacePublic{background:#000;color:#fff;border-color:#000;outline:2px solid #0a7}
  .isFacePublic .lowerArea{background:url("codenumber.png") center bottom/contain no-repeat}

  /* ====== ã‚¢ã‚¤ãƒ†ãƒ è¡Œ ====== */
  .itemsPanel{display:flex;flex-direction:column;gap:6px}
  .itemsRowWrap{display:flex;gap:10px;align-items:center}
  .itemsRow{display:flex;gap:6px;flex-wrap:nowrap;overflow-x:auto;flex:1}
  .itemImg{width:60px;height:40px;border:1px solid #ddd;border-radius:8px;background:#fff center/cover no-repeat;cursor:pointer;user-select:none}
  .itemUsed{background:#fff url("itemback.jpg") center/cover no-repeat !important;cursor:default}
  .diBox{display:flex;align-items:center;gap:6px;margin-left:auto}
  .diImg{width:90px;height:120px;border:1px solid #eee;border-radius:8px;cursor:pointer;background:#fff;object-fit:cover}

  @media (max-width:900px){.container{flex-direction:column}.side{width:auto}}
</style>
</head>
<body>
<header>BOMB BUSTERS</header>

<!-- Join -->
<section id="joinView" class="container">
  <div class="main panel" style="max-width:560px;margin:0 auto;">
    <div class="row">
      <input id="roomCodeInput" type="text" inputmode="numeric" maxlength="6" placeholder="ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: 1234ï¼‰">
      <button id="joinBtn" class="primary">å…¥å®¤</button>
    </div>
    <div class="muted" style="margin-top:8px;">å…¥å®¤å¾Œã«ã€Œå‚åŠ ã€ã‹ã€Œè¦³æˆ¦ã€ã‚’é¸ã¹ã¾ã™ã€‚åå‰ã¯è‡ªå‹•ä»˜ä¸ã€‚</div>
  </div>
</section>

<!-- Role select -->
<section id="roleView" class="container hidden">
  <div class="main panel" style="max-width:560px;margin:0 auto;">
    <div class="row" style="justify-content:center">
      <button id="asPlayer" class="primary">å‚åŠ </button>
      <button id="asSpectator">è¦³æˆ¦</button>
    </div>
    <div id="whoami" class="muted" style="margin-top:8px;"></div>
  </div>
</section>

<!-- Lobby/Game -->
<section id="gameView" class="container hidden">
  <div class="main">

    <div id="lobbyPanel" class="panel">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="muted">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰</div>
          <div class="section-title" style="font-weight:800">#<span id="roomCodeLabel"></span></div>
          <div class="muted">ã‚ãªãŸ: <span id="nameLabel"></span>ï¼ˆ<span id="roleLabel"></span>ï¼‰</div>
        </div>
        <div class="row" style="flex:none;gap:8px">
          <button id="startBtn" class="primary hidden">çˆ†å¼¾ã‚’è§£é™¤ï¼</button>
          <button id="leaveBtn">é€€å®¤</button>
        </div>
      </div>
    </div>

    <!-- Items -->
    <div id="itemsPanel" class="panel itemsPanel hidden">
      <div class="itemsRowWrap">
        <div id="itemsRow" class="itemsRow"></div>
        <div class="diBox">
          <img id="diImg" class="diImg" alt="">
        </div>
      </div>
    </div>

    <!-- Tables -->
    <div id="tablesPanel" class="panel" style="margin-top:12px;">
      <div id="tablesArea"></div>
    </div>

    <!-- Mission (no title text) -->
    <div id="missionPanel" class="panel hidden">
      <div id="missionLines"></div>
    </div>
  </div>

  <!-- Side: lists (hidden after start) -->
  <aside id="sidePanel" class="side panel">
    <div class="section-title">å‚åŠ è€…</div>
    <div id="playersList" class="list"></div>
    <div class="section-title" style="margin-top:12px;">è¦³æˆ¦è€…</div>
    <div id="spectatorsList" class="list"></div>
    <div class="muted" style="margin-top:12px;">â€» ã‚²ãƒ¼ãƒ é–‹å§‹å¾Œã€ã“ã®æ ã¯éè¡¨ç¤ºã«ãªã‚Šã¾ã™ã€‚</div>
  </aside>
</section>

<!-- Start Wizard -->
<div id="startModal" class="modal hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:50">
  <div class="sheet" style="background:#fff;border-radius:16px;max-width:520px;width:calc(100% - 32px);padding:16px;border:1px solid #eee">
    <div style="font-weight:800;">ãƒ—ãƒ¬ã‚¤äººæ•°ã‚’é¸æŠ</div>
    <div class="row" style="gap:8px;align-items:center;margin-top:8px">
      <input id="seatCountInput" type="number" min="2" max="12" value="4" />
      <button id="seatNext" class="primary" style="flex:none">æ¬¡ã¸</button>
    </div>
    <div id="missionStep" class="hidden" style="margin-top:12px;">
      <div style="font-weight:800;">ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠï¼ˆ1ã€œ10ï¼‰</div>
      <div id="missionChoices" style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:8px"></div>
      <div class="muted" style="margin-top:8px;">
        1ï¼š1.5/2.5/3.5/4.5ã®ã†ã¡1æšæ··å…¥ã€‚ / 2ï¼šå„å¸­1æšã‚’å³ç«¯å›ºå®šï¼ˆä»–ã¯æ˜‡é †ï¼‰ã€‚ / 3ï¼šå€™è£œ3ç¨®ã‚’æç¤ºâ†’ãƒ©ãƒ³ãƒ€ãƒ 1æšæ··å…¥ã€‚
      </div>
    </div>
  </div>
</div>

<!-- Seat selector -->
<div id="seatSelectModal" class="modal hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:50">
  <div class="sheet" style="background:#fff;border-radius:16px;max-width:520px;width:calc(100% - 32px);padding:16px;border:1px solid #eee">
    <div style="font-weight:800;">åº§ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠ</div>
    <div id="seatList" class="list" style="margin-top:8px;"></div>
    <div class="row" style="gap:8px;align-items:center;margin-top:8px">
      <button id="leaveSeatBtn">å¸­ã‚’ç«‹ã¤</button>
      <div class="muted">â€» é€€å‡ºã™ã‚‹ã¨å¸­ã¯ç©ºãã¾ã™ï¼ˆã‚«ãƒ¼ãƒ‰ã¯æ®‹ã‚‹ï¼‰ã€‚</div>
    </div>
  </div>
</div>

<!-- Reset confirm -->
<div id="resetConfirm" class="modal hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:50">
  <div class="sheet" style="background:#fff;border-radius:16px;max-width:520px;width:calc(100% - 32px);padding:16px;border:1px solid #eee">
    <div style="font-weight:800;">ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ</div>
    <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
      <button id="confirmResetBtn" style="font-size:11px;padding:6px 10px">ã‚„ã‚Šç›´ã™</button>
      <button id="cancelResetBtn" style="font-size:16px;padding:12px 16px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- Floating controls -->
<div id="controls" class="hidden" style="position:fixed;right:12px;bottom:12px;display:flex;gap:8px;z-index:60">
  <div id="menu" style="position:relative">
    <button id="settingsBtn">âš™ è¨­å®š</button>
    <div id="menuPopup" style="position:absolute;right:0;bottom:44px;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:8px;display:none;min-width:180px">
      <button id="chooseSeatBtn">å¸­ã«åº§ã‚‹</button>
      <button id="leaveSeatMenuBtn" class="hidden">å¸­ã‚’ç«‹ã¤</button>
      <button id="resetBtn" class="hidden">ã‚„ã‚Šç›´ã™</button>
    </div>
  </div>
</div>

<!-- Firebase + App -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getDatabase, ref, get, set, update, onValue, push,
    serverTimestamp, onDisconnect, remove, runTransaction
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  /* ==== Firebase config ==== */
  const firebaseConfig = {
    apiKey: "AIzaSyBpSx_lEcg1j9ExMJsVl5lBqAxOCfmFmSnI",
    authDomain: "chat-68c4c.firebaseapp.com",
    databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
    projectId: "chat-68c4c",
    storageBucket: "chat-68c4c.appspot.com",
    messagingSenderId: "172284325975",
    appId: "1:172284325975:web:6f9bdd77e822c0ea39dd92"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // DOM
  const $ = s=>document.querySelector(s);
  const joinView=$("#joinView"), roleView=$("#roleView"), gameView=$("#gameView");
  const roomCodeInput=$("#roomCodeInput"), joinBtn=$("#joinBtn");
  const asPlayerBtn=$("#asPlayer"), asSpectatorBtn=$("#asSpectator"), whoami=$("#whoami");
  const startBtn=$("#startBtn"), leaveBtn=$("#leaveBtn");
  const roomCodeLabel=$("#roomCodeLabel"), nameLabel=$("#nameLabel"), roleLabel=$("#roleLabel");
  const playersList=$("#playersList"), spectatorsList=$("#spectatorsList"), sidePanel=$("#sidePanel");
  const itemsPanel=$("#itemsPanel"), itemsRow=$("#itemsRow"), diImg=$("#diImg");
  const tablesArea=$("#tablesArea");
  const controls=$("#controls"), menu=$("#menu"), settingsBtn=$("#settingsBtn"), menuPopup=$("#menuPopup");
  const chooseSeatBtn=$("#chooseSeatBtn"), leaveSeatMenuBtn=$("#leaveSeatMenuBtn"), resetBtn=$("#resetBtn");
  const startModal=$("#startModal"), seatCountInput=$("#seatCountInput"), seatNext=$("#seatNext"), missionStep=$("#missionStep"), missionChoices=$("#missionChoices");
  const seatSelectModal=$("#seatSelectModal"), seatList=$("#seatList"), leaveSeatBtn=$("#leaveSeatBtn");
  const resetConfirm=$("#resetConfirm"), confirmResetBtn=$("#confirmResetBtn"), cancelResetBtn=$("#cancelResetBtn");
  const missionPanel=$("#missionPanel"), missionLines=$("#missionLines");

  // State
  let state = {
    roomCode:null, userId:null, name:null, role:null, isHost:false,
    phase:"lobby", mission:null, seatCount:0, mySeat:null
  };
  let currentRoom = null;

  // helpers
  const cleanCode = s => (s||"").replace(/\D/g,"").slice(0,6);
  const setView = v=>{
    joinView.classList.toggle("hidden", v!=="join");
    roleView.classList.toggle("hidden", v!=="role");
    gameView.classList.toggle("hidden", v!=="game");
  };
  const randName = ()=>{
    const A=["èµ¤","é’","é»„","ç·‘","æ¡ƒ","é»’","ç™½","é‡‘","éŠ€","èŒ¶"],B=["ã­ã“","ã„ã¬","ã†ã•ã","ãŸã¬ã","ãã¤ã­","ãã¾","ã¨ã‚Š","ã•ã‹ãª","ãƒ‰ãƒ©ã‚´ãƒ³","ãƒšãƒ³ã‚®ãƒ³"],n=Math.floor(Math.random()*900)+100;
    return A[Math.floor(Math.random()*A.length)]+B[Math.floor(Math.random()*B.length)]+n;
  };
  const cardVal = txt => parseFloat(txt);
  const indexToLetter = i => String.fromCharCode(97 + i);

  // ã‚¢ã‚¤ãƒ†ãƒ ç”»åƒãƒãƒƒãƒ—ï¼ˆæŒ‡å®šãŒã‚ã‚‹ã‚‚ã®ã¯å›ºå®šã€‚æœªæŒ‡å®šã¯ "item (n).jpg" ã‚’æ¨æ¸¬ï¼‰
  const ITEM_IMG = {
    1:"item (13).jpg",
    2:"item (12).jpg",
    3:"item (1).jpg",
    4:"item (3).jpg",
    5:"item (6).jpg",
    6:"item (17).jpg",
    7:"item (16).jpg",
    8:"item (5).jpg",
    9:"item (7).jpg",
    10:"item (10).jpg",
    11:"item (8).jpg",
    12:"item (13).jpg"
    // 13ã€œ18 ã¯å¿…è¦ã«ãªã£ãŸã‚‰ "item (n).jpg" ã‚’è‡ªå‹•ä½¿ç”¨
  };
  const itemImgPath = (n)=> ITEM_IMG[n] || `item (${n}).jpg`;

  /* ===== Join flow ===== */
  joinBtn.addEventListener("click", async ()=>{
    const code=cleanCode(roomCodeInput.value);
    if(!code) return alert("ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    state.roomCode=code; state.userId=state.userId || push(ref(db,"clients")).key; state.name=state.name||randName();
    whoami.textContent=`æš«å®šå: ${state.name}`;
    setView("role");
    const url=new URL(location.href); url.searchParams.set("room",code); history.replaceState(null,"",url.toString());
  });

  asPlayerBtn.addEventListener("click", ()=>enterAs("player"));
  asSpectatorBtn.addEventListener("click", ()=>enterAs("spectator"));

  async function enterAs(role){
    state.role=role;
    roomCodeLabel.textContent=state.roomCode; nameLabel.textContent=state.name; roleLabel.textContent=(role==="player"?"å‚åŠ è€…":"è¦³æˆ¦è€…");
    const roomRef=await ensureRoom(state.roomCode);
    const snap=await get(roomRef); const v=snap.val()||{};
    if(role==="player" && !v.hostId) await update(roomRef,{ hostId:state.userId });

    const actual = (v.phase==="playing") ? "spectator" : role;
    state.role=actual; roleLabel.textContent=(actual==="player"?"å‚åŠ è€…":"è¦³æˆ¦è€…");

    const basePath = actual==="player" ? `rooms/${state.roomCode}/players/${state.userId}` : `rooms/${state.roomCode}/spectators/${state.userId}`;
    const meRef = ref(db, basePath);
    await set(meRef,{ name:state.name, joinedAt:serverTimestamp() });
    onDisconnect(meRef).remove();

    await set(ref(db, `rooms/${state.roomCode}/wants/${state.userId}`), { wantsPlayer: role==="player", name: state.name });
    onDisconnect(ref(db, `rooms/${state.roomCode}/wants/${state.userId}`)).remove();

    setupRealtime(state.roomCode);
    setView("game");
  }

  async function ensureRoom(code){
    const r = ref(db, `rooms/${code}`);
    const s = await get(r);
    if(!s.exists()){
      await set(r,{
        createdAt:serverTimestamp(), hostId:null, phase:"lobby", mission:null, seatCount:0,
        players:{}, spectators:{}, wants:{}, seats:{}, missionTextLines:[], items:{}, effects:{}, diIndex:0
      });
    }
    return r;
  }

  function setupRealtime(code){
    const roomRef = ref(db, `rooms/${code}`);
    onValue(roomRef,(snap)=>{
      const v=snap.val()||{};
      currentRoom = v;
      state.phase=v.phase||"lobby"; state.mission=v.mission||null; state.isHost=(v.hostId===state.userId);
      state.seatCount=v.seatCount||0;

      startBtn.classList.toggle("hidden", !(state.isHost && state.phase==="lobby" && state.role==="player"));
      sidePanel.classList.toggle("hidden", state.phase!=="lobby");
      controls.classList.toggle("hidden", state.phase!=="playing");
      resetBtn.classList.toggle("hidden", !state.isHost);
      chooseSeatBtn.disabled = (state.role!=="player");

      // è‡ªå¸­æ¤œå‡º
      const seats = v.seats||{};
      state.mySeat = null;
      Object.keys(seats).forEach(k=>{ if(seats[k].occupantUser===state.userId) state.mySeat=String(k); });
      leaveSeatMenuBtn.classList.toggle("hidden", !state.mySeat);

      renderList(playersList, v.players||{});
      renderList(spectatorsList, v.spectators||{});
      renderItems(v);
      renderTables(v);
      renderMissionDetails(v);
    });

    onValue(ref(db,`rooms/${code}/players`),(s)=>renderList(playersList,s.val()||{}));
    onValue(ref(db,`rooms/${code}/spectators`),(s)=>renderList(spectatorsList,s.val()||{}));
  }

  function renderList(container,map){
    container.innerHTML="";
    const ids=Object.keys(map);
    if(!ids.length){ container.appendChild(div("div","muted","ï¼ˆãªã—ï¼‰")); return; }
    ids.forEach(id=>{
      const d=div("div","pill"); d.textContent=map[id].name||"???"; container.appendChild(d);
    });
  }
  function div(tag,cls,text){ const el=document.createElement(tag); if(cls) el.className=cls; if(text!=null) el.textContent=text; return el; }

  /* ===== Startï¼ˆäººæ•°â†’ãƒŸãƒƒã‚·ãƒ§ãƒ³â†’é…å¸ƒï¼‰ ===== */
  seatNext.addEventListener("click", ()=>{
    missionChoices.innerHTML="";
    for(let i=1;i<=10;i++){
      const b=div("button","",String(i));
      b.style.padding="10px"; b.style.border="1px solid #ddd"; b.style.borderRadius="10px"; b.style.background="#fff";
      b.onclick=()=>startGame(Math.max(2, Math.min(12, parseInt(seatCountInput.value,10)||4)), i);
      missionChoices.appendChild(b);
    }
    missionStep.classList.remove("hidden");
  });
  startBtn.addEventListener("click", ()=>{
    if(!(state.isHost && state.phase==="lobby")) return;
    missionChoices.innerHTML="";
    for(let i=1;i<=10;i++){
      const b=div("button","",String(i));
      b.style.padding="10px"; b.style.border="1px solid #ddd"; b.style.borderRadius="10px"; b.style.background="#fff";
      b.onclick=()=>startGame(Math.max(2, Math.min(12, parseInt(seatCountInput.value,10)||4)), i);
      missionChoices.appendChild(b);
    }
    missionStep.classList.remove("hidden");
    startModal.classList.remove("hidden");
  });

  function pickN(arr, n){
    const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a.slice(0,n);
  }

  async function startGame(seatCount, mission){
    startModal.classList.add("hidden");
    const code=state.roomCode;

    // ãƒ‡ãƒƒã‚­ï¼š1..12 Ã— 4 = 48
    let deck=[]; let cid=0;
    for(let v=1;v<=12;v++){ for(let r=0;r<4;r++) deck.push({id:`c${cid++}`,text:String(v)}); }

    const halves = ["1.5","2.5","3.5","4.5"];
    let missionTextLines = [];

    if(mission===1){
      const x = halves[Math.floor(Math.random()*halves.length)];
      deck.push({ id:`c${cid++}`, text:x, special:true });
      missionTextLines = ["<b>#1 çˆ†å¼¾</b>", `${x}ãŒ1ã¤`];
    }
    if(mission===3){
      const picks = pickN(halves,3);
      const use = picks[Math.floor(Math.random()*picks.length)];
      deck.push({ id:`c${cid++}`, text:use, special:true });
      missionTextLines = ["<b>#3 ã•ã‚‰ã„çˆ†å¼¾</b>", `${picks[0]} â€“ ${picks[1]} - ${picks[2]}ã®ã†ã¡1ã¤`];
    }

    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }

    // å¸­ã‚’ä½œæˆã—ã€ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ã§ä½™ã‚Šãªãé…å¸ƒ
    const seats={};
    for(let s=1;s<=seatCount;s++){ seats[s]={ hand:{}, tokens:{}, occupantUser:null, occupantName:null, avatarName:null, avatarFace:true }; }
    let k=0, sidx=1;
    while(k<deck.length){
      const c=deck[k++]; seats[sidx].hand[c.id]={...c, revealed:false};
      sidx++; if(sidx>seatCount) sidx=1;
    }

    // ä¸¦ã³é †ï¼ˆæ˜‡é †ï¼‰ï¼M2ï¼šãƒ©ãƒ³ãƒ€ãƒ 1æšã‚’å³ç«¯å›ºå®š
    for(let s=1;s<=seatCount;s++){
      let arr = Object.keys(seats[s].hand).map(id=>({id, ...seats[s].hand[id]}));
      if(mission===2 && arr.length){
        const pick = arr[Math.floor(Math.random()*arr.length)];
        const rest = arr.filter(x=>x.id!==pick.id).sort((a,b)=>cardVal(a.text)-cardVal(b.text));
        arr = [...rest, {...pick, pinRight:true}];
      }else{
        arr.sort((a,b)=>cardVal(a.text)-cardVal(b.text));
      }
      arr.forEach((c,i)=>{ seats[s].hand[c.id]={...c, order:i}; });
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ï¼šå¿…ãš member(5).png ã‚’ã©ã“ã‹ã«å‰²å½“ï¼ˆç„¡ã„å ´åˆã«å‚™ãˆjpgåã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    const memList = ["member (1).jpg","member (2).jpg","member (3).jpg","member (4).jpg","member (5).jpg"];
    const mustIdx = Math.floor(Math.random()*seatCount)+1;
    seats[mustIdx].avatarName = "member(5).png"; // ç¬¬ä¸€å€™è£œ
    for(let s=1;s<=seatCount;s++){
      if(!seats[s].avatarName){
        seats[s].avatarName = memList[Math.floor(Math.random()*memList.length)];
      }
      seats[s].avatarFace = true;
    }

    // ã‚¢ã‚¤ãƒ†ãƒ ï¼šäººæ•°ã¶ã‚“ã€1..18ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆâ€» ãƒŸãƒƒã‚·ãƒ§ãƒ³42ã¾ã§ã¯14ã€œ18ã‚’é…ã‚‰ãªã„ â†’ ç¾çŠ¶1..10ãªã®ã§ 1..13ã®ã¿ï¼‰
    const pool = (mission<=42) ? [1,2,3,4,5,6,7,8,9,10,11,12,13] : [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18];
    const itemNums = pickN(pool, Math.min(seatCount, pool.length));
    const items = {}; itemNums.forEach(n=>{ items[n]={ used:false }; });

    // di ç”»åƒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼šé–‹å§‹æ™‚ã¯ seatCountï¼ˆ0ã€œ6ã«ã‚¯ãƒ©ãƒ³ãƒ—ï¼‰
    const diIndex = Math.max(0, Math.min(6, seatCount));

    await update(ref(db,`rooms/${code}`),{
      phase:"playing",
      mission,
      seatCount,
      seats,
      missionTextLines,
      items,
      effects:{}, // item1: { placed:{} } / item2: {...} / item12:{ placedNE:{} }
      diIndex
    });
  }

  /* ===== è¨­å®š ï¼ åº§å¸­é¸æŠãƒ»é›¢å¸­ãƒ»ã‚„ã‚Šç›´ã™ ===== */
  settingsBtn.addEventListener("click", ()=>menuPopup.style.display = (menuPopup.style.display==="block"?"none":"block"));
  document.addEventListener("click",(e)=>{ if(!menu.contains(e.target)) menuPopup.style.display="none"; });

  document.getElementById("chooseSeatBtn").addEventListener("click", ()=>{
    const code=state.roomCode;
    seatList.innerHTML="";
    onValue(ref(db,`rooms/${code}/seats`),(snap)=>{
      const seats=snap.val()||{};
      seatList.innerHTML="";
      Object.keys(seats).forEach(idx=>{
        const occUser = seats[idx].occupantUser;
        const occName = seats[idx].occupantName;
        const btn = document.createElement("button");
        btn.textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«${idx}ï¼š` + (occUser ? `${occName} ãŒç€å¸­ä¸­` : "ç©ºå¸­");
        const occupied = !!occUser && occUser!==state.userId;
        btn.disabled = occupied || (state.role!=="player");
        btn.style.padding="8px"; btn.style.border="1px solid #ddd"; btn.style.borderRadius="10px"; btn.style.background="#fff"; btn.style.textAlign="left";
        btn.onclick=()=>claimSeat(idx);
        seatList.appendChild(btn);
      });
    }, { onlyOnce:true });
    seatSelectModal.classList.remove("hidden");
    menuPopup.style.display="none";
  });

  async function claimSeat(idx){
    const code=state.roomCode;
    const seatUserRef = ref(db,`rooms/${code}/seats/${idx}/occupantUser`);
    const res = await runTransaction(seatUserRef,(cur)=> cur || state.userId);
    if(!res.committed || res.snapshot.val()!==state.userId){
      alert("ãã®å¸­ã«ã¯åº§ã‚Œã¾ã›ã‚“ï¼ˆæ—¢ã«åŸ‹ã¾ã£ã¦ã„ã¾ã™ï¼‰ã€‚");
      return;
    }
    await update(ref(db,`rooms/${code}/seats/${idx}`),{ occupantName: state.name, avatarFace:true });
    state.mySeat = String(idx);
    onDisconnect(ref(db,`rooms/${code}/seats/${idx}/occupantUser`)).remove();
    onDisconnect(ref(db,`rooms/${code}/seats/${idx}/occupantName`)).remove();
    seatSelectModal.classList.add("hidden");
  }

  async function leaveSeat(){
    if(!state.mySeat) return;
    const code=state.roomCode;
    await update(ref(db,`rooms/${code}/seats/${state.mySeat}`),{ occupantUser: null, occupantName: null });
    state.mySeat=null;
  }
  document.getElementById("leaveSeatMenuBtn").addEventListener("click", leaveSeat);
  leaveSeatBtn.addEventListener("click", ()=>{ leaveSeat(); seatSelectModal.classList.add("hidden"); });

  // ã‚„ã‚Šç›´ã™ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰
  resetBtn.addEventListener("click", ()=>{
    if(!state.isHost) return;
    resetConfirm.classList.remove("hidden");
    menuPopup.style.display="none";
  });
  cancelResetBtn.addEventListener("click", ()=>resetConfirm.classList.add("hidden"));
  confirmResetBtn.addEventListener("click", async ()=>{
    if(!state.isHost) return;
    const code=state.roomCode;

    const [pS, sS, wS] = await Promise.all([
      get(ref(db,`rooms/${code}/players`)),
      get(ref(db,`rooms/${code}/spectators`)),
      get(ref(db,`rooms/${code}/wants`))
    ]);
    const curP = pS.val()||{}, curS=sS.val()||{}, wants=wS.val()||{};
    const present = { ...curP, ...curS };

    const nextPlayers = {}, nextSpectators = {};
    Object.keys(present).forEach(uid=>{
      if(wants[uid]?.wantsPlayer){ nextPlayers[uid] = { name: present[uid]?.name || wants[uid]?.name || "???" }; }
      else{ nextSpectators[uid] = { name: present[uid]?.name || wants[uid]?.name || "???" }; }
    });

    await update(ref(db,`rooms/${code}`),{
      phase:"lobby", mission:null, seatCount:0, seats:{},
      players: nextPlayers, spectators: nextSpectators,
      missionTextLines:[], items:{}, effects:{}, diIndex:0
    });
    resetConfirm.classList.add("hidden");
  });

  /* ===== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ===== */
  function canOperateOnSeat(seatIdx){
    return state.role==="player" && state.mySeat && String(seatIdx)===String(state.mySeat);
  }

  function anyPairRevealed(counts){
    return Object.values(counts).some(v=>v>=2);
  }

  function renderItems(roomVal){
    const items = roomVal.items || {};
    const seats = roomVal.seats || {};
    const counts = revealedCounts(seats);
    itemsRow.innerHTML="";

    const nums = Object.keys(items).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
    const showDi = typeof roomVal.diIndex==="number";

    if(!nums.length && !showDi){ itemsPanel.classList.add("hidden"); return; }

    // ã‚¢ã‚¤ãƒ†ãƒ ç”»åƒã‚«ãƒ¼ãƒ‰ï¼ˆä½¿ç”¨å¾Œã¯ itemback.jpgï¼‰
    nums.forEach(num=>{
      const it = items[num];
      const card = div("div","itemImg"+(it.used?" itemUsed":""), "");
      const imgPath = itemImgPath(num);
      if(!it.used){ card.style.backgroundImage = `url("${imgPath}")`; }
      if(!it.used && state.role==="player" && anyPairRevealed(counts)){
        card.onclick = (ev)=> showTab(ev.currentTarget, [{label:"ä½¿ç”¨ã™ã‚‹", onClick:()=>useItem(num)}]);
      }else{
        card.style.cursor = "default";
      }
      itemsRow.appendChild(card);
    });

    // di ç”»åƒï¼ˆã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ç­‰ã¯å‡ºã•ãªã„ï¼‰
    if(showDi){
      const idx = clamp(roomVal.diIndex ?? 0, 0, 6);
      diImg.src = `di${idx}.png`;
      diImg.onclick = (ev)=> showTab(ev.currentTarget, [
        {label:"é€²ã‚ã‚‹", onClick:()=>setDi(idx-1)},
        {label:"æˆ»ã™", onClick:()=>setDi(idx+1)},
      ]);
    }

    itemsPanel.classList.remove("hidden");
  }

  function clamp(x,min,max){ return Math.max(min, Math.min(max, x)); }
  async function setDi(next){
    const code=state.roomCode;
    await update(ref(db,`rooms/${code}`),{ diIndex: clamp(next,0,6) });
  }

  function revealedCounts(seats){
    const cnt={};
    Object.keys(seats).forEach(si=>{
      const hand = seats[si].hand||{};
      Object.values(hand).forEach(c=>{
        if(c.revealed){
          const k=String(parseInt(cardVal(c.text)));
          cnt[k]=(cnt[k]||0)+1;
        }
      });
    });
    return cnt;
  }

  async function useItem(num){
    const code=state.roomCode;
    if(num===1){
      await update(ref(db,`rooms/${code}`),{
        [`items/1/used`]: true,
        [`effects/item1/placed`]: {} // { "<seatIdx>_<cardId>": true }
      });
      alert("ã‚¢ã‚¤ãƒ†ãƒ 1ã‚’ä½¿ç”¨ï¼šã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‹ã‚‰ã€Œ=ã€ã¾ãŸã¯æ•°å­—ã‚’é¸ã¹ã¾ã™ï¼ˆ=ã¯æœ€å¤§2ã¤ï¼‰ã€‚");
    }else if(num===2){
      await update(ref(db,`rooms/${code}`),{
        [`items/2/used`]: true,
        [`effects/item2`]: { activeBy: state.userId, step:"pickSelf" }
      });
      alert("è‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¸€æšé¸ã‚“ã§ãã ã•ã„ã€‚");
    }else if(num===12){
      await update(ref(db,`rooms/${code}`),{
        [`items/12/used`]: true,
        [`effects/item12/placedNE`]: {} // { "<seatIdx>_<cardId>": true }
      });
      alert("ã‚¢ã‚¤ãƒ†ãƒ 12ã‚’ä½¿ç”¨ï¼šã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‹ã‚‰ã€Œâ‰ ã€ã¾ãŸã¯æ•°å­—ã‚’é¸ã¹ã¾ã™ï¼ˆâ‰ ã¯æœ€å¤§2ã¤ï¼‰ã€‚");
    }else{
      await update(ref(db,`rooms/${code}`),{ [`items/${num}/used`]: true });
    }
  }

  function renderTables(roomVal){
    tablesArea.innerHTML="";
    const seats = roomVal.seats||{};
    const seatKeys = Object.keys(seats);
    if(!seatKeys.length){
      tablesArea.appendChild(div("div","muted","ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰"));
      return;
    }

    const item2 = roomVal.effects?.item2 || null;
    const highlights = item2?.highlights || {};

    seatKeys.forEach(idx=>{
      const seat = seats[idx];

      const table = div("div","table");
      const row = div("div","tableRow");

      // å·¦ï¼šæ•°å­—ï¼‹ä¸‹ç·šï¼‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ï¼ˆç€å¸­æ™‚ã®ã¿ï¼èª°ã§ã‚‚ãƒˆã‚°ãƒ«ï¼‰
      const label = div("div","tableLabel");
      label.appendChild(div("div","num", String(idx)));
      label.appendChild(div("div","underline",""));
      if(seat.occupantUser && seat.avatarName){
        const sc = document.createElement("div");
        sc.className = "avatar";
        // ç”»åƒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆpng/jpgãƒ»ã‚¹ãƒšãƒ¼ã‚¹æœ‰ç„¡ï¼‰
        const faceUrl = `url("member (5).jpg")`;
        const faceOther = `url("${seat.avatarName}"), url("${seat.avatarName.replace(" (","(")}")`;
        sc.style.backgroundImage = (seat.avatarName==="member (5).png") ? faceUrl : faceOther;
        const backUrl = `url("battery.jpg")`;
        if(!seat.avatarFace) sc.style.backgroundImage = backUrl;
        sc.title = "ã‚¯ãƒªãƒƒã‚¯ã§è¡¨è£ã‚’åˆ‡æ›¿";
        sc.onclick = ()=>toggleAvatar(idx, !!seat.avatarFace);
        label.appendChild(sc);
      }
      row.appendChild(label);

      // å³ï¼šç€å¸­è€…åï¼ˆå°ï¼‰ï¼‹æ‰‹æœ­
      const content = div("div","");
      const occ = div("div","occupant", seat.occupantName ? `ğŸ‘¤ ${seat.occupantName}` : "");
      content.appendChild(occ);

      const handWrap=div("div","handWrap");
      const handEl=div("div","hand");

      let arr = Object.keys(seat.hand||{}).map(id=>({id, ...seat.hand[id]}));
      arr.sort((a,b)=>(a.order??0)-(b.order??0));

      const isMineSeat = canOperateOnSeat(idx);

      arr.forEach((c,i)=>{
        const wrap = div("div","cardWrap");
        const card = div("div","card");
        const inner = div("div","cardInner");
        const top = div("div","numTop","");
        const lower = div("div","lowerArea");

        const revealed = !!c.revealed;

        if(revealed){
          card.classList.add("isFacePublic");
          top.textContent = c.text;
        }else if(isMineSeat){
          card.classList.add("isFacePrivate");
          top.textContent = c.text;
        }else{
          card.classList.add("isBack");
        }

        inner.appendChild(top);
        inner.appendChild(lower);
        card.appendChild(inner);

        // â–¼ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆäº¤æ›ã§å·®ã—å…¥ã‚ŒãŸä½ç½®ã‚’5ç§’è¡¨ç¤ºï¼‰
        const hKey = `${idx}_${c.id}`;
        const until = highlights?.[hKey]?.until || 0;
        if(Date.now() < until){
          const mark = div("div","swapMark","â–¼");
          wrap.appendChild(mark);
        }

        // ã‚¯ãƒªãƒƒã‚¯å‹•ä½œ
        card.style.cursor = isMineSeat ? "pointer" : "default";
        card.onclick = ()=>{
          // ã‚¢ã‚¤ãƒ†ãƒ 2ï¼šé¸æŠãƒ•ã‚§ãƒ¼ã‚º
          const eff2=currentRoom?.effects?.item2||null;
          if(eff2 && eff2.activeBy===state.userId){
            if(eff2.step==="pickSelf" && isMineSeat){ selectItem2Self(idx,c.id); return; }
            if(eff2.step==="pickOther" && (!isMineSeat)){ selectItem2Other(idx,c.id); return; }
          }
          // é€šå¸¸ï¼šè‡ªå¸­ã®ã¿ å…¬é–‹/éå…¬é–‹ãƒˆã‚°ãƒ«
          if(isMineSeat) toggleReveal(idx,c.id);
        };

        // a,b,c...ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆè‡ªä½“ã‚¯ãƒªãƒƒã‚¯ï¼‰
        const letter = indexToLetter(i);
        const letterCell = makeLetterCell(idx,c,letter,isMineSeat);
        wrap.appendChild(card);
        wrap.appendChild(letterCell);
        handEl.appendChild(wrap);
      });

      handWrap.appendChild(handEl);
      content.appendChild(handWrap);
      row.appendChild(content);
      table.appendChild(row);
      tablesArea.appendChild(table);
    });
  }

  /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰è¡¨è£ãƒˆã‚°ãƒ«ï¼ˆèª°ã§ã‚‚ï¼‰ */
  async function toggleAvatar(seatIdx, face){
    const code=state.roomCode;
    await update(ref(db,`rooms/${code}/seats/${seatIdx}`),{ avatarFace: !face });
  }

  /* æ‰‹æœ­ å…¬é–‹/éå…¬é–‹ãƒˆã‚°ãƒ«ï¼ˆè‡ªå¸­ã®ã¿ï¼‰ */
  async function toggleReveal(seatIdx, cardId){
    if(!canOperateOnSeat(seatIdx)) return;
    const code=state.roomCode;
    const path = `rooms/${code}/seats/${seatIdx}/hand/${cardId}/revealed`;
    await runTransaction(ref(db,path),(prev)=>!prev);
  }

  /* ===== ã‚¢ã‚¤ãƒ†ãƒ 2ï¼šé¸æŠãƒãƒ³ãƒ‰ãƒ© ===== */
  async function selectItem2Self(seatIdx, cardId){
    const code=state.roomCode;
    await update(ref(db,`rooms/${code}/effects/item2`),{ step:"pickOther", self:{seat:seatIdx, cardId} });
    alert("ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¸€æšé¸ã‚“ã§ãã ã•ã„ã€‚");
  }
  async function selectItem2Other(seatIdx, cardId){
    const code=state.roomCode;
    const eff2 = (await get(ref(db,`rooms/${code}/effects/item2`))).val()||{};
    const selfSel = eff2.self; if(!selfSel) return;

    const roomSnap = await get(ref(db,`rooms/${code}`));
    const roomVal = roomSnap.val()||{};
    const seats = roomVal.seats||{};
    const a = seats[selfSel.seat], b = seats[seatIdx];
    if(!a?.hand?.[selfSel.cardId] || !b?.hand?.[cardId]) return;

    // äº¤æ›
    const temp = a.hand[selfSel.cardId].text;
    a.hand[selfSel.cardId].text = b.hand[cardId].text;
    b.hand[cardId].text = temp;

    // æ˜‡é †å†é…ç½®
    resortSeat(a); resortSeat(b);

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆ5ç§’ï¼‰
    const now = Date.now();
    const highlights = Object.assign({}, roomVal.effects?.item2?.highlights||{});
    highlights[`${selfSel.seat}_${selfSel.cardId}`] = { until: now+5000 };
    highlights[`${seatIdx}_${cardId}`] = { until: now+5000 };

    await update(ref(db,`rooms/${code}`),{
      [`seats/${selfSel.seat}`]: a,
      [`seats/${seatIdx}`]: b,
      [`effects/item2`]: { highlights }
    });
  }
  function resortSeat(seatObj){
    const arr = Object.keys(seatObj.hand).map(id=>({id, ...seatObj.hand[id]}));
    arr.sort((x,y)=>cardVal(x.text)-cardVal(y.text));
    arr.forEach((c,i)=>{ seatObj.hand[c.id].order=i; });
  }

  /* ===== æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ & ã‚¢ã‚¤ãƒ†ãƒ 1ï¼ˆ=ï¼‰ï¼ã‚¢ã‚¤ãƒ†ãƒ 12ï¼ˆâ‰ ï¼‰ ===== */
  function makeLetterCell(seatIdx, card, letter, canOperate){
    const cell=div("div","letterCell");
    const label=div("div","letterLabel",letter);

    label.onclick=(ev)=>{
      if(!canOperate) return;

      const placedEq = currentRoom?.effects?.item1?.placed || {};
      const eqCount = Object.keys(placedEq).length;
      const key = `${seatIdx}_${card.id}`;
      const hasEq = !!placedEq[key];
      const item1Used = !!(currentRoom?.items?.[1]?.used);

      const placedNe = currentRoom?.effects?.item12?.placedNE || {};
      const neCount = Object.keys(placedNe).length;
      const hasNe = !!placedNe[key];
      const item12Used = !!(currentRoom?.items?.[12]?.used);

      const actions=[];

      // =ï¼ˆã‚¢ã‚¤ãƒ†ãƒ 1ï¼‰
      if(item1Used){
        if(hasEq){
          actions.push({label:"ï¼ã‚’æ¶ˆã™", onClick: async ()=>{ await update(ref(db,`rooms/${state.roomCode}/effects/item1/placed/${key}`), null); }});
        }else if(eqCount<2){
          actions.push({label:"ï¼ ã‚’ç½®ã", onClick: async ()=>{ await update(ref(db,`rooms/${state.roomCode}/effects/item1/placed/${key}`), true); }});
        }
      }

      // â‰ ï¼ˆã‚¢ã‚¤ãƒ†ãƒ 12ï¼‰
      if(item12Used){
        if(hasNe){
          actions.push({label:"â‰ ã‚’æ¶ˆã™", onClick: async ()=>{ await update(ref(db,`rooms/${state.roomCode}/effects/item12/placedNE/${key}`), null); }});
        }else if(neCount<2){
          actions.push({label:"â‰  ã‚’ç½®ã", onClick: async ()=>{ await update(ref(db,`rooms/${state.roomCode}/effects/item12/placedNE/${key}`), true); }});
        }
      }

      // æ•°å­—ãƒˆãƒ¼ã‚¯ãƒ³ã¯å¸¸æ™‚
      actions.push({label:`æ•°å­—(${card.text}) ã‚’ç½®ã`, onClick: ()=> placeToken(seatIdx, card) });

      showTab(ev.currentTarget, actions);
    };
    cell.appendChild(label);

    // ä¸‹æ®µï¼šãƒˆãƒ¼ã‚¯ãƒ³æ•°å­—ï¼ˆã‚ã‚Œã°ï¼‰
    const tokenRef = ref(db, `rooms/${state.roomCode}/seats/${seatIdx}/tokens/${card.id}`);
    onValue(tokenRef,(s)=>{
      let tokenDiv = cell.querySelector(".token");
      if(!tokenDiv){ tokenDiv = div("div","token",""); cell.appendChild(tokenDiv); }
      const v=s.val();
      tokenDiv.textContent = (v==null) ? "" : String(v);
    });

    // ã€Œ=ã€è¡¨ç¤º
    const effectsEqRef = ref(db, `rooms/${state.roomCode}/effects/item1/placed`);
    onValue(effectsEqRef,(snap)=>{
      const placed = snap.val()||{};
      const key = `${seatIdx}_${card.id}`;
      const ex = cell.querySelector(".eqMark"); if(ex) ex.remove();
      if(placed[key]){
        const chip = div("div","eqMark","=");
        chip.onclick = (ev)=> showTab(ev.currentTarget, [
          {label:"ï¼ã‚’æ¶ˆã™", onClick: async ()=>{ await update(ref(db,`rooms/${state.roomCode}/effects/item1/placed/${key}`), null); }},
          {label:`æ•°å­—(${card.text}) ã‚’ç½®ã`, onClick: ()=> placeToken(seatIdx, card) }
        ]);
        cell.appendChild(chip);
      }
    });

    // ã€Œâ‰ ã€è¡¨ç¤º
    const effectsNeRef = ref(db, `rooms/${state.roomCode}/effects/item12/placedNE`);
    onValue(effectsNeRef,(snap)=>{
      const placed = snap.val()||{};
      const key = `${seatIdx}_${card.id}`;
      const ex = cell.querySelector(".neqMark"); if(ex) ex.remove();
      if(placed[key]){
        const chip = div("div","neqMark","â‰ ");
        chip.onclick = (ev)=> showTab(ev.currentTarget, [
          {label:"â‰ ã‚’æ¶ˆã™", onClick: async ()=>{ await update(ref(db,`rooms/${state.roomCode}/effects/item12/placedNE/${key}`), null); }},
          {label:`æ•°å­—(${card.text}) ã‚’ç½®ã`, onClick: ()=> placeToken(seatIdx, card) }
        ]);
        cell.appendChild(chip);
      }
    });

    return cell;
  }
  function placeToken(seatIdx, card){
    update(ref(db),{ [`rooms/${state.roomCode}/seats/${seatIdx}/tokens/${card.id}`]: card.text });
  }

  /* å…±é€šï¼šå°ã‚¿ãƒ–è¡¨ç¤º */
  function showTab(anchor, actions){
    document.querySelectorAll(".floatTab").forEach(x=>x.remove());
    const tab=document.createElement("div");
    tab.className="floatTab";
    actions.forEach((a,i)=>{
      const b=document.createElement("button");
      b.textContent=a.label;
      b.style.display="block"; b.style.width="100%";
      b.style.margin=(i? "6px 0 0 0":"0");
      b.onclick=()=>{ a.onClick(); tab.remove(); };
      tab.appendChild(b);
    });
    const r=anchor.getBoundingClientRect();
    tab.style.left=(r.left+window.scrollX)+"px";
    tab.style.top =(r.bottom+window.scrollY+6)+"px";
    document.body.appendChild(tab);
    const closer=(e)=>{ if(e.target!==tab){ tab.remove(); document.removeEventListener("click",closer,true);} };
    setTimeout(()=>document.addEventListener("click",closer,true),0);
  }

  function renderMissionDetails(roomVal){
    const lines = roomVal.missionTextLines || [];
    missionLines.innerHTML="";
    if(lines.length){
      lines.forEach(t=>{
        const p=document.createElement("div");
        p.style.fontSize="12px";
        p.innerHTML = t; // #éƒ¨åˆ†ã¯ <b>â€¦</b> ã‚’å«ã‚€
        missionLines.appendChild(p);
      });
      missionPanel.classList.remove("hidden");
    }else{
      missionPanel.classList.add("hidden");
    }
  }

  /* é€€å®¤ */
  leaveBtn.addEventListener("click", async ()=>{
    const code=state.roomCode; if(!code) return;
    if(state.mySeat){
      await update(ref(db,`rooms/${code}/seats/${state.mySeat}`),{ occupantUser:null, occupantName:null });
    }
    const base = state.role==="player" ? "players" : "spectators";
    await remove(ref(db,`rooms/${code}/${base}/${state.userId}`));
    await remove(ref(db,`rooms/${code}/wants/${state.userId}`));
    location.href = location.origin + location.pathname;
  });

  // boot
  (function boot(){
    const url=new URL(location.href);
    const code=cleanCode(url.searchParams.get("room")||"");
    if(code) roomCodeInput.value=code;
    setView("join");
  })();
</script>
</body>
</html>
