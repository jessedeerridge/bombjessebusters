<!DOCTYPE html> 
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BOMBã€€BUSTERS</title>
<style>
  :root{
    --card-w:24px; --card-h:40px; --card-gap:3px;
    --char-w:40px; --char-h:60px;
    --item-w:50px; --item-h:75px;
    --di-w:70px; --di-h:70px;
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¦‹ãˆã¦ã„ã‚‹æ ã¯å›ºå®šã€‚å†…éƒ¨ã ã‘åºƒã’ã‚‹ */
    --table-h:96px; --header-h:8px;
    --content-h: calc(var(--table-h) - var(--header-h) - 6px);
    --content-extra: 18px;
    --font-card:16px; --font-weight:bold;
  }

  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee}
  h1{margin:0;font-size:18px}
  .small{font-size:12px;opacity:.75}
  .bold{font-weight:700}

  main{padding:10px 12px;display:flex;gap:12px; overflow:visible;}
  .col{flex:1;min-width:0; overflow:visible;}
  .side{width:38%;max-width:420px}

  .join-box{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .join-box input{padding:8px;border:1px solid #ddd;border-radius:6px}
  .btn{padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#f8f8f8;cursor:pointer}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .btn.small{padding:6px 10px;font-size:12px}
  .btn.big{padding:12px 14px;font-size:16px}
  .btn.ghost{background:transparent}
  .hidden{display:none!important}

  .fab{position:fixed;right:12px;bottom:12px;width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:#111;color:#fff;cursor:pointer;z-index:10}
  .menu{position:fixed;right:12px;bottom:64px;display:flex;flex-direction:column;gap:6px;background:#fff;border:1px solid #eee;border-radius:10px;padding:8px;box-shadow:0 12px 24px rgba(0,0,0,.08);z-index:11}
  .menu .btn{width:220px;text-align:left}

  /* â˜… ãƒ›ã‚¹ãƒˆå·¦ä¸‹ã®å·¥å…·ãƒœã‚¿ãƒ³ */
  .host-tool{position:fixed;left:12px;bottom:12px;width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:#111;color:#fff;cursor:pointer;z-index:10}

  .items-bar{display:flex;align-items:center;gap:8px;margin-top:0}
  .items{display:flex;gap:6px;align-items:center;overflow-x:auto}
  .item{
    position:relative; width:var(--item-w);height:var(--item-h);
    border:1px solid #ddd;border-radius:8px;background:#fff;
    background-size:cover;background-position:center;cursor:pointer;flex:0 0 auto
  }
  .item.used{background:#fff url('./itemback.jpg') center/cover no-repeat}


 .di{ margin-left:auto;width:var(--di-w);height:var(--di-h);border-radius:10px;border:1px solid #ddd;background:#fff;
    background-size:cover;background-position:center;cursor:pointer;flex:0 0 auto }

/* â–¼ æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºå¸¯ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ä¸‹ãªã©ï¼‰ */
  .numlane { display:flex; gap:6px; margin-top:6px; align-items:center; overflow-x:auto; }
  .numcard { width:32px; height:48px; border-radius:6px; border:1px solid #ddd; background:#fff center/cover no-repeat; flex:0 0 auto; }
  .numdeck { width:32px; height:48px; border-radius:6px; border:1px dashed #bbb; background:#fff url('./numberdeck.png') center/70% no-repeat; cursor:pointer; user-select:none; display:grid; place-items:center; }
  .numrest { font-size:11px; opacity:.7; margin-left:2px; }

  /* â˜… å³2/å·¦2/å³4/å·¦4 ã‚’æ¨ªå‘ãã«ï¼ˆæ¨ªé•·ï¼‰ */
  .rulecard { width:48px; height:32px; border-radius:6px; border:1px solid #ddd; background:#fff center/contain no-repeat; flex:0 0 auto; }

  /* â˜… æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®ã€Œé‡ã­ã€ç”¨ãƒ›ãƒ«ãƒ€ãƒ¼ï¼†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  .numcard-holder { position:relative; width:32px; height:48px; flex:0 0 auto; }
  .numcard.overlay { position:absolute; left:2px; top:2px; opacity:0.9; }
  .numcard.overlay:nth-child(3){ left:4px; top:4px; opacity:0.85; }
  .numcard.overlay:nth-child(4){ left:6px; top:6px; opacity:0.8; }

  /* â˜… ãƒŸãƒƒã‚·ãƒ§ãƒ³12ï¼šã‚¢ã‚¤ãƒ†ãƒ ä¸­å¤®ä¸‹ã«å›ºå®šé…ç½®ã™ã‚‹ãƒ”ãƒ³ */
  /* â˜… ãƒŸãƒƒã‚·ãƒ§ãƒ³12ï¼šã‚¢ã‚¤ãƒ†ãƒ ã®â€œå¤–å´ã®çœŸä¸‹â€ã«ä¸¦ã¹ã‚‹å¸¯ */
  .num-under{
    display:grid;
    grid-auto-flow:column;
    grid-auto-columns:var(--item-w); /* ã‚¢ã‚¤ãƒ†ãƒ å¹…ã«åˆã‚ã›ã¦1åˆ—=1ã‚¢ã‚¤ãƒ†ãƒ  */
    gap:6px;               /* .items ã® gap ã¨åˆã‚ã›ã‚‹ */
    margin-top:4px;        /* ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ã™ãä¸‹ã«è¡¨ç¤º */
    align-items:start;
    justify-content:start;
    width:max-content;     /* ã¯ã¿å‡ºã—å¯¾ç­–ï¼šå†…å®¹å¹…ã«åˆã‚ã›ã‚‹ */
  }
  .num-under .slot{
    width:var(--item-w);
    display:grid;
    place-items:center;    /* ä¸­å¤®é…ç½® */
  }
  .num-under .numcard-holder{
    position:relative;
    width:32px; height:48px;
  }
  
  .tables{display:flex;flex-direction:column;gap:8px;margin-top:6px;overflow:visible;position:relative;}
  .table{
    position:relative;border:1px dashed #ddd;border-radius:10px;
    padding:0 8px;height:var(--table-h);display:block;background:#fff;
    overflow:auto;width:max-content;z-index:0;
  }
  .table.elevated{ z-index:9999; }

  .t-header{height:var(--header-h);display:flex;align-items:center;gap:6px;font-size:12px;margin-top:0;}
  .title{text-decoration:underline;padding-right:4px}

  .t-content{
    position:absolute;left:8px;right:8px;top:calc(var(--header-h) + 2px);bottom:calc(4px - var(--content-extra));
    display:flex;gap:8px;align-items:flex-start;min-height:var(--content-h);overflow:visible;
  }

  .char-card{
    width:var(--char-w);height:var(--char-h);background-size:cover;background-position:center;border-radius:6px;border:1px solid #ddd;
    cursor:pointer;user-select:none;flex:0 0 auto;
  }
  /* â˜… #13ï¼šã‚­ãƒ£ãƒ©ã¨ä¸‹éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¸¦ç©ã¿ã™ã‚‹ãŸã‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
  .char-col{
    display:flex; flex-direction:column; align-items:center; gap:2px;
    width:var(--char-w); flex:0 0 auto;
  }
  
  .char-card.blank{background:#f3f4f6;border:1px dashed #d1d5db;cursor:default;}

  .hand{
    display:flex;align-items:flex-start;gap:var(--card-gap);
    overflow-y:visible; overflow-x:visible;
    flex:0 0 auto;position:relative;
    max-height:calc(var(--content-h) - 2px + var(--content-extra));
    padding-bottom:2px;
  }

  .card-wrap{position:relative;width:var(--card-w);min-height:calc(var(--card-h) + 36px);flex:0 0 auto;}
  .card{
    width:var(--card-w);height:var(--card-h);border-radius:6px;border:1px solid #ddd;position:absolute;left:0;top:0;
    background:#bbb;display:flex;align-items:flex-start;justify-content:center;cursor:pointer;user-select:none
  }
  .card.back{background:#fff url('./codeback.jpg') center/cover no-repeat;border-color:#ccc}
  .card.open{background:#000}
  /* â˜… ã‚¢ã‚¤ãƒ†ãƒ 2ï¼šé¸æŠå¯èƒ½ã‚«ãƒ¼ãƒ‰ã®é’æ  */
  .card.i2-selectable{outline:2px dashed #38bdf8; outline-offset:-1px;}

  .num{position:absolute;top:2px;left:0;right:0;text-align:center;font-size:var(--font-card);font-weight:var(--font-weight);color:#fff;line-height:1;text-shadow:0 1px 0 rgba(0,0,0,.15)}
  .img-bottom{position:absolute;left:1px;right:1px;bottom:1px;height:18px;border-radius:0 0 6px 6px;background-size:cover;background-position:center}

  .badge-fixed{position:absolute;left:0;right:0;top:calc(var(--card-h) + 2px);display:flex;flex-direction:column;align-items:center;z-index:10000;pointer-events:auto;}
  .alpha{width:var(--card-w);text-align:center;font-size:11px;user-select:none;line-height:1;background:#6b21a8;color:#fff;border:1px solid #4c1d95;border-radius:6px;padding:2px 0;cursor:pointer}
  .tok-col{display:flex;flex-direction:column;gap:2px;margin-top:2px}
.token{
    font-size:11px; line-height:1;
    border-radius:4px;
    /* æ­£æ–¹å½¢ãƒ»ä¸­å¤®æƒãˆ */
    display:inline-grid; place-items:center;
    width:20px; height:20px;   /* â† çµ±ä¸€ã‚µã‚¤ã‚ºï¼ˆ2æ¡OKï¼‰ */
    padding:0;                 /* ä¸­å¤®ã´ã£ãŸã‚Šã« */
  }  /* â–¼â–¼ å¤‰æ›´1ï¼šï¼ ã¨ â‰  ã®è‰²ã‚’å…¥ã‚Œæ›¿ãˆ â–¼â–¼ */
  .token.equal{background:#cfe8ff;color:#000}
  .token.black{background:#000;color:#fff}
  .token.x1{background:#e5e7eb;color:#000}
  .token.noteq{background:#ffedd5;color:#000}

/* â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³å°‚ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ */
  .token.yellow { background:#000; color:#ffd400; }  /* é»„ã‚³ãƒ¼ãƒ‰ã€Œâ–§ã€ */
  .token.x2 { background:#e5e7eb; color:#000; }      /* x2 */
  .token.x3 { background:#e5e7eb; color:#000; }      /* x3 */
  .token.even { background:#cfe8ff; color:#000; }    /* å¶æ•° 2/4 */
  .token.odd  { background:#e75480; color:#000; }    /* å¥‡æ•° 1/3 */
.token.yellowX { background:#ffd400; color:#000; }

.marker,.blink{
  position:absolute;left:0;right:0;top:-12px;
  text-align:center;font-size:14px;line-height:1;
  z-index:12000; pointer-events:none;
}
.blink{ animation: blink 0.6s linear infinite; }
@keyframes blink{ 0%,100%{opacity:0} 50%{opacity:1} }

/* â˜… #22ï¼šåå‰ã®ä¸‹ã«ç½®ãã€Œé¸æŠãƒœã‚¿ãƒ³ Ã—3ã€ */
.pick3{ display:flex; gap:4px; margin-left:8px; }
.pickbtn{
  width:22px; height:22px; border:1px dashed #999; border-radius:4px;
  background:#fff; display:grid; place-items:center; font-size:12px; line-height:1;
  color:#000; user-select:none; cursor:pointer;
}
.pickbtn.readonly{ opacity:.6; cursor:default; }

/* â–¼â–¼ ã“ã“ã‹ã‚‰ è¿½åŠ  â–¼â–¼ */
.m22-panel{
  display:flex; gap:6px; align-items:center; flex-wrap:wrap;
  margin-top:6px;
}
.m22-panel .cap{ font-size:12px; opacity:.75; margin-right:6px; }
.m22-panel .token{ cursor:pointer; }
.m22-panel .token.disabled{ opacity:.35; cursor:default; }

.m22-under{
  display:flex; gap:2px; margin-top:2px;
}
.m22-under .token{ width:20px; height:20px; }
/* â–²â–² ã“ã“ã¾ã§ è¿½åŠ  â–²â–² */


/* â˜… #22ï¼šæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ï¼ˆ3Ã—4ï¼‰â€” é»’ãƒˆãƒ¼ã‚¯ãƒ³ + å³ã« x0/x1/x2 */
.info22{
  position:fixed; left:50%; bottom:12px; transform:translateX(-50%);
  background:#fff; border:1px solid #eee; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.12);
  padding:8px; z-index:2147483601;
  display:grid; grid-template-columns:repeat(4, auto); gap:8px; /* â† 3è¡ŒÃ—4åˆ—ã«ãªã‚‹ */
}
.info22 .cell{
  display:flex; align-items:center; gap:6px;
  border:1px dashed #bbb; border-radius:6px; padding:6px 8px; background:#fff; font-size:12px;
}
.info22 .cell .token{ width:22px; height:22px; } /* æ—¢å­˜ã® .token ã‚’æµç”¨ï¼ˆé»’ï¼‰ */
.info22 .xlabel{ font-family:ui-monospace, SFMono-Regular, Menlo, monospace; opacity:.8; }


/* â˜… ãƒã‚§ãƒƒã‚¯è¡¨ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«1ã®çœŸä¸Šï¼‰ */
.checklist{
  display:flex; gap:6px; margin:2px 0 2px 0; align-items:center;
}
.check-item{
  position:relative; width:22px; height:22px;
  border:1px dashed #999; border-radius:4px;
  background:#fff; display:grid; place-items:center;
  font-size:12px; user-select:none; color:#000;
}
.check-mark{
  position:absolute; inset:0; margin:auto;
  width:18px; height:18px; border-radius:50%;
  background:rgba(34,197,94,.35);
  pointer-events:none;
}
  
  .pop-layer{ position:fixed;inset:0;z-index:2147483647;pointer-events:none; }
  .mini-pop{
    position:fixed;z-index:2147483647;background:#fff;border:1px solid #eee;border-radius:8px;padding:6px;box-shadow:0 8px 20px rgba(0,0,0,.08);
    display:flex;gap:6px;pointer-events:auto;flex-wrap:wrap;max-width:min(90vw,320px)
  }
  .bottom-pop{left:50%;transform:translateX(-50%);bottom:10px;}

  /* â˜… ç”»é¢ä¸‹éƒ¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é»’æ ãƒãƒƒã‚¸ï¼ˆã‚¢ã‚¤ãƒ†ãƒ 16è¡¨ç¤ºï¼‰ */
  .global-reveal{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);z-index:2147483647;}
  .global-reveal .token{cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.12);}

  /* è¿½åŠ ï¼šã‚¢ã‚¤ãƒ†ãƒ 16ã®ã‚µã‚¤ãƒ‰è¡¨ç¤º */
  .i16-side{
    position:absolute; left:calc(100% + 6px); top:50%; transform:translateY(-50%);
    z-index:2147483000;
  }

/* è¿½åŠ ï¼šã‚¢ã‚¤ãƒ†ãƒ 16ã®é»’ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚«ãƒ¼ãƒ‰ã®çœŸä¸‹ã«è¡¨ç¤º */
.i16-below{
  position:absolute;
  left:50%;
  top:calc(100% + 4px);
  transform:translateX(-50%);
  z-index:2147483000;
}

/* è¿½åŠ ï¼šã‚¢ã‚¤ãƒ†ãƒ 16ä½¿ç”¨æ™‚ã¯ã‚«ãƒ¼ãƒ‰æœ¬ä½“ã‚’ä¸Šã«æŒã¡ä¸Šã’ã‚‹ */
.i16-lift{
  transform: translateY(-18px);
}
    
  .panel{display:flex;flex-direction:column;gap:10px}
  .list{border:1px solid #eee;border-radius:10px;padding:8px}
  .list h3{margin:0 0 6px 0;font-size:13px}
  .name{padding:4px 6px;border-radius:6px}
  .muted{opacity:.6}
  .mission{border:1px solid #eee;border-radius:10px;padding:10px}
  .mission h3{margin:0 0 8px 0;font-size:14px}

  .mission-footer{margin-top:12px;border-top:1px solid #eee;padding-top:8px}
  .mission-footer .line{font-size:13px;line-height:1.5}
  .mission-footer .line + .line{margin-top:4px}

  .restart-pop,.start-pop{
    position:fixed;left:50%;top:50%;transform:translate(-50%, -50%);
    background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.12);
    padding:14px;z-index:220;display:flex;flex-direction:column;gap:10px;min-width:280px
  }
  .seat-pop{
    position:fixed;left:50%;bottom:10px;transform:translateX(-50%);
    background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.12);
    padding:10px;z-index:220;display:flex;flex-direction:column;gap:10px;min-width:280px
  }
  .start-pop .row,.seat-pop .row{display:flex;gap:8px;align-items:center}
  .start-pop label,.seat-pop label{width:84px;font-size:13px}
  .start-pop select{flex:1;padding:8px;border:1px solid #ddd;border-radius:8px;background:#fff}
  .restart-actions{display:flex;gap:8px;align-items:center}
  .restart-actions .btn:first-child{font-size:11px;padding:4px 8px}
  .restart-actions .btn.big{flex:1}

  .tabs{display:flex;gap:6px;flex-wrap:wrap}
  .tab{padding:6px 10px;border:1px solid #ddd;border-radius:999px;cursor:pointer;user-select:none}
  .tab.active{background:#111;color:#fff;border-color:#111}
  .tab.disabled{opacity:.35;pointer-events:none}

 @media (max-width: 860px){
    main{flex-direction:column}
    .side{width:100%;max-width:none}
  }

/* â–¼â–¼ ç”»é¢ä¸‹éƒ¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ â–¼â–¼ */
.mp{
  position:fixed; left:0; right:0; bottom:0;
  background:#fff; border-top:1px solid #eee;
  box-shadow:0 -10px 24px rgba(0,0,0,.08);
  z-index:2147483600;
  /* â† iPhoneã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã«åˆã‚ã›ã¦ä½™ç™½ã‚’å–ã‚‹ï¼ˆå·¦å³/ä¸‹ï¼‰ */
  padding-top:8px;
  padding-right: max(10px, env(safe-area-inset-right));
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
  padding-left:  max(10px, env(safe-area-inset-left));
}
.mp-inner{
  max-width:100%;
  width:100%;
  margin:0 auto;
}
.mp-row{ display:flex; gap:10px; align-items:flex-start; margin:8px 0; }
.mp-label{ width:64px; font-size:12px; opacity:.75; line-height:2; }

/* â˜… æ¨ª6åˆ—å›ºå®šãƒ»å³ç«¯ãŒåˆ‡ã‚Œãªã„ã‚ˆã† minmax(0,1fr) ã‚’ä½¿ç”¨ */
.mp-grid{
  display:grid;
  grid-template-columns: repeat(6, minmax(0, 1fr)); /* 6åˆ—å›ºå®š */
  gap:6px;
  max-height:50vh;
  overflow-y:auto;
  overflow-x:hidden;
}

/* â˜… æ­£æ–¹å½¢ãƒœã‚¿ãƒ³ï¼ˆä¸­èº«ãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã† min-width:0 ã‚‚ä»˜ä¸ï¼‰ */
.mp-grid .btn{
  width:100%;
  min-width:0;            /* â† ã“ã‚ŒãŒç„¡ã„ã¨å³ç«¯ãŒæŠ¼ã—å‡ºã•ã‚ŒãŒã¡ */
  text-align:center;
  padding:10px 0;
  aspect-ratio:1 / 1;
  font-size:16px;
}

/* å°ã•ã„ç«¯æœ«ã§å°‘ã—ã ã‘è©°ã‚ã‚‹ï¼ˆä»»æ„ï¼‰ */
@media (max-width: 360px){
  .mp-grid{ gap:4px; }
  .mp-grid .btn{ font-size:14px; padding:8px 0; }
}

.mp-actions{ display:flex; justify-content:flex-end; margin-top:6px; }
/* â–²â–² ç”»é¢ä¸‹éƒ¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ â–²â–² */


</style>
</head>
<body>
<header>
  <h1>BOMBã€€BUSTERS</h1>
  <div class="small" id="roomInfo"></div>
</header>

<main>
  <div class="col">
<div class="join-box" id="joinBox">
  <!-- â˜…è¿½åŠ ï¼šåå‰ï¼ˆ4æ–‡å­—ä»¥å†…ï¼‰â€»æœªå…¥åŠ›ã§ã‚‚å…¥å®¤å¯ -->
  <input id="userName" placeholder="åå‰ï¼ˆ4æ–‡å­—ä»¥å†…ï¼‰" maxlength="4" />
  <input id="roomCode" placeholder="ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰" maxlength="12" />
  <button class="btn primary" id="btnJoin">å‚åŠ ã§å…¥å®¤</button>
  <button class="btn ghost" id="btnRandom">ã‚³ãƒ¼ãƒ‰ä½œæˆ</button>
  <span class="small">å…¥å®¤å¾Œã€å³ä¸‹ã®æ­¯è»Šã‹ã‚‰å¸­ã‚’æ±ºã‚ã‚‰ã‚Œã¾ã™</span>
</div>


    <div id="lobby" class="hidden">
      <div class="row" style="display:flex;gap:8px;align-items:center;margin-top:4px">
     <button class="btn primary" id="btnStart" title="ãƒ›ã‚¹ãƒˆã®ã¿">çˆ†å¼¾ã‚’è§£é™¤ï¼</button>
<span class="small" id="startHint">ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿æŠ¼ã›ã¾ã™ï¼‰</span>
</div>

      <div class="items-bar hidden" id="itemsBar">
        <div class="items" id="items"></div>
        <div class="di" id="di"></div>
      </div>

      <div class="tables" id="tables"></div>

<div id="missionFooter" class="mission-footer hidden">
  <div id="m22PickPanel" class="m22-panel hidden">
    <span class="cap">æœªæ‰€æŒã®æ•°å­—ã‹ã‚‰æœ€å¤§2ã¤é¸æŠï¼š</span>
  </div>
  <div id="missionDetailTitle" class="bold line"></div>
  <div id="missionDetailBody"></div>
</div>


      <button class="fab hidden" id="gear" title="è¨­å®š">âš™</button>
      <div class="menu hidden" id="menuPopup">
        <button class="btn" id="btnSit">å¸­ã«åº§ã‚‹</button>
        <button class="btn" id="btnLeaveSeat">å¸­ã‚’ç«‹ã¤</button>
        <button class="btn" id="btnPickMission">ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’é¸ã¶</button>
      </div>
    </div>
  </div>

  <div class="col side">
    <div class="panel">
      <div class="list" id="listsBox">
        <h3>å‚åŠ è€…</h3><div id="players"></div>
        <h3 style="margin-top:10px">è¦³æˆ¦è€…</h3><div id="spectators"></div>
      </div>
      <div class="mission" id="missionBox">
        <h3>ãƒŸãƒƒã‚·ãƒ§ãƒ³</h3>
        <div id="missionTitle" class="bold">ï¼ˆæœªé¸æŠï¼‰</div>
        <div id="missionText" class="small">é–‹å§‹æ™‚ã«äººæ•°ã¨ä¸€ç·’ã«é¸ã³ã¾ã™</div>
      </div>
    </div>
  </div>
</main>

<!-- â–¼â–¼ ç”»é¢ä¸‹éƒ¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ â–¼â–¼ -->
<div id="missionPicker" class="mp hidden">
  <div class="mp-inner">
    <div class="mp-row">
      <div class="mp-label">äººæ•°</div>
      <div id="mpCounts" class="tabs"></div>
    </div>
    <div class="mp-row">
      <div class="mp-label">ãƒŸãƒƒã‚·ãƒ§ãƒ³</div>
      <div id="mpMissions" class="mp-grid"></div>
    </div>
    <div class="mp-actions">
      <button class="btn small ghost" id="btnMpBack">æˆ»ã‚‹</button>
    </div>
  </div>
</div>
<!-- â–²â–² ç”»é¢ä¸‹éƒ¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ â–²â–² -->

<div id="miniPop" class="mini-pop hidden"></div>
<div id="popLayer" class="pop-layer"></div>
<!-- â˜… ã‚¢ã‚¤ãƒ†ãƒ 16ã®è¡¨ç¤ºå…ˆï¼ˆç”»é¢ä¸‹éƒ¨ï¼‰ -->
<div id="globalReveal" class="global-reveal hidden"></div>
<!-- â˜… ãƒ›ã‚¹ãƒˆå·¦ä¸‹ å·¥å…·ã‚¢ã‚¤ã‚³ãƒ³ -->
<button id="hostTool" class="host-tool hidden" title="å·¥å…·">ğŸ”§</button>

<div id="restartPop" class="restart-pop hidden">
  <div style="font-size:14px">ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ</div>
  <div class="restart-actions">
    <button class="btn" id="btnRestartOk">ã‚„ã‚Šç›´ã™</button>
    <button class="btn big" id="btnRestartCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<div id="startPop" class="start-pop hidden">
  <div class="row"><label>äººæ•°</label>
    <select id="selCount"><option>2</option><option>3</option><option selected>4</option><option>5</option><option>6</option></select>
  </div>
  <div class="row"><label>ãƒŸãƒƒã‚·ãƒ§ãƒ³</label>
<select id="selMission">
  <option value="1">#1 çˆ†å¼¾ï¼ˆèµ¤ã‚³ãƒ¼ãƒ‰ï¼‰</option><option value="2">#2 é»„ã‚³ãƒ¼ãƒ‰</option><option value="3">#3 ã•ã‚‰ã„çˆ†å¼¾</option>
  <option value="4">#4</option><option value="5">#5</option><option value="6">#6</option><option value="7">#7</option>
  <option value="8">#8</option>
  <option value="9">#9 aaa</option>
  <option value="10">#10 bbb</option>
  <option value="11">#11 ccc</option>
  <option value="12">#12</option>
  <option value="42">#42</option><option value="43">#43</option>
</select>
  </div>
  <div class="row" style="justify-content:flex-end">
    <button class="btn small" id="btnStartOk">OK</button>
    <button class="btn small ghost" id="btnStartCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<div id="seatPop" class="seat-pop hidden">
  <div class="row"><label>å¸­ã‚’é¸æŠ</label><div id="seatTabs" class="tabs"></div></div>
  <div class="row" style="justify-content:flex-end">
    <button class="btn small ghost" id="btnSeatCancel">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get, set, update, remove, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBpSx_lEcg1j9ExMJsVl5lBqAxOCfmFmSnI",
  authDomain: "chat-68c4c.firebaseapp.com",
  databaseURL: "https://chat-68c4c-default-rtdb.firebaseio.com",
  projectId: "chat-68c4c",
  storageBucket: "chat-68c4c.appspot.com",
  messagingSenderId: "172284325975",
  appId: "1:172284325975:web:6f9bdd77e822c0ea39dd92"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* State */
const state = {
  roomCode:null, userId:crypto.randomUUID(), userName:'', // â˜…æœªå…¥åŠ›ãªã‚‰å…¥å®¤æ™‚ã«æ¡ç•ª
  isHost:false, mode:null, gameStarted:false, seatedTable:null, watching:null, seatPick:null
};
// â–¼ #13 ãƒ˜ãƒƒãƒ€ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã®é…å»¶æ›´æ–°ç”¨ã‚¬ãƒ¼ãƒ‰ï¼ˆãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã«DBã‚’æ›¸ã‹ãªã„ãŸã‚ï¼‰
let m13HeaderUpdateScheduled = false;
let m13HeaderClearIndices = null; // null â†’ Set(index)ï¼ˆæ¶ˆã™å¯¾è±¡ã®ãƒ†ãƒ¼ãƒ–ãƒ«indexã‚’è²¯ã‚ã‚‹ï¼‰


/* Elements */
const roomInfo = document.getElementById('roomInfo');
const joinBox= document.getElementById('joinBox');
const inputName = document.getElementById('userName'); // â˜…è¿½åŠ 
const inputCode = document.getElementById('roomCode');

const btnJoin = document.getElementById('btnJoin');
const btnRandom=document.getElementById('btnRandom');

const lobby   = document.getElementById('lobby');
const btnStart= document.getElementById('btnStart');
const startHint=document.getElementById('startHint');
// â–¼ è¿½åŠ ï¼šã‚¯ã‚¤ãƒƒã‚¯ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼èµ·å‹•ãƒœã‚¿ãƒ³
const btnOpenPicker = document.getElementById('btnOpenPicker');

const itemsBar= document.getElementById('itemsBar');
const itemsEl = document.getElementById('items');
const diEl    = document.getElementById('di');

const tablesEl= document.getElementById('tables');
const gear    = document.getElementById('gear');
const menuPop = document.getElementById('menuPopup');
const btnSit  = document.getElementById('btnSit');
const btnLeave= document.getElementById('btnLeaveSeat');
// â–¼ ã‚„ã‚Šç›´ã™ã‚’å»ƒæ­¢ã—ã€ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚¯ã«å¤‰æ›´
const btnPickMission = document.getElementById('btnPickMission');
// â–¼ æ—¢å­˜ã®restartPopç³»ã¯æ®‹ã™ãŒä½¿ç”¨ã—ãªã„ï¼ˆäº’æ›ç¶­æŒï¼‰
const restartPop=document.getElementById('restartPop');
const btnRestartOk=document.getElementById('btnRestartOk');
const btnRestartCancel=document.getElementById('btnRestartCancel');

// â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼è¦ç´ 
const mp = document.getElementById('missionPicker');
const mpCounts = document.getElementById('mpCounts');
const mpMissions = document.getElementById('mpMissions');
const btnMpBack = document.getElementById('btnMpBack');

const playersEl=document.getElementById('players');
const specsEl  =document.getElementById('spectators');
const listsBox =document.getElementById('listsBox');

const miniPop = document.getElementById('miniPop');

const startPop=document.getElementById('startPop');
const selCount=document.getElementById('selCount');
const selMission=document.getElementById('selMission');
const btnStartOk=document.getElementById('btnStartOk');
const btnStartCancel=document.getElementById('btnStartCancel');

const missionTitle=document.getElementById('missionTitle');
const missionText =document.getElementById('missionText');
const missionBox  =document.getElementById('missionBox');

const missionFooter = document.getElementById('missionFooter');
const missionDetailTitle = document.getElementById('missionDetailTitle');
const missionDetailBody  = document.getElementById('missionDetailBody');
const m22PickPanel = document.getElementById('m22PickPanel');

const seatPop = document.getElementById('seatPop');
const seatTabs= document.getElementById('seatTabs');
const btnSeatCancel=document.getElementById('btnSeatCancel');

/* Pop layer */
const popLayer = document.getElementById('popLayer');
/* global reveal */
const globalReveal = document.getElementById('globalReveal');
/* host tool */
const hostTool = document.getElementById('hostTool');

/* helpers */
function hiragana(len=4){
  const h=[..."ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“"];
  return Array.from({length:len},()=>h[Math.random()*h.length|0]).join('');
}
const H=(el,b)=> el.classList.toggle('hidden', !!b);
function pos(el,x,y){el.style.left=x+'px';el.style.top=y+'px';}
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]]}return a}
function cssNum(name){const v=getComputedStyle(document.documentElement).getPropertyValue(name).trim(); return parseFloat(v.replace('px',''))||0;}
const now=()=>Date.now();

/* ==== ãƒŸãƒƒã‚·ãƒ§ãƒ³ç´ æå®šç¾© ==== */
const MATERIALS = {
  redCodes : [1,2,3,4,5,6,7,8,9,10,11].map(n=> n + 0.5),
  yellowCodes : [1,2,3,4,5,6,7,8,9,10,11].map(n=> n + 0.1),
  numbers : [1,2,3,4,5,6,7,8,9,10,11,12]
};
// â˜… ä¿®æ­£ï¼šæ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«
const imgNumber = n => `./s${n}.jpg`;
const imgBack   = `./numbercardback.jpg`;
const imgRule   = name => `./${name}.jpg`; // right2/left2/right4/left4


/* ===== æ•°å€¤ã‚«ãƒ¼ãƒ‰ä¸€æ„ç®¡ç†ï¼†é‡ã­è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
/* åŒã˜æ•°å­—ã®ã‚«ãƒ¼ãƒ‰ãŒåŒæ™‚ã«å­˜åœ¨ã—ãªã„ã‚ˆã†ã«ç®¡ç†ã™ã‚‹ */
const NUMCARD_REG = new Map(); // n -> { holder:HTMLDivElement, count:number }

/* === å‰ã®ã‚²ãƒ¼ãƒ ã®è¡¨ç¤ºç‰©ã‚’å…¨ã¦æƒé™¤ã™ã‚‹ === */
function clearMissionOverlays(){
  document.querySelectorAll('.numlane').forEach(n => n.remove());
  document.querySelectorAll('.num-pin').forEach(pin => pin.remove());
  document.querySelectorAll('.num-under').forEach(n => n.remove()); // â˜… è¿½åŠ 
  NUMCARD_REG.clear();
}


/** mountParenté…ä¸‹ã« n ã®ã‚«ãƒ¼ãƒ‰ã‚’ã€Œæ–°è¦ä½œæˆ or æ—¢å­˜ã«é‡ã­ã€ */
function placeNumberCard(n, mountParent){
  if (NUMCARD_REG.has(n)) {
    // â˜… æ—¢ã«å ´ã«ã‚ã‚‹ã®ã§ä½•ã‚‚ã—ãªã„ï¼ˆâ€œåŒã˜ã‚«ãƒ¼ãƒ‰ã¯å­˜åœ¨ã—ãªã„â€ï¼‰
    return;
  }
  const holder = document.createElement('div');
  holder.className = 'numcard-holder';
  const base = document.createElement('div');
  base.className = 'numcard';
  base.style.backgroundImage = `url('${imgNumber(n)}')`;
  holder.appendChild(base);
  mountParent.appendChild(holder);
  NUMCARD_REG.set(n, holder);
}

/** æœªä½¿ç”¨ï¼ˆï¼ç¾åœ¨ãƒ†ãƒ¼ãƒ–ãƒ«ä¸Šã«å­˜åœ¨ã—ãªã„ï¼‰æ•°å­—ã‹ã‚‰ count æšé¸ã¶ */
function pickUnusedNumbers(count){
  const used = new Set(NUMCARD_REG.keys());
  const pool = MATERIALS.numbers.filter(x => !used.has(x));
  shuffle(pool);


function findNextSeatedPlayerIndex(){
  const t = state.watching?.tables || [];
  const i = t.findIndex(T => T.playerId === state.userId);
  if(i < 0) return -1;
  for(let k=1; k<=t.length; k++){
    const idx = (i + k) % t.length;
    if(t[idx]?.playerId) return idx;
  }
  return -1;
}

  
  return pool.slice(0, count);
}

/* === ãƒŸãƒƒã‚·ãƒ§ãƒ³12ç”¨ï¼šå„ã‚¢ã‚¤ãƒ†ãƒ ã®â€œå¤–å´ã®çœŸä¸‹â€ã«ä¸€æšãšã¤ === */
function distributeNumbersToItemsCentered(eachCount=1){
  const itemsBar = document.getElementById('itemsBar');
  const items    = document.querySelectorAll('#items .item');
  if(!itemsBar || items.length===0) return;

  // æ—¢å­˜ã‚’æƒé™¤ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚„ã‚Šç›´ã—æ™‚ã®äºŒé‡ç”Ÿæˆé˜²æ­¢ï¼‰
  const old = document.querySelector('.num-under');
  if(old) old.remove();

  // ãƒ¬ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¦ã‚¢ã‚¤ãƒ†ãƒ åˆ—ã®ç›´ä¸‹ã«æŒ¿å…¥
  const under = document.createElement('div');
  under.className = 'num-under';
  itemsBar.insertAdjacentElement('afterend', under);

  // æœªä½¿ç”¨æ•°å­—ã‹ã‚‰å¿…è¦æšæ•°ã¶ã‚“æŠ½é¸
  const need  = items.length * eachCount;
  const picks = pickUnusedNumbers(need);

  // ã‚¢ã‚¤ãƒ†ãƒ æ•°ã«åˆã‚ã›ã¦åŒæ•°ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”¨æ„ã—ã€ä¸­å¤®ã«ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®
  let p = 0;
  items.forEach(()=> {
    const slot = document.createElement('div');
    slot.className = 'slot';
    under.appendChild(slot);

    for(let k=0; k<eachCount; k++){
      const n = picks[p++]; if(n==null) break;
      // placeNumberCard ã¯ holder ã‚’ä½œã£ã¦ mountParent ã«è¿½åŠ ã™ã‚‹
      placeNumberCard(n, slot);
    }
  });
}


/* â˜…â˜…â˜… èµ¤/é»„ã‚³ãƒ¼ãƒ‰æŠ½é¸ãƒ˜ãƒ«ãƒ‘ãƒ¼ â˜…â˜…â˜… */
function pickK(arr, k){
  const a = arr.slice(); shuffle(a);
  return a.slice(0, Math.max(0, Math.min(k, a.length)));
}

/**
 * ãƒŸãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®ã€Œèµ¤/é»„ã®æ··å…¥ä»•æ§˜ã€ã‚’ã“ã“ã§å®šç¾©
 */
function buildMixPlan(missionId){
  const plans = {
    9:  [
      {type:'redPick',    k:1},
      {type:'yellowPick', k:2},
    ],
    10: [
      {type:'redPick',    k:1},
      {type:'yellowPick', k:4},
    ],
    11: [
      {type:'redPick',    k:2},
    ],
    12: [
      {type:'redPick',    k:1},
      {type:'yellowPick', k:4},
    ],
  13: [ /* #13 ã¯å°‚ç”¨é…å¸ƒã‚’ã™ã‚‹ã®ã§ã“ã“ã§ã¯èµ¤ã‚’æ··ãœãªã„ */ ],
  14: [
    {type:'redPick', k:2},
    {type:'yellowChoose', from:3, take:2},
  ],
  15: [
    {type:'redChoose', from:3, take:1},
  ],
  16: [
    {type:'redPick', k:1},
    {type:'yellowChoose', from:3, take:2},
  ],
  17: [
    {type:'redChoose', from:3, take:2},
  ],
  18: [
    {type:'redPick', k:2},
  ],
  19: [
    {type:'redPick', k:1},
    {type:'yellowChoose', from:3, take:2},
  ],
  20: [
    {type:'redPick', k:2},
    {type:'yellowPick', k:2},
  ],
  21: [
    {type:'redChoose', from:3, take:1},
  ],
  22: [
    {type:'redPick',    k:1},
    {type:'yellowPick', k:4},
  ],
};
return plans[missionId] || [];

}

/**
 * ãƒŸãƒƒã‚¯ã‚¹å®Ÿè¡Œ
 */
function executeMixPlan(planList){
  const toAdd = [];
  const mixLines = [];
  const chooseLines = [];

  planList.forEach(p=>{
    if(p.type==='redPick'){
      const cand = pickK(MATERIALS.redCodes, p.k);
      cand.forEach(n=> toAdd.push({num:n, kind:'red'}));
      mixLines.push('èµ¤' + cand.map(v=>`[${v}]`).join(''));
    }
    if(p.type==='yellowPick'){
      const cand = pickK(MATERIALS.yellowCodes, p.k);
      cand.forEach(n=> toAdd.push({num:n, kind:'yellow'}));
      mixLines.push('é»„' + cand.map(v=>`[${v}]`).join(''));
    }
    if(p.type==='redChoose'){
      const cand = pickK(MATERIALS.redCodes, p.from);
      chooseLines.push(`èµ¤ã‚³ãƒ¼ãƒ‰ ${cand.map(v=>`[${v}]`).join(' ')} ã®ã†ã¡${p.take}ã¤`);
      const take = pickK(cand, p.take);
      take.forEach(n=> toAdd.push({num:n, kind:'red'}));
    }
    if(p.type==='yellowChoose'){
      const cand = pickK(MATERIALS.yellowCodes, p.from);
      chooseLines.push(`é»„ã‚³ãƒ¼ãƒ‰ ${cand.map(v=>`[${v}]`).join(' ')} ã®ã†ã¡${p.take}ã¤`);
      const take = pickK(cand, p.take);
      take.forEach(n=> toAdd.push({num:n, kind:'yellow'}));
    }
  });

  return { toAdd, mixLines, chooseLines };
}

/* pop positioning */
function placeInsideViewport(div, x, y){
  popLayer.appendChild(div);
  const pad = 8;
  pos(div, x + 6, y + 6);
  let r = div.getBoundingClientRect();
  if (r.right > innerWidth - pad){ const nx = Math.max(pad, x - r.width - 6); pos(div, nx, y + 6); r = div.getBoundingClientRect(); }
  if (r.left < pad) pos(div, pad, r.top);
  if (r.top < pad) pos(div, r.left, pad);
  if (r.bottom > innerHeight - pad) pos(div, r.left, Math.max(pad, innerHeight - r.height - pad));
}
function openOneMini(x,y,label,cb){
  const div=document.createElement('div'); div.className='mini-pop';
  div.addEventListener('click', e=>e.stopPropagation());
  const b=document.createElement('button'); b.className='btn small'; b.textContent=label;
  b.onclick=()=>{ if(div.isConnected) div.remove(); cb&&cb(); };
  div.appendChild(b); placeInsideViewport(div,x,y);
}
function openMenu(x,y, entries){
  const div=document.createElement('div'); div.className='mini-pop';
  div.addEventListener('click', e=>e.stopPropagation());
  entries.forEach(ent=>{ const b=document.createElement('button'); b.className='btn small'; b.textContent=ent.label; b.onclick=async ()=>{ if(div.isConnected) div.remove(); await ent.action?.(); }; div.appendChild(b); });
  placeInsideViewport(div, x, y);
}
function openBottomMenu(entries){
  const div=document.createElement('div'); div.className='mini-pop bottom-pop';
  div.addEventListener('click', e=>e.stopPropagation());
  entries.forEach(ent=>{ const b=document.createElement('button'); b.className='btn small'; b.textContent=ent.label; b.onclick=async ()=>{ if(div.isConnected) div.remove(); await ent.action?.(); }; div.appendChild(b); });
  popLayer.appendChild(div);
}

/* enter */
btnRandom.onclick = ()=>{ inputCode.value = String(Math.random()*1e4|0).padStart(4,'0'); };
btnJoin.onclick   = ()=>{
  const nm = (inputName?.value || '').trim();
  // â˜…åå‰ã¯4æ–‡å­—ä»¥å†…ã€‚æœªå…¥åŠ›ãªã‚‰ã²ã‚‰ãŒãª4æ–‡å­—ã‚’è‡ªå‹•æ¡ç•ª
  state.userName = nm ? nm.slice(0,4) : hiragana(4);
  enter('player');
};


async function enter(mode){
  const code=(inputCode.value||"").trim();
  if(!code){ alert('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  state.roomCode = code; state.mode=mode;

  const roomRef = ref(db, `rooms/${code}`);
  const snap=await get(roomRef);
  if(!snap.exists()){ state.isHost=true; await set(roomRef, baseRoom(state.userId)); }
  else{ state.isHost = snap.val()?.hostId === state.userId; }

  await set(ref(db, `rooms/${code}/players/${state.userId}`), {name:state.userName, at:Date.now()});
  onDisconnect(ref(db, `rooms/${code}/players/${state.userId}`)).remove();
  listenRoom(code);

  H(joinBox,true); H(lobby,false); H(gear,false); updateHeaderInfo();
}
function updateHeaderInfo(){ roomInfo.textContent = state.roomCode ? `ã‚³ãƒ¼ãƒ‰ï¼š${state.roomCode}ã€€/ã€€ã‚ãªãŸï¼š${state.userName}` : ''; }

/* room base */
function baseRoom(hostId){
  return { createdAt: Date.now(), hostId, started:false, tableCount:0, tables:[], items:[], di:{value:0,max:6}, captainTable:null, mission:null,
    players:{}, spectators:{},
    meta:{ itemUses:{i1:0,i2:0,i12:0,i14:0}, tokenCounts:{equal:0,noteq:0,x1:0}, i2Flow:null, i18Flow:null, i16Badge:null } };
}

/* watch */
function listenRoom(code){
  onValue(ref(db, `rooms/${code}`),(snap)=>{
    const v=snap.val(); state.watching=v;
if (v) {
  const p = Object.keys(v.players || {}).length;
  const s = Object.keys(v.spectators || {}).length;
  const empty = (p === 0 && s === 0);
  const justCreated = (Date.now() - (v.createdAt || 0) < 2000); // ä½œæˆã‹ã‚‰2ç§’ä»¥å†…ã¯å‰Šé™¤ã—ãªã„
  if (empty && !justCreated) {
    remove(ref(db, `rooms/${code}`));
    return;
  }
}    H(listsBox, !!v?.started);
    renderLists(v); renderItemsAndDi(v); renderTables(v); renderMissionPanels(v); renderGlobalReveal(v); renderHostTool(v);
    state.gameStarted=!!v?.started;

    // â–¼ ãƒ›ã‚¹ãƒˆåˆ¤å®šã‚’æœ€æ–°åŒ–
    state.isHost = (v?.hostId === state.userId);

    H(btnStart, !(state.isHost && !state.gameStarted));
    H(startHint, !(state.isHost && !state.gameStarted));

    // â–¼ ãƒ›ã‚¹ãƒˆä»¥å¤–ã«ã¯ã€ŒãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’é¸ã¶ã€ãƒœã‚¿ãƒ³è‡ªä½“ã‚’éè¡¨ç¤º
    H(btnPickMission, !state.isHost);

    // â–¼ è¿½åŠ ï¼šãƒ›ã‚¹ãƒˆãªã‚‰é–‹å§‹å‰å¾Œã„ã¤ã§ã‚‚ã‚¯ã‚¤ãƒƒã‚¯ãƒ”ãƒƒã‚«ãƒ¼ã‚’ä½¿ãˆã‚‹
    updateHeaderInfo();

  });
}


/* mission panels */
function renderMissionPanels(v){
  if(!v?.mission){
    missionTitle.textContent='ï¼ˆæœªé¸æŠï¼‰';
    missionText.textContent='é–‹å§‹æ™‚ã«äººæ•°ã¨ä¸€ç·’ã«é¸ã³ã¾ã™';
    missionDetailTitle.textContent=''; missionDetailBody.innerHTML='';
    H(missionFooter,true); H(missionBox,false); return;
  }
  missionDetailTitle.textContent = v.mission.display?.[0] || '';
  missionDetailBody.innerHTML = (v.mission.display||[]).slice(1).map(line=>`<div class="line">${line}</div>`).join('');
  H(missionFooter, !v.started); H(missionBox, !!v.started);
}

/* lists */
function renderLists(v){
  playersEl.innerHTML=''; specsEl.innerHTML=''; if(!v) return;
  Object.values(v.players||{}).forEach(u=>{ const d=document.createElement('div'); d.className='name'; d.textContent=u.name||'(?)'; playersEl.appendChild(d); });
  Object.values(v.spectators||{}).forEach(u=>{ const d=document.createElement('div'); d.className='name muted'; d.textContent=u.name||'(?)'; specsEl.appendChild(d); });
}

/* ===== Items & DI ===== */
function renderItemsAndDi(v){
  if(!v || !v.started){ H(itemsBar,true); return; }
  H(itemsBar,false);

  itemsEl.innerHTML='';
  const itemNodes = []; // â˜… ãƒãƒ¼ãƒ‰å‚ç…§ã‚’ä¿æŒ

  (v.items||[]).forEach((it, idx)=>{
    const flags = v?.mission?.flags || {};
    const div=document.createElement('div'); div.className='item' + (it.used?' used':'');
    if(!it.used){
      // #15: æœ€åˆã¯è£å‘ãè¡¨ç¤ºï¼ˆä½¿ç”¨å¯ã ãŒ faceUp===false ã®é–“ã¯è£é¢ã‚¢ãƒ¼ãƒˆã‚’è¡¨ç¤ºï¼‰
      if(flags.itemsFaceDownStart && it.faceUp===false){
        div.style.backgroundImage = `url("./itemback.jpg")`;
      }else{
        div.style.backgroundImage = `url("./item${it.no}.jpg")`;
      }
    }


 // â˜… è¿½åŠ ï¼šã‚¢ã‚¤ãƒ†ãƒ 16ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚«ãƒ¼ãƒ‰ã®çœŸä¸‹ã«è¡¨ç¤º
if(it.no===16 && v?.meta?.i16Badge && v.meta.i16Badge.num!=null){
  const below = document.createElement('div');
  below.className = 'i16-below';
  const tok = document.createElement('div');
  tok.className = 'token black';
  tok.textContent = String(v.meta.i16Badge.num);
  tok.title = 'ã‚¯ãƒªãƒƒã‚¯ã§æ“ä½œ';
  tok.onclick = (ev)=>{
    openMenu(ev.clientX, ev.clientY, [
      {label:'æ¶ˆã™', action: async ()=>{ await update(ref(db, `rooms/${state.roomCode}/meta`), { i16Badge: null }); }}
    ]);
  };
  below.appendChild(tok);
  div.appendChild(below);

  // è¿½åŠ ï¼šã‚«ãƒ¼ãƒ‰ã‚’ä¸Šã«æŒã¡ä¸Šã’ã¦ä¸‹ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ã§è¦‹ãˆã‚‹ã‚ˆã†ã«
  div.classList.add('i16-lift');
}

    div.onclick=(ev)=>{
      const flags = state.watching?.mission?.flags || {};
      if(it.used){
        openOneMini(ev.clientX, ev.clientY, 'è¡¨ã«ã™ã‚‹', async ()=>{
          await update(ref(db, `rooms/${state.roomCode}/items/${idx}`), {used:false});
        });
      }else{
        // æœªä½¿ç”¨æ™‚ï¼š#15 ã®ã€Œè¡¨ã«ã™ã‚‹ã€ã‚’è¿½åŠ ã—ã€å¿…è¦ãªã‚‰ä½µè¨˜
        const entries = [];

        if(flags.itemsFaceDownStart && it.faceUp===false){
          entries.push({
            label:'è¡¨ã«ã™ã‚‹',
            action: async ()=>{
              await update(ref(db, `rooms/${state.roomCode}/items/${idx}`), { faceUp:true });
            }
          });
        }

        entries.push({
          label:'ä½¿ç”¨ã™ã‚‹',
          action: async ()=>{
            await update(ref(db, `rooms/${state.roomCode}/items/${idx}`), {used:true});
            const path=`rooms/${state.roomCode}/meta/itemUses`;
            const uses = state.watching?.meta?.itemUses || {i1:0,i2:0,i12:0,i14:0};
            if(it.no===1)  await update(ref(db, path), {i1:(uses.i1||0)+1});
            if(it.no===2)  await update(ref(db, path), {i2:(uses.i2||0)+1});
            if(it.no===12) await update(ref(db, path), {i12:(uses.i12||0)+1});
            if(it.no===14) await update(ref(db, path), {i14:(uses.i14||0)+1});

            if(it.no===2){
              await update(ref(db, `rooms/${state.roomCode}/meta`), { i2Flow:{usingBy:state.userId, phase:'pickSelf', selA:null, selB:null} });
            }
            if(it.no===13){ await addTwoItemsFromDeck(); }
            if(it.no===16){ await handleItem16(idx); }
            if(it.no===18){ await update(ref(db, `rooms/${state.roomCode}/meta`), { i18Flow:{usingBy:state.userId, phase:'pickOther', sel:null} }); }
          }
        });

        openMenu(ev.clientX, ev.clientY, entries);
      }
    };


    itemsEl.appendChild(div);
    itemNodes.push(div);
  });


  const val = clamp(v.di?.value ?? v.tableCount, 0, 6);
  diEl.style.backgroundImage = `url("./di${val}.png")`;
  diEl.onclick=(ev)=>{
    openMenu(ev.clientX, ev.clientY, [
      {label:'é€²ã‚ã‚‹', action: async ()=>{ const nowv=state.watching?.di?.value ?? val; const next=clamp(nowv-1,0,6); await update(ref(db, `rooms/${state.roomCode}/di`), {value:next}); }},
      {label:'æˆ»ã™', action: async ()=>{ const nowv=state.watching?.di?.value ?? val; const next=clamp(nowv+1,0,6); await update(ref(db, `rooms/${state.roomCode}/di`), {value:next}); }},
    ]);
  };
}

/* ===== Global badge (item16) ===== */
function renderGlobalReveal(v){
  // å¤‰æ›´ï¼šã‚µã‚¤ãƒ‰è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆãŸãŸã‚å¸¸ã«éè¡¨ç¤º
  globalReveal.innerHTML='';
  H(globalReveal,true);
}

/* ===== Host tool (odd-open normal codes) ===== */
function renderHostTool(v){
  if(!v?.tables){ H(hostTool,true); return; }
  const openCountByNum = {};
  (v.tables||[]).forEach(T=>{
    (T.hand||[]).forEach(c=>{
      if(c?.kind==='normal' && c.open===true){
        const n = c.num|0;
        openCountByNum[n] = (openCountByNum[n]||0) + 1;
      }
    });
  });
  const hasOdd = Object.values(openCountByNum).some(cnt => (cnt % 2)===1);
  H(hostTool, !hasOdd);
}
hostTool.onclick = ()=> alert('å…¨ä½“å…¬é–‹ã•ã‚Œã¦ã„ã‚‹é€šå¸¸ã‚³ãƒ¼ãƒ‰ã®æšæ•°ã«å¥‡æ•°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚');

/* ===== Tables ===== */
function renderTables(v){
  tablesEl.innerHTML=''; if(!v) return;

  /* â˜… å…¨ä½“å…¬é–‹ä¸­ã®é€šå¸¸ã‚³ãƒ¼ãƒ‰ã®ã€Œæ•°å­—åˆ¥æšæ•°ã€ã‚’é›†è¨ˆ */
  const openCountByNum = {};
  (v.tables||[]).forEach(T=>{
    (T.hand||[]).forEach(c=>{
      if(c?.kind==='normal' && c.open===true){
        const n = c.num|0; // 1..12
        openCountByNum[n] = (openCountByNum[n]||0) + 1;
      }
    });
  });

  /* â˜… ãƒ†ãƒ¼ãƒ–ãƒ«1ã®çœŸä¸Šã«ãƒã‚§ãƒƒã‚¯è¡¨ï¼ˆ1..12ï¼‰ã‚’è¨­ç½® */
  if((v.tables||[]).length>0){
    const cl = document.createElement('div'); cl.className='checklist';
    for(let n=1; n<=12; n++){
      const cell = document.createElement('div'); cell.className='check-item';
      cell.textContent = String(n);
      if((openCountByNum[n]||0) === 4){ // åŒã˜æ•°å­—ãŒ4æœ¬å…¨ä½“å…¬é–‹
        const mk = document.createElement('div'); mk.className='check-mark';
        cell.appendChild(mk);
      }
      cl.appendChild(cell);
    }
    tablesEl.appendChild(cl); // â† ç›´å¾Œã«ãƒ†ãƒ¼ãƒ–ãƒ«1ãŒæ¥ã‚‹ã®ã§ã€ŒçœŸä¸Šã€ã«ãªã‚‹
  }

  const W = cssNum('--card-w'), G = cssNum('--card-gap'), CW = cssNum('--char-w');
  const seatedAny = (v.tables||[]).some(T => !!T.playerId);
  // â˜… å¤‰æ›´ï¼šä¸Šé™ã®å¯¾å¿œ
  //   ï¼ ã®ä¸Šé™ã¯ã‚¢ã‚¤ãƒ†ãƒ 12ã®ä½¿ç”¨å›æ•°
  //   â‰  ã®ä¸Šé™ã¯ã‚¢ã‚¤ãƒ†ãƒ 1ã®ä½¿ç”¨å›æ•°
  const uses = v.meta?.itemUses || {i1:0,i2:0,i12:0,i14:0};
  const caps = { 
    equal: uses.i12>=2 ? 4 : (uses.i12>=1 ? 2 : 0),
    noteq: uses.i1>=2  ? 4 : (uses.i1>=1  ? 2 : 0),
    x1:    uses.i14>=2 ? 2 : (uses.i14>=1 ? 1 : 0)
  };
  const counts = v.meta?.tokenCounts || {equal:0,noteq:0,x1:0};
  const i2All=v.meta?.i2Flow;
  const i18All=v.meta?.i18Flow;

  (v.tables||[]).forEach((t, idx)=>{
    const box=document.createElement('div'); box.className='table';
    box.addEventListener('mouseenter', ()=> box.classList.add('elevated'));
    box.addEventListener('mouseleave', ()=> {
      const hasTokenLater = (t.hand||[]).some(c=> (c.tokens||[]).length>0);
      if(!hasTokenLater) box.classList.remove('elevated');
    });

    const n = (t.hand||[]).length;
    const handInner = n>0 ? (n*W + (n-1)*G) : 0;
    const totalW = CW + 8 + handInner + 16;
    box.style.width = Math.max(totalW, CW + 16) + 'px';

const header=document.createElement('div'); header.className='t-header';
const title=document.createElement('div');  title.className='title';
title.textContent = t.playerName ? t.playerName : String(t.titleNumber ?? (idx+1));
header.appendChild(title); 



    
// #13ï¼šåˆæœŸæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæ•°å€¤ï¼‰â€”â€” è¡¨ç¤ºã¯ã‚­ãƒ£ãƒ©ä¸‹ã€ã“ã“ã§ã¯å€¤ã¨ auto-hide ã ã‘æ‰±ã†
let m13HeaderNum = null;
if (v.mission?.flags?.m13_headerRandomInfoToken && Array.isArray(v.meta?.m13_header)) {
  const headerNums = v.meta.m13_header;
  const n0 = headerNums[idx];
  if (n0 != null) {
    m13HeaderNum = n0;

// åŒãƒ†ãƒ¼ãƒ–ãƒ«å†…ã§åŒã˜æ•°å­—ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆtype:'num'ï¼‰ãŒä½¿ã‚ã‚ŒãŸã‚‰è‡ªå‹•ã§æ¶ˆã™
// â€» ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã«DBæ›´æ–°ã—ãªã„ï¼šå¯¾è±¡indexã ã‘ã‚­ãƒ¥ãƒ¼ã¸ç©ã‚€
if (v.mission?.flags?.m13_autoHideHeaderToken) {
  let used = false;
  (t.hand || []).forEach(c => {
    (c.tokens || []).forEach(tk => {
      if (tk?.type === 'num') {
        const n = parseInt(tk.value, 10);
        if (Number.isInteger(n) && n === n0) used = true;
      }
    });
  });
  if (used) {
    const current = (state.watching?.meta?.m13_header || [])[idx];
    if (current === n0) {
      if (!m13HeaderClearIndices) m13HeaderClearIndices = new Set();
      m13HeaderClearIndices.add(idx);
    }
  }
}

  }
}
box.appendChild(header);


    const content=document.createElement('div'); content.className='t-content';

// â˜… ã‚­ãƒ£ãƒ©ï¼‹ä¸‹éƒ¨ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ#13ï¼‰ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼
const charCol = document.createElement('div'); 
charCol.className = 'char-col';

const char=document.createElement('div'); 
char.className='char-card';
if(!seatedAny){ 
  char.classList.add('blank'); 
}else{
  const face = t.character?.flipped ? './battery.jpg' : `./${t.character?.face || 'member (1).jpg'}`;
  char.style.backgroundImage = `url("${face}")`;
  char.onclick=async ()=>{ 
    await update(ref(db, `rooms/${state.roomCode}/tables/${idx}/character`), {flipped: !t.character?.flipped}); 
  };
}
charCol.appendChild(char);

// â˜… #13ï¼šåˆæœŸæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚­ãƒ£ãƒ©ã®ã€Œä¸‹ã€ã«å°ã•ãè¡¨ç¤ºï¼ˆmeta.m13_header ã‚’ãã®ã¾ã¾ä½¿ã†ï¼‰
if (m13HeaderNum != null) {
  const tok = document.createElement('div');
  tok.className = 'token black';
  tok.textContent = String(m13HeaderNum);
  charCol.appendChild(tok);
}
if (Array.isArray(t.m22Tokens) && t.m22Tokens.length > 0) {
  const row = document.createElement('div');
  row.className = 'm22-under';
  t.m22Tokens.slice(0,2).forEach(nn=>{
    const d = document.createElement('div');
    d.className = 'token black';
    d.textContent = String(nn);
    d.title = 'ã‚¯ãƒªãƒƒã‚¯ã§æ¶ˆã™';
    d.onclick = async (ev)=>{
      ev.stopPropagation();
      const next = (t.m22Tokens || []).filter(x => x !== nn);
      await update(ref(db, `rooms/${state.roomCode}/tables/${idx}`), { m22Tokens: next });
    };
    row.appendChild(d);
  });
  charCol.appendChild(row);
}
content.appendChild(charCol);


    const hand=document.createElement('div'); hand.className='hand';
    (t.hand||[]).forEach((c,ci)=>{
      const wrap=document.createElement('div'); wrap.className='card-wrap';
      const card=document.createElement('div'); card.className='card';
      const isMine = c.ownerId === state.userId;
      if(!isMine && !c.open) card.classList.add('back');
      if(c.open) card.classList.add('open');

      if (i2All?.selA && i2All.selA.cardId===c.id && i2All.selA.table===idx){ const m = document.createElement('div'); m.className='marker'; m.textContent='â–¼'; wrap.appendChild(m); }
      if (i2All?.selB && i2All.selB.cardId===c.id && i2All.selB.table===idx){ const m = document.createElement('div'); m.className='marker'; m.textContent='â–¼'; wrap.appendChild(m); }
      if (i18All?.sel && i18All.sel.cardId===c.id && i18All.sel.table===idx){ const m=document.createElement('div'); m.className='marker'; m.textContent='â–¼'; wrap.appendChild(m); }
      if(c.markUntil && now()<c.markUntil){ const m=document.createElement('div'); m.className='marker'; m.textContent='â–¼'; wrap.appendChild(m); }

      const isI2Actor = i2All && i2All.usingBy===state.userId;
      const canPickSelf  = isI2Actor && i2All?.phase==='pickSelf'  && t.playerId===state.userId;
      const canPickOther = isI2Actor && i2All?.phase==='pickOther' && t.playerId!==state.userId;

      const isI18Actor = i18All && i18All.usingBy===state.userId;
      const canI18Pick = isI18Actor && i18All?.phase==='pickOther' && t.playerId!==state.userId;

      if(isI2Actor && (canPickSelf || canPickOther)){
        card.classList.add('i2-selectable');
        card.onclick = async (ev)=>{
          ev.stopPropagation();
          if(canPickSelf){
            await update(ref(db, `rooms/${state.roomCode}/meta/i2Flow`), { selA:{table:idx, cardId:c.id}, phase:'pickOther' });
          }else if(canPickOther){
            await update(ref(db, `rooms/${state.roomCode}/meta/i2Flow`), { selB:{table:idx, cardId:c.id} });
            openBottomMenu([
              {label:'äº¤æ›ã™ã‚‹', action: async ()=>{
                const i2 = (await get(ref(db, `rooms/${state.roomCode}/meta/i2Flow`))).val();
                if(i2?.selA && i2?.selB) await doItem2Swap(i2.selA, i2.selB);
              }},
              {label:'ã‚„ã‚Šç›´ã™', action: async ()=>{
                await update(ref(db, `rooms/${state.roomCode}/meta`), { i2Flow:{usingBy:state.userId, phase:'pickSelf', selA:null, selB:null} });
              }}
            ]);
          }
        };
      }else if(canI18Pick){
        card.classList.add('i2-selectable');
        card.onclick = async (ev)=>{
          ev.stopPropagation();
          await update(ref(db, `rooms/${state.roomCode}/meta/i18Flow`), { sel:{table:idx, cardId:c.id} });
          openBottomMenu([
            {label:'ã¨ã‚‹', action: async ()=>{ const i18=(await get(ref(db, `rooms/${state.roomCode}/meta/i18Flow`))).val(); if(i18?.sel) await doItem18Take(i18.sel); }},
            {label:'ã‚„ã‚Šç›´ã™', action: async ()=>{ await update(ref(db, `rooms/${state.roomCode}/meta/i18Flow`), { sel:null, phase:'pickOther' }); }}
          ]);
        };
      }else{
        card.onclick = async ()=>{
          if(isMine){
            const blockingI2 = i2All && i2All.usingBy===state.userId && (i2All.phase==='pickSelf' || i2All.phase==='pickOther');
            const blockingI18= i18All && i18All.usingBy===state.userId && (i18All.phase==='pickOther');
            if(blockingI2 || blockingI18) return;
            await update(ref(db, `rooms/${state.roomCode}/tables/${idx}/hand/${ci}`), {open: !c.open});
          }
        };
      }

      const num=document.createElement('div'); num.className='num';
      num.textContent=String(c.num);
      num.style.visibility = (c.open || isMine) ? 'visible' : 'hidden';
      card.appendChild(num);

      const bot=document.createElement('div'); bot.className='img-bottom';
      let img='codenumber.jpg'; if(c.kind==='red') img='redcode.png'; if(c.kind==='yellow') img='yellowcode.png';
      bot.style.backgroundImage=`url("./${img}")`; if(card.classList.contains('back')) bot.style.display='none';
      card.appendChild(bot);

      const badge=document.createElement('div'); badge.className='badge-fixed';
      const a=document.createElement('div'); a.className='alpha'; a.textContent=c.alpha||'';

      const col=document.createElement('div'); col.className='tok-col';
 (c.tokens||[]).forEach(tk=>{
  const el = document.createElement('div');
  el.className = 'token ' + (tk.style || '');
  col.appendChild(el);

  const tokenText = (t)=>{
    switch(t.type){
      case 'equal':  return 'ï¼';   // = ãƒˆãƒ¼ã‚¯ãƒ³
      case 'noteq':  return 'â‰ ';   // â‰  ãƒˆãƒ¼ã‚¯ãƒ³
      case 'x1':     return 'x1';  // x1
      case 'x2':     return 'x2';  // x2ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³å°‚ç”¨ï¼‰
      case 'x3':     return 'x3';  // x3ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³å°‚ç”¨ï¼‰
      case 'yellow': return 'â–§';   // é»„ã‚³ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆâ–§ï¼‰
      case 'even':   return '2/4'; // å¶æ•°
      case 'odd':    return '1/3'; // å¥‡æ•°
      case 'xmark':  return 'âœ•';   // ãƒŸãƒƒã‚·ãƒ§ãƒ³#20ã®é»„è‰²âœ•ç”¨
      case 'num':    return String(t.value); // æ•°å­—
      default:       return String(t.value ?? '');
    }
  };

  el.textContent = tokenText(tk);
});


      if(!(i2All && i2All.usingBy===state.userId) && !(i18All && i18All.usingBy===state.userId) && isMine){
        a.onclick=(ev)=>{
          ev.stopPropagation();
          const cardPath  = `rooms/${state.roomCode}/tables/${idx}/hand/${ci}`;
          const tokens = c.tokens || [];
          const has = (type)=> tokens.some(tk=>tk.type===type);

          const canEqual = !has('equal') && (counts.equal < caps.equal);
          const canNoteq = !has('noteq') && (counts.noteq < caps.noteq);
          const canNum   = !has('num');
          const canX1    = !has('x1') && (counts.x1 < caps.x1);

         const entries = [];

// â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³å°‚ç”¨ï¼šãƒ•ãƒ©ã‚°å–å¾—
const flags = state.watching?.mission?.flags || {};
const myHand = (t.hand||[]).filter(cc => cc.ownerId===state.userId);
const countSame = myHand.filter(cc => cc.num===c.num).length;

// é»„ã‚³ãƒ¼ãƒ‰ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆâ–§ï¼‰
if(flags.useYellowToken){
  entries.push({label:'â–§', action: async ()=>{
    const updated=[...(tokens), {type:'yellow', value:'â–§', style:'yellow'}];
    await update(ref(db, cardPath), { tokens: updated });
    box.classList.add('elevated');
  }});
}

// x1/x2/x3ï¼ˆæ•°å­—ãƒãƒƒãƒ—ã‚’å‡ºã•ãªã„ãƒŸãƒƒã‚·ãƒ§ãƒ³ç”¨ï¼‰
if(flags.useXTokens){
  if(countSame===1) entries.push({label:'x1', action: async ()=>{
    const updated=[...(tokens), {type:'x1', value:'x1', style:'x1'}];
    await update(ref(db, cardPath), { tokens: updated });
    box.classList.add('elevated');
  }});
  if(countSame===2) entries.push({label:'x2', action: async ()=>{
    const updated=[...(tokens), {type:'x2', value:'x2', style:'x2'}];
    await update(ref(db, cardPath), { tokens: updated });
    box.classList.add('elevated');
  }});
  if(countSame===3) entries.push({label:'x3', action: async ()=>{
    const updated=[...(tokens), {type:'x3', value:'x3', style:'x3'}];
    await update(ref(db, cardPath), { tokens: updated });
    box.classList.add('elevated');
  }});
}

// å¶æ•°/å¥‡æ•°ï¼ˆæ•°å­—ãƒãƒƒãƒ—ã‚’å‡ºã•ãªã„ãƒŸãƒƒã‚·ãƒ§ãƒ³ç”¨ï¼‰
if(flags.useParityToken){
  const isEven = (c.num % 2)===0;
  if(isEven){
    entries.push({label:'2/4', action: async ()=>{
      const updated=[...(tokens), {type:'even', value:'2/4', style:'even'}];
      await update(ref(db, cardPath), { tokens: updated });
      box.classList.add('elevated');
    }});
  }else{
    entries.push({label:'1/3', action: async ()=>{
      const updated=[...(tokens), {type:'odd', value:'1/3', style:'odd'}];
      await update(ref(db, cardPath), { tokens: updated });
      box.classList.add('elevated');
    }});
  }
}

const suppressNumberPop = !!flags.useYellowToken || !!flags.useXTokens || !!flags.useParityToken;

// â–¼ æ•°å­—ãƒãƒƒãƒ—ã®å‡ºã—æ–¹ï¼ˆé€šå¸¸ or #17 éšŠé•·ç”¨ï¼‰
const isCaptain = (state.watching?.captainTable|0) === idx;
if(!suppressNumberPop && canNum){
  if(v.mission?.flags?.m17_captainInverseNumberPop && isCaptain){
    // éšŠé•·ã¯ã€Œè‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰æ•°å€¤ ä»¥å¤–ã€ã® 1..12 ã‚’å€™è£œã«ã™ã‚‹
    for(let nn=1; nn<=12; nn++){
      if(nn===c.num) continue;
      entries.push({label:String(nn), action: async ()=>{
        const updated=[...(tokens), {type:'num', value:nn, style:'black'}];
        await update(ref(db, cardPath), { tokens: updated });
        box.classList.add('elevated');
      }});
    }
  }else{
    // é€šå¸¸ï¼šãã®ã‚«ãƒ¼ãƒ‰ã®æ•°å­—
    entries.push({label:String(c.num), action: async ()=>{
      const updated=[...(tokens), {type:'num', value:c.num, style:'black'}];
      await update(ref(db, cardPath), { tokens: updated });
      box.classList.add('elevated');
    }});
  }
}

          // ï¼ï¼ˆã‚¢ã‚¤ãƒ†ãƒ 12ç®¡ç†ï¼‰
          if (has('equal')) {
            entries.push({
              label:'ï¼',
              action: async ()=>{
                openMenu(ev.clientX, ev.clientY, [
                  { label:'æ¶ˆã™', action: async ()=>{
                      const next = tokens.filter(tk=>tk.type!=='equal');
                      await update(ref(db, cardPath), { tokens: next });
                      await incToken('equal', -1);
                      const afterHas = (t.hand||[]).some(cc => (cc.tokens||[]).length>0);
                      box.classList.toggle('elevated', afterHas);
                    }},
                  { label:String(c.num), action: async ()=>{
                      if(!has('num')){
                        const next=[...(tokens), {type:'num', value:c.num, style:'black'}];
                        await update(ref(db, cardPath), { tokens: next });
                        box.classList.add('elevated');
                      }
                    }}
                ]);
              }
            });
          } else if (canEqual){
            entries.push({label:'ï¼', action: async ()=>{
              const updated=[...(tokens), {type:'equal', value:c.num, style:'equal'}];
              await update(ref(db, cardPath), { tokens: updated });
              await incToken('equal', +1);
              box.classList.add('elevated');
            }});
          }

          // â‰ ï¼ˆã‚¢ã‚¤ãƒ†ãƒ 1ç®¡ç†ï¼‰
          if (has('noteq')) {
            entries.push({
              label:'â‰ ',
              action: async ()=>{
                openMenu(ev.clientX, ev.clientY, [
                  { label:'æ¶ˆã™', action: async ()=>{
                      const next = tokens.filter(tk=> tk.type!=='noteq');
                      await update(ref(db, cardPath), { tokens: next });
                      await incToken('noteq', -1);
                      const afterHas = (t.hand||[]).some(cc => (cc.tokens||[]).length>0);
                      box.classList.toggle('elevated', afterHas);
                    }},
                  { label:String(c.num), action: async ()=>{
                      if(!has('num')){
                        const next=[...(tokens), {type:'num', value:c.num, style:'black'}];
                        await update(ref(db, cardPath), { tokens: next });
                        box.classList.add('elevated');
                      }
                    }}
                ]);
              }
            });
          } else if (canNoteq){
            entries.push({
              label:'â‰ ',
              action: async ()=>{
                const updated=[...(tokens), {type:'noteq', value:c.num, style:'noteq'}];
                await update(ref(db, cardPath), { tokens: updated });
                await incToken('noteq', +1);
                box.classList.add('elevated');
              }
            });
          }

          if(canX1){
            entries.push({label:'x1', action: async ()=>{
              const updated=[...(tokens), {type:'x1', value:c.num, style:'x1'}];
              await update(ref(db, cardPath), { tokens: updated });
              await incToken('x1', +1);
              box.classList.add('elevated');
            }});
          }
          if(has('x1')){
            entries.push({label:'x1', action: async ()=>{
              openMenu(ev.clientX, ev.clientY, [
                {label:'æ¶ˆã™', action: async ()=>{
                  const next = tokens.filter(tk=>tk.type!=='x1');
                  await update(ref(db, cardPath), { tokens: next });
                  await incToken('x1', -1);
                  const afterHas = (t.hand||[]).some(cc => (cc.tokens||[]).length>0);
                  box.classList.toggle('elevated', afterHas);
                }},
                {label:String(c.num), action: async ()=>{
                  if(!has('num')){
                    const next=[...(tokens), {type:'num', value:c.num, style:'black'}];
                    await update(ref(db, cardPath), { tokens: next });
                    box.classList.add('elevated');
                  }
                }},
              ]);
            }});
          }

          if(tokens.length>0){
            tokens.forEach((tk,ti)=>{
              const label = tk.type==='equal' ? 'ï¼ã‚’æ¶ˆã™' : tk.type==='noteq' ? 'â‰ ã‚’æ¶ˆã™' : tk.type==='x1' ? 'x1ã‚’æ¶ˆã™' : 'æ•°å­—ã‚’æ¶ˆã™';
              entries.push({label, action: async ()=>{
                const next = tokens.slice(); const removed = next.splice(ti,1)[0];
                await update(ref(db, cardPath), { tokens: next });
                if(removed?.type==='equal') await incToken('equal', -1);
                if(removed?.type==='noteq') await incToken('noteq', -1);
                if(removed?.type==='x1')    await incToken('x1', -1);
                const afterHas = (t.hand||[]).some(cc => (cc.tokens||[]).length>0);
                box.classList.toggle('elevated', afterHas);
              }});
            });
          }

          openMenu(ev.clientX, ev.clientY, entries);
        };
      }

      badge.appendChild(a);
      badge.appendChild(col);

      wrap.appendChild(card);
      wrap.appendChild(badge);
      hand.appendChild(wrap);
    });
    content.appendChild(hand);
    box.appendChild(content);

    const hasToken = (t.hand||[]).some(c=> (c.tokens||[]).length>0);
    box.classList.toggle('elevated', hasToken);

    tablesEl.appendChild(box);
  });

  /* â˜… #22ï¼šé»„ã‚«ãƒ¼ãƒ‰ãŒã€Œå…¬é–‹ã€ã•ã‚ŒãŸç¨®é¡ãŒ2ã¤ä»¥ä¸Šã«ãªã£ãŸç¬é–“ã«è¡¨ã‚’å‡ºã™ */
  if (v.mission?.flags?.m22_showTableAfter2Yellows) {
    const openYellowKinds = new Set();
    (v.tables||[]).forEach(T=>{
      (T.hand||[]).forEach(c=>{
        if(c?.kind==='yellow' && c.open===true){
          // åŒã˜é»„ã§ã‚‚ç•ªå·(ä¾‹: 3.1, 7.1)ãŒé•ãˆã°â€œç¨®é¡â€ã¯åˆ¥
          openYellowKinds.add(String(c.num));
        }
      });
    });

    const alreadyShown = !!v.meta?.m22_infoShown;
    if (openYellowKinds.size >= 2 && !alreadyShown) {
      // DBãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦é‡è¤‡è¡¨ç¤ºã‚’é˜²æ­¢
      update(ref(db, `rooms/${state.roomCode}/meta`), { m22_infoShown: true });
      showInfo22Panel(v); // ç›´ã¡ã«æç”»
    }
  }
  renderM22PickPanel(v);

  /* â–¼â–¼ è¿½åŠ ï¼š#22 è¡¨ã‚’æ—¢ã«è¡¨ç¤ºæ¸ˆã¿ãªã‚‰ã€æ¯å›å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦æœ€æ–°åŒ– â–¼â–¼ */
  if (v.meta?.m22_infoShown) {
    showInfo22Panel(v);
  }
  // â–¼ #13 ãƒ˜ãƒƒãƒ€ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã®é…å»¶ä¸€æ‹¬æ›´æ–°ï¼ˆæ¬¡tickã§å®Ÿè¡Œ...ï¼‰
// â–¼ #13 ãƒ˜ãƒƒãƒ€ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã®é…å»¶ä¸€æ‹¬æ›´æ–°ï¼ˆæ¬¡tickã§å®Ÿè¡Œï¼‰
if (!m13HeaderUpdateScheduled && m13HeaderClearIndices && m13HeaderClearIndices.size > 0) {
  m13HeaderUpdateScheduled = true;
  setTimeout(async () => {
    try {
      const indices = Array.from(m13HeaderClearIndices);
      m13HeaderClearIndices = null;
      m13HeaderUpdateScheduled = false;

      // ç¾åœ¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼é…åˆ—ã‚’å–å¾—ã—ã¦ã€å¯¾è±¡ index ã‚’ null ã«ã™ã‚‹
      const snap = await get(ref(db, `rooms/${state.roomCode}/meta/m13_header`));
      const currentHeader = (snap.val() || []).slice();
      indices.forEach(i => {
        if (i >= 0 && i < currentHeader.length) currentHeader[i] = null;
      });

      await update(ref(db, `rooms/${state.roomCode}/meta`), { m13_header: currentHeader });
    } catch (e) {
      console.error('m13 header clear failed', e);
    }
  }, 0);
}

async function incToken(kind, delta){
  try {
    const path = `rooms/${state.roomCode}/meta/tokenCounts`;
    const snap = await get(ref(db, path));
    const prev = snap.val() || { equal:0, noteq:0, x1:0 };
    const next = { ...prev, [kind]: Math.max(0, (prev[kind] || 0) + delta) };
    await set(ref(db, path), next);
  } catch (e) {
    console.error('incToken failed', e);
  }
}

}
function renderM22PickPanel(v){
  if (!v?.mission?.id || v.mission.id !== 22) {
    if (m22PickPanel) m22PickPanel.classList.add('hidden');
    return;
  }
  // è‡ªåˆ†ãŒå¸­ã«åº§ã£ã¦ã„ãªã‘ã‚Œã°éš ã™
  const myIdx = (v.tables||[]).findIndex(T => T.playerId === state.userId);
  if (myIdx < 0) { if (m22PickPanel) m22PickPanel.classList.add('hidden'); return; }

  const myTable = v.tables[myIdx] || {};
  const myHandInts = new Set((myTable.hand||[])
    .filter(c => Number.isInteger(c.num))
    .map(c => c.num|0));

  // å€™è£œ = 1..12 ã‹ã‚‰æ‰‹æœ­ã«ç„¡ã„æ•°å­—
  const candidates = [];
  for (let n=1; n<=12; n++) if (!myHandInts.has(n)) candidates.push(n);

  const picked = Array.isArray(myTable.m22Tokens) ? myTable.m22Tokens.slice(0,2) : [];
  const pickedSet = new Set(picked);

  // æç”»
  m22PickPanel.innerHTML = '<span class="cap">æœªæ‰€æŒã®æ•°å­—ã‹ã‚‰æœ€å¤§2ã¤é¸æŠï¼š</span>';
  candidates.forEach(nn=>{
    const d = document.createElement('div');
    d.className = 'token black' + (pickedSet.has(nn) ? ' disabled' : '');
    d.textContent = String(nn);
    d.onclick = async ()=>{
      if (pickedSet.has(nn)) return;        // æ—¢ã«é¸æŠæ¸ˆã¿
      if (picked.length >= 2) return;       // ä¸Šé™
      const next = picked.concat(nn);
await update(ref(db, `rooms/${state.roomCode}/tables/${myIdx}`), { m22Tokens: next });
    };
    m22PickPanel.appendChild(d);
  });

  m22PickPanel.classList.remove('hidden');
}
/* === #22 ç”¨ï¼šæ•°å­—ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½¿ç”¨æ•°ã‚’é›†è¨ˆ === */
function countNumTokenUsage(n, v){
  const vv = v || state.watching;
  let used = 0;
  (vv?.tables || []).forEach(T=>{
    (T.hand || []).forEach(c=>{
      (c.tokens || []).forEach(tk=>{
        if (tk?.type === 'num' && parseInt(tk.value, 10) === n) used += 1;
      });
    });
  });
  return used;
}

/* === #22 ç”¨ï¼šæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ï¼ˆ3Ã—4ï¼‰ï¼šé»’ãƒˆãƒ¼ã‚¯ãƒ³ + x0/x1/x2 ã‚’æ¨ªä¸¦ã³è¡¨ç¤º === */
function showInfo22Panel(vNow){
  const exist = document.getElementById('info22');
  if (exist) exist.remove();

  const v = vNow || state.watching;
  if (!v) return;

  const div = document.createElement('div');
  div.id = 'info22';
  div.className = 'info22';

  for (let n=1; n<=12; n++){
    // ä½¿ç”¨æ•°ï¼ˆ2ä»¥ä¸Šã¯ 2 ã§æ‰“ã¡æ­¢ã‚ï¼‰
    const used = countNumTokenUsage(n, v);
const shown = 2 - Math.min(2, used);

    const cell = document.createElement('div');
    cell.className = 'cell';

    // é»’ãƒˆãƒ¼ã‚¯ãƒ³æœ¬ä½“ï¼ˆæ—¢å­˜ã® .token.black ã‚’å†åˆ©ç”¨ï¼‰
    const tok = document.createElement('div');
    tok.className = 'token black';
    tok.textContent = String(n);

    // å³å´ã® xãƒ©ãƒ™ãƒ«
    const xl = document.createElement('span');
    xl.className = 'xlabel';
    xl.textContent = `x${shown}`;

    cell.appendChild(tok);
    cell.appendChild(xl);

    cell.onclick = (ev)=>{
      const nextIdx = findNextSeatedPlayerIndex();
      if(nextIdx < 0){
        openOneMini(ev.clientX, ev.clientY, 'æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸åœ¨', ()=>{});
        return;
      }
      const name = state.watching.tables[nextIdx]?.playerName || `#${nextIdx+1}`;
      openMenu(ev.clientX, ev.clientY, [{
        label: `${name} ã« ${n} ã‚’æ¸¡ã™`,
        action: async ()=>{
          const snap = await get(ref(db,`rooms/${state.roomCode}/tables/${nextIdx}/m22Tokens`));
          const cur = snap.val() || [];
          if(!cur.includes(n)){
            await set(ref(db,`rooms/${state.roomCode}/tables/${nextIdx}/m22Tokens`), cur.concat(n));
          }
        }
      }]);
    };

    
    div.appendChild(cell);
  }

  document.body.appendChild(div);
}





/* ===== Item 2 swap ===== */
async function doItem2Swap(A, B){
  if(!A || !B) return;
  const snap = await get(ref(db, `rooms/${state.roomCode}/tables`));
  const tables = snap.val() || [];

  const pickCard = (tableIdx, cardId)=>{
    const hand = (tables[tableIdx]?.hand)||[];
    const i = hand.findIndex(c=> c.id===cardId);
    return {hand, index:i, card: i>=0 ? hand[i] : null};
  };

  const a = pickCard(A.table, A.cardId);
  const b = pickCard(B.table, B.cardId);
  if(!a.card || !b.card){ await update(ref(db, `rooms/${state.roomCode}/meta`), { i2Flow:null }); return; }

  a.hand.splice(a.index,1); b.hand.splice(b.index,1);

  const insertSortedLeft = (hand, card)=>{ const n = card.num; let pos = 0; while(pos<hand.length && hand[pos].num < n) pos++; while(pos>0 && hand[pos-1].num===n) pos--; hand.splice(pos,0,card); };

  const mark = now()+10000; // 10ç§’
  const toB = {...a.card, ownerId: tables[B.table].playerId || null, markUntil: mark};
  const toA = {...b.card, ownerId: tables[A.table].playerId || null, markUntil: mark};

  insertSortedLeft(b.hand, toB);
  insertSortedLeft(a.hand, toA);

  const realpha = (hand)=>{ const alpha='abcdefghijklmnopqrstuvwxyz'; hand.forEach((c,i)=> c.alpha = alpha[i%alpha.length]); };
  realpha(a.hand); realpha(b.hand);

  await Promise.all([
    set(ref(db, `rooms/${state.roomCode}/tables/${A.table}/hand`), a.hand),
    set(ref(db, `rooms/${state.roomCode}/tables/${B.table}/hand`), b.hand),
    update(ref(db, `rooms/${state.roomCode}/meta`), { i2Flow:null })
  ]);
}

/* ===== Item 18 take ===== */
async function doItem18Take(sel){
  const myTable = state.watching?.tables?.findIndex(t=> t.playerId===state.userId);
  if(myTable==null || myTable<0){ alert('å¸­ã«åº§ã£ã¦ã‹ã‚‰ä½¿ç”¨ã—ã¦ãã ã•ã„'); await update(ref(db, `rooms/${state.roomCode}/meta/i18Flow`), {sel:null, phase:'pickOther'}); return; }
  const snap = await get(ref(db, `rooms/${state.roomCode}/tables`));
  const tables = snap.val() || [];

  const srcHand = (tables[sel.table]?.hand)||[];
  const si = srcHand.findIndex(c=> c.id===sel.cardId);
  if(si<0){ await update(ref(db, `rooms/${state.roomCode}/meta/i18Flow`), {sel:null, phase:'pickOther'}); return; }
  const card = srcHand.splice(si,1)[0];

  const dstHand = (tables[myTable]?.hand)||[];
  const n = card.num;
  let pos = 0; while(pos<dstHand.length && dstHand[pos].num < n) pos++; while(pos>0 && dstHand[pos-1].num===n) pos--; 
  const mark = now()+10000;
  dstHand.splice(pos,0,{...card, ownerId: state.userId, markUntil: mark});

  const realpha = (hand)=>{ const alpha='abcdefghijklmnopqrstuvwxyz'; hand.forEach((c,i)=> c.alpha = alpha[i%alpha.length]); };
  realpha(dstHand); realpha(srcHand);

  await Promise.all([
    set(ref(db, `rooms/${state.roomCode}/tables/${sel.table}/hand`), srcHand),
    set(ref(db, `rooms/${state.roomCode}/tables/${myTable}/hand`), dstHand),
    update(ref(db, `rooms/${state.roomCode}/meta`), { i18Flow:null })
  ]);
}

/* ==== ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒƒã‚­åˆ¶å¾¡ï¼ˆãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ¥ï¼‰ ==== */

/* ã“ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã§é»„ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã†ã‹ï¼Ÿ */
function missionUsesYellow(missionId){
  const plan = buildMixPlan(missionId) || [];
  // yellowPick / yellowChoose ã‚’å«ã‚€ã‹ã€#2ï¼ˆé»„ã‚³ãƒ¼ãƒ‰ï¼‰ãªã‚‰ true
  return missionId===2 || plan.some(p => p.type==='yellowPick' || p.type==='yellowChoose');
}

/* ãƒŸãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®ã‚¢ã‚¤ãƒ†ãƒ é™¤å¤–ãƒªã‚¹ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½è¨˜ï¼‰ */
const ITEM_EXCLUSIONS = {
  // ä¾‹ï¼‰12: [3, 7],   // ãƒŸãƒƒã‚·ãƒ§ãƒ³12ã§ã¯ã‚¢ã‚¤ãƒ†ãƒ 3ã¨7ã‚’é™¤å¤–
};


    
/* ===== Item helpers ===== */
/* missionId ã¨ â€œé»„ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã†ã‹â€ã§å±±æœ­ã‚’æ±ºå®šã—ã€é™¤å¤–ã‚‚é©ç”¨ */
function itemDeckNumbers(missionId){
  // 43ä»¥é™ã¯ 1..18 ã‚’ä½¿ç”¨
  if(missionId >= 43){
    return Array.from({length:18}, (_,i)=> i+1);
  }

  // ã€œ42ã¯ 1..13ï¼ˆé»„ã‚³ãƒ¼ãƒ‰ã‚ã‚Šï¼‰ / 1..12ï¼ˆé»„ã‚³ãƒ¼ãƒ‰ãªã—ï¼‰
  const useYellow = missionUsesYellow(missionId);
  const maxNo = useYellow ? 13 : 12;
  let pool = Array.from({length:maxNo}, (_,i)=> i+1);

  // é™¤å¤–é©ç”¨
  const ex = ITEM_EXCLUSIONS[missionId] || [];
  if(ex.length){
    const exSet = new Set(ex);
    pool = pool.filter(n => !exSet.has(n));
  }
  return pool;
}


/* item13: è¿½åŠ ã§2æš */
async function addTwoItemsFromDeck(){
  const v = state.watching; if(!v) return;
  const missionId = v?.mission?.id || 0;

  // ãƒŸãƒƒã‚·ãƒ§ãƒ³è¦å‰‡ã«å¾“ã£ãŸãƒ—ãƒ¼ãƒ«
  const pool = itemDeckNumbers(missionId);

  // æ—¢å­˜ã¨é‡è¤‡ã—ãªã„ã‚‚ã®ã‹ã‚‰è¿½åŠ 
  const existingNos = new Set((v.items||[]).map(i=>i.no));
  const candidates = pool.filter(n=> !existingNos.has(n));
  shuffle(candidates);

  const pick = candidates.slice(0,2).map(no=>({id:crypto.randomUUID(), no, used:false}));
  if(pick.length===0) return;

  const next = (v.items||[]).concat(pick);
  await set(ref(db, `rooms/${state.roomCode}/items`), next);
}


/* item16: æ•°å­—(1..12)ã®ä½¿ç”¨æ•°ã‚’é›†è¨ˆã—ã€<2ã®æ•°å­—ã‹ã‚‰1ã¤é¸ã³ãƒ¡ã‚¿ã«ä¿å­˜ï¼ˆè¡¨ç¤ºã¯ã‚¢ã‚¤ãƒ†ãƒ 16å³å´ã§è¡Œã†ï¼‰ */
async function handleItem16(itemIdx){
  const v = state.watching; if(!v) return;

  const counts = Array.from({length:13}, ()=>0); // 1..12
  (v.tables||[]).forEach(T=>{
    (T.hand||[]).forEach(c=>{
      (c.tokens||[]).forEach(tk=>{
        if(tk?.type==='num'){
          const n = parseInt(tk.value, 10);
          if(n>=1 && n<=12) counts[n] += 1;
        }
      });
    });
  });

  const candidates = [];
  for(let n=1; n<=12; n++){
    if((counts[n]||0) < 2) candidates.push(n);
  }

  if(candidates.length===0){
    await update(ref(db, `rooms/${state.roomCode}/meta`), { i16Badge: null });
    return;
  }

  const pick = candidates[Math.floor(Math.random()*candidates.length)];
  await update(ref(db, `rooms/${state.roomCode}/meta`), { i16Badge: { num: pick, at: Date.now() } });
}

/* gear etc */
function updateMenuButtons(){
  const seated = state.seatedTable!=null;
  H(btnSit, seated);
  H(btnLeave, !seated);
  // â–¼ ãƒ›ã‚¹ãƒˆä»¥å¤–ã«ã¯ãƒŸãƒƒã‚·ãƒ§ãƒ³é¸æŠãƒœã‚¿ãƒ³ã‚’å‡ºã•ãªã„
  H(btnPickMission, !state.isHost);

  // â˜… #22ï¼šæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ã®å†è¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç”Ÿã‚„ã™ï¼ˆé‡è¤‡ç”Ÿæˆé˜²æ­¢ï¼‰
  const v = state.watching;
  const need = !!v?.mission?.flags?.m22_allowInfoTableFromMenu;
  const id  = 'btnShowInfo22';
  const old = document.getElementById(id);
  if (!need && old){ old.remove(); }
  if (need && !old){
    const b = document.createElement('button');
    b.className = 'btn'; b.id = id; b.textContent = 'æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ#22ï¼‰';
    b.onclick = ()=> showInfo22Panel(state.watching);
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å…ˆé ­ã«è¿½åŠ ï¼ˆSeatç³»ã®ä¸Šã‚ãŸã‚Šï¼‰
    menuPop.insertBefore(b, menuPop.firstChild || null);
  }
}

const outsideClose=(e,t)=>{ if(!t.contains(e.target)) H(t,true); };
function closeAllMini(e){ document.querySelectorAll('.mini-pop').forEach(pop=>{ if(!pop.contains(e.target)) pop.remove(); }); }
 document.addEventListener('click',(e)=>{ closeAllMini(e); outsideClose(e, menuPop); }, true);
gear.onclick=()=> { menuPop.classList.toggle('hidden'); if(!menuPop.classList.contains('hidden')) updateMenuButtons(); };

/* â˜… å…±é€šã®é›¢å¸­å‡¦ç† */
async function leaveSeatNow(){
  if(state.seatedTable==null || !state.watching?.tables) return;
  const idx=state.seatedTable; const hand=(state.watching.tables[idx].hand||[]);
  await update(ref(db, `rooms/${state.roomCode}/tables/${idx}`), {playerId:null, playerName:null});
  await Promise.all(hand.map((_,i)=> update(ref(db, `rooms/${state.roomCode}/tables/${idx}/hand/${i}`), {ownerId:null})));
  state.seatedTable=null; updateMenuButtons();
}

btnSit.onclick = ()=>{
  if(state.mode!=='player'){ alert('è¦³æˆ¦å…¥å®¤ã§ã¯å¸­ã«åº§ã‚Œã¾ã›ã‚“ã€‚å‚åŠ ã§å…¥ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚'); return; }
  const v=state.watching; if(!v?.started){ alert('ã‚²ãƒ¼ãƒ é–‹å§‹å¾Œã«å¸­ã‚’é¸ã¹ã¾ã™'); return; }
  seatTabs.innerHTML='';
  (v.tables||[]).forEach((t,i)=>{
    const tab=document.createElement('div'); tab.className='tab';
    tab.textContent = t.playerName ? `${i+1}ï¼ˆä½¿ç”¨ä¸­ï¼‰` : `${i+1}`;
    if(t.playerId) tab.classList.add('disabled');
    tab.onclick=async ()=>{
      if(tab.classList.contains('disabled')) return;
      await update(ref(db, `rooms/${state.roomCode}/tables/${i}`), {playerId:state.userId, playerName:state.userName});
      const hand=(v.tables[i].hand||[]);
      await Promise.all(hand.map((_,idx)=> update(ref(db, `rooms/${state.roomCode}/tables/${i}/hand/${idx}`), {ownerId:state.userId})));
      state.seatedTable=i; H(seatPop,true); updateMenuButtons();
    };
    seatTabs.appendChild(tab);
  });
  H(seatPop,false);
};
btnSeatCancel.onclick=()=> H(seatPop,true);

btnLeave.onclick = async ()=>{ await leaveSeatNow(); };

/* start / mission-pick */
btnPickMission.onclick = ()=>{
  if(!state.isHost){ alert('ãƒ›ã‚¹ãƒˆã®ã¿æ“ä½œå¯'); return; }
  openMissionPicker();   // â–¼ æ–°ã—ã„ãƒ”ãƒƒã‚«ãƒ¼è¡¨ç¤º
};

// æ—¢å­˜ã®restartPopã¯ä½¿ã‚ãªã„
btnRestartOk.onclick = ()=>{};
btnRestartCancel.onclick = ()=>{ H(restartPop,true); };

// â–¼ å¤‰æ›´ï¼šçˆ†å¼¾ã‚’è§£é™¤ï¼ ã§ä¸‹éƒ¨ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‹ã
btnStart.onclick = ()=>{ if(!state.isHost) return; openMissionPicker(); };

btnStartCancel.onclick = ()=> H(startPop,true);
btnStartOk.onclick = async ()=>{ const count=clamp(parseInt(selCount.value,10),1,6); const missionId=parseInt(selMission.value,10); H(startPop,true); await startGame(count, missionId); };


/* â–¼â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼å®Ÿè£… â–¼â–¼ */
let mpSelectedCount = 4;

function openMissionPicker(){
  // åˆæœŸäººæ•°ã¯ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ•° or 4
  const v = state.watching;
  mpSelectedCount = clamp(parseInt(v?.tableCount||4,10), 1, 6);

  // äººæ•°ã‚¿ãƒ–ç”Ÿæˆ
  mpCounts.innerHTML = '';
  [2,3,4,5,6].forEach(n=>{
    const tab = document.createElement('div');
    tab.className = 'tab' + (n===mpSelectedCount?' active':'');
    tab.textContent = String(n);
    tab.onclick = ()=>{
      mpSelectedCount = n;
      [...mpCounts.children].forEach(c=>c.classList.remove('active'));
      tab.classList.add('active');
    };
    mpCounts.appendChild(tab);
  });

// ãƒŸãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ç”Ÿæˆï¼ˆ#ä»˜ãæ•°å­—ï¼‰
mpMissions.innerHTML = '';
// 1ã€œ66 å…¨éƒ¨
const missionIds = Array.from({length:66}, (_,i) => i+1);
missionIds.forEach(id=>{
  const b = document.createElement('button');
  b.className = 'btn small';
  b.textContent = `#${id}`; // â˜… #ä»˜ã
  b.onclick = async ()=>{
    await leaveSeatNow();
    closeMissionPicker();
    await startGame(mpSelectedCount, id);
  };
  mpMissions.appendChild(b);
});



  btnMpBack.onclick = ()=> closeMissionPicker();
  H(mp, false);
  // ä»–ã®ãƒãƒƒãƒ—ã¯é–‰ã˜ã‚‹
  H(menuPop, true);
}

function closeMissionPicker(){ H(mp, true); }
/* â–²â–² ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ”ãƒƒã‚«ãƒ¼å®Ÿè£… â–²â–² */

async function startGame(playerCount, missionId){
  if(!state.isHost) return;

  // â˜… å‰ã®ã‚²ãƒ¼ãƒ ç”±æ¥ã®DOMï¼†ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’å®Œå…¨ã‚¯ãƒªã‚¢
  clearMissionOverlays();
  // å¿µã®ãŸã‚ã€ç”»é¢ä¸‹éƒ¨ãƒãƒƒã‚¸ã‚‚æ¶ˆã™
  if(globalReveal){ globalReveal.innerHTML=''; H(globalReveal,true); }

  const code = state.roomCode;


  const captainIndex = Math.floor(Math.random()*playerCount);
  const faces=[1,2,3,4]; shuffle(faces);
  const tables=[]; for(let i=0;i<playerCount;i++){ const face=(i===captainIndex)?'member (5).jpg':`member (${faces[i%4]}).jpg`; tables.push({ titleNumber:i+1, playerId:null, playerName:null, character:{face, flipped:false}, hand:[] }); }

  // ===== ãƒ‡ãƒƒã‚­æ§‹ç¯‰ =====
  let deck=[]; let missionMeta;
  // ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒƒã‚­ 1..12 x4 = 48ï¼ˆé€šå¸¸ã‚³ãƒ¼ãƒ‰ï¼‰
  const base=[]; for(let n=1;n<=12;n++){ for(let k=0;k<4;k++) base.push({id:crypto.randomUUID(), num:n, kind:'normal', open:false, ownerId:null}); }
  shuffle(base);

  // â–¼ ãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ¥ï¼šèµ¤/é»„ã®æ··å…¥ãƒ—ãƒ©ãƒ³ã‚’å–å¾—ï¼†å®Ÿè¡Œ
  const planList = buildMixPlan(missionId);
  const { toAdd, mixLines, chooseLines } = executeMixPlan(planList);

  // #1/#2ã®æ—§å®Ÿè£…ã¯ planList ã§åŒ…å«ã§ãã‚‹ãŒã€äº’æ›ã®ãŸã‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if(missionId===1 && planList.length===0){
    const x = (Math.random()*11|0) + 1;
    toAdd.push({num:x+0.5, kind:'red'});
    mixLines.push(`èµ¤[${x+0.5}]`);
  }
  if(missionId===2 && planList.length===0){
    const x = (Math.random()*11|0) + 1;
    toAdd.push({num:x+0.1, kind:'yellow'});
    mixLines.push(`é»„[${x+0.1}]`);
  }

  // ãƒ‡ãƒƒã‚­åˆæˆ
  deck = base.concat(
    toAdd.map(s => ({ id:crypto.randomUUID(), num:s.num, kind:s.kind, open:false, ownerId:null }))
  );
  shuffle(deck);

  // ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒ¡ã‚¿ç”Ÿæˆï¼ˆèµ¤/é»„ã®çµæœè¡Œã‚’å…ˆé ­ã«å·®ã—è¾¼ã‚€ï¼‰
  missionMeta = missionInfo(missionId, { mixLines, chooseLines });


  // ===== é…å¸ƒ â†’ æ‰‹æœ­æ˜‡é † â†’ Î±ä»˜ä¸ =====
  const alpha="abcdefghijklmnopqrstuvwxyz";
  let p=0; while(p<deck.length){ for(let t=0; t<playerCount && p<deck.length; t++){ const c=deck[p++]; tables[t].hand.push({...c, alpha:'', tokens:[], markUntil:null}); } }
  tables.forEach(T=>{ T.hand.sort((a,b)=> a.num - b.num); T.hand.forEach((c,i)=>{ c.alpha = alpha[i % alpha.length]; }); });

// ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆäººæ•°ã¶ã‚“ï¼‰ â€” ãƒŸãƒƒã‚·ãƒ§ãƒ³è¦å‰‡ã«åˆã‚ã›ã¦å±±æœ­ã‚’ä½œã‚‹
let pool = itemDeckNumbers(missionId);

// â˜… ãƒŸãƒƒã‚·ãƒ§ãƒ³ã®ãƒ•ãƒ©ã‚°ã‚’å…ˆã«ç¢ºèªã—ã¦ limitItemsTo ãŒã‚ã‚Œã° pool ã‚’çµã‚‹
const flagsForItems = missionMeta?.flags || {};
if (Array.isArray(flagsForItems.limitItemsTo) && flagsForItems.limitItemsTo.length > 0) {
  pool = flagsForItems.limitItemsTo.slice(); // ãƒŸãƒƒã‚·ãƒ§ãƒ³18ã¯ [8] ã«ãªã‚‹
}

shuffle(pool);

// #15: æœ€åˆã¯è£å‘ãï¼ˆfaceUp:falseï¼‰ã€‚ãã‚Œä»¥å¤–ã¯é€šå¸¸ã©ãŠã‚Šè¡¨ï¼ˆfaceUp:trueï¼‰
const faceUpStart = !(missionMeta?.flags?.itemsFaceDownStart);

// limitItemsTo ãŒ 1 æšã—ã‹ãªã„å ´åˆã§ã‚‚ãã® 1 æšã‚’å¿…ãšé…ã‚‹
const items = pool
  .slice(0, Math.min(playerCount, pool.length))
  .map(no=>({ id:crypto.randomUUID(), no, used:false, faceUp: faceUpStart }));




  await set(ref(db, `rooms/${code}`), {
    ...(state.watching||baseRoom(state.userId)),
    hostId: state.watching?.hostId || state.userId,
    started:true, tableCount:playerCount, tables, items,
    di:{value:playerCount, max:6}, captainTable: captainIndex, mission: missionMeta,
    meta:{ itemUses:{i1:0,i2:0,i12:0,i14:0}, tokenCounts:{equal:0,noteq:0,x1:0}, i2Flow:null, i18Flow:null, i16Badge:null }
  });

  await setupMissionOnStart(code);   // â˜…è¿½åŠ 

  H(gear,false);
}

/* ==== ãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ==== */
async function setupMissionOnStart(code){
  const snap = await get(ref(db, `rooms/${code}`));
  const v = snap.val(); if(!v?.mission) return;
  const flags = v.mission.flags || {};

  // #9ï¼šå³2 + ãƒ©ãƒ³ãƒ€ãƒ æ•°å€¤2æš
  if(flags.needsRuleRow && flags.rule?.type==='R2with2'){
    const lane = buildNumLaneDOM([
      {kind:'rule', img: imgRule('right2')},
      {kind:'num',  img: imgNumber(randNum())},
      {kind:'num',  img: imgNumber(randNum())}
    ]);
    mountLaneUnderItemsBar(lane);
  }

  // #11ï¼šãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼ˆå±±æœ­â†’ã‚ãã‚‹ï¼‰
  if(flags.needsNumberLane && flags.pattern==='P1'){
    const lane = buildDeckLaneP1();
    mountLaneUnderItemsBar(lane);
  }

  // #12ï¼šå„ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸­å¤®ä¸‹ã«ã€Œ1æšãšã¤ã€å›ºå®šé…ç½®
  if(flags.needsNumberLane && flags.pattern==='P2-eachItem'){
    distributeNumbersToItemsCentered(1); // ä¸€æšãšã¤
  }

 // ===== #13ï¼šèµ¤ã‚³ãƒ¼ãƒ‰3æšã‚’ã€ŒéšŠé•·â†’æ¬¡â†’æ¬¡ã€ã¸ç›´æ¥é…å¸ƒï¼‹åå‰å³ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š =====
  if(v.mission?.flags?.m13_distributeRedToCaptain3){
    const tcount = v.tableCount|0;
    const cap = v.captainTable|0;
    const targets = [cap, (cap+1)%tcount, (cap+2)%tcount];

    // ãƒ©ãƒ³ãƒ€ãƒ ã«èµ¤ã‚³ãƒ¼ãƒ‰ 3 ã¤
    const redList = MATERIALS.redCodes.slice(); shuffle(redList);
    const pick = redList.slice(0,3);

    const tablesSnap = await get(ref(db, `rooms/${code}/tables`));
    const tbls = tablesSnap.val() || [];
    const realpha = (hand)=>{ const alpha='abcdefghijklmnopqrstuvwxyz'; hand.forEach((c,i)=> c.alpha=alpha[i%alpha.length]); };

    targets.forEach((ti, idx)=>{
      const hand = tbls[ti]?.hand || [];
      hand.push({ id:crypto.randomUUID(), num:pick[idx], kind:'red', open:false, ownerId: tbls[ti]?.playerId||null, tokens:[] });
      hand.sort((a,b)=> a.num - b.num);
      realpha(hand);
      tbls[ti].hand = hand;
    });

    // åå‰ã®å³ã®ãƒ©ãƒ³ãƒ€ãƒ æ•°å­—ï¼ˆå„ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
    const header = Array.from({length:tcount}, ()=> MATERIALS.numbers[(Math.random()*12)|0]);

    await Promise.all([
      set(ref(db, `rooms/${code}/tables`), tbls),
      update(ref(db, `rooms/${code}/meta`), { m13_header: header })
    ]);
  }

  // ===== #16ï¼šã€Œå³4ã€ï¼‹ãƒ©ãƒ³ãƒ€ãƒ 3 ã‚’ã‚¢ã‚¤ãƒ†ãƒ ä¸‹ã«æ•·ã =====
  if(v.mission?.flags?.m16_ruleRight4With3){
    const lane = buildNumLaneDOM([
      {kind:'rule', img: imgRule('right4')},
      {kind:'num',  img: imgNumber(randNum())},
      {kind:'num',  img: imgNumber(randNum())},
      {kind:'num',  img: imgNumber(randNum())},
    ]);
    mountLaneUnderItemsBar(lane);
  }

  // ===== #18ï¼šã‚¢ã‚¤ãƒ†ãƒ ã‚’ 8 ã®ã¿ã€ã‹ã¤ P1 å±±æœ­ =====
  if(Array.isArray(v.mission?.flags?.limitItemsTo)){
    const allow = new Set(v.mission.flags.limitItemsTo);
    const nextItems = (v.items||[]).filter(it => allow.has(it.no));
    await set(ref(db, `rooms/${code}/items`), nextItems);
  }

  // ===== #20ï¼šå„ãƒ†ãƒ¼ãƒ–ãƒ«ã§ 1 æšã‚’å³ç«¯ã¸ç§»å‹•ã—ã€é»„è‰²âœ•ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸ =====
  if(v.mission?.flags?.m20_rightmostX){
    const tablesSnap = await get(ref(db, `rooms/${code}/tables`));
    const tbls = tablesSnap.val() || [];
    const alphaStr='abcdefghijklmnopqrstuvwxyz';
    tbls.forEach(T=>{
      const hand = (T.hand||[]).slice().sort((a,b)=> a.num - b.num); // æ˜‡é †ãƒ™ãƒ¼ã‚¹
      if(hand.length===0) return;
      const ri = (Math.random()*hand.length)|0;
      const chosen = hand.splice(ri,1)[0];
      hand.push(chosen); // å³ç«¯ã¸
      // âœ•ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆé»„è‰²ï¼‰ã‚’ãã®ã‚«ãƒ¼ãƒ‰ã«ä»˜ä¸
      chosen.tokens = [...(chosen.tokens||[]), {type:'xmark', value:'âœ•', style:'yellowX'}];
      // Î±å†ä»˜ä¸
      hand.forEach((c,i)=> c.alpha = alphaStr[i%alphaStr.length]);
      T.hand = hand;
    });
    await set(ref(db, `rooms/${code}/tables`), tbls);
  }
  

  function randNum(){ return MATERIALS.numbers[(Math.random()*12)|0]; }
}

/* ==== æ•°å€¤ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==== */
function buildNumLaneDOM(cells){
  const lane = document.createElement('div'); lane.className='numlane';
  cells.forEach(c=>{
    const div = document.createElement('div');
    if(c.kind==='rule'){ div.className='rulecard'; div.style.backgroundImage=`url('${c.img}')`; }
    if(c.kind==='num'){  div.className='numcard';  div.style.backgroundImage=`url('${c.img}')`; }
    lane.appendChild(div);
  });
  return lane;
}
function mountLaneUnderItemsBar(lane){
  const bar = document.getElementById('itemsBar');
  bar.insertAdjacentElement('afterend', lane);
}

/* ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼šå±±æœ­â†’ã‚ãã‚‹ */
function buildDeckLaneP1(){
  const lane = document.createElement('div'); 
  lane.className='numlane';

  // 1..12 ã®ã¿ãƒ»é‡è¤‡ãªã—ã®å±±æœ­
  const deck = MATERIALS.numbers.slice(); 
  shuffle(deck);
  let rest = deck.length;

  // å±±æœ­ãƒœã‚¿ãƒ³ã¨æ®‹è¡¨ç¤º
  const deckBtn = document.createElement('div');
  deckBtn.className='numdeck';
  deckBtn.title='ã‚ãã‚‹';

  const restLbl = document.createElement('span');
  restLbl.className='numrest';
  restLbl.textContent=`æ®‹:${rest}`;

  // â˜… å³å´ã«å…¬é–‹æœ­ç©ã¿é‡ã­ç”¨ãƒ›ãƒ«ãƒ€ãƒ¼
  const pile = document.createElement('div');
  pile.className = 'numcard-holder';
  pile.style.position = 'relative';

  lane.appendChild(deckBtn);
  lane.appendChild(restLbl);
  lane.appendChild(pile);

  // ç©ã¿é‡ã­è¿½åŠ 
  function addToPile(n){
    const already = pile.querySelectorAll('.numcard').length;
    const node = document.createElement('div');
    node.className = 'numcard';
    node.style.backgroundImage = `url('${imgNumber(n)}')`;

    if(already>0){
      const off = already * 2; // 2pxåˆ»ã¿
      node.style.position = 'absolute';
      node.style.left = off + 'px';
      node.style.top  = off + 'px';
    }
    pile.appendChild(node);

    // â˜… é«˜ã•èª¿æ•´ï¼ˆè¦‹åˆ‡ã‚Œé˜²æ­¢ï¼‰
    const extraH = already * 2; // ä¸‹æ–¹å‘ã¸ã®ã‚ºãƒ¬åˆ†
    pile.style.height = (48 + extraH) + 'px'; // 48pxã¯ã‚«ãƒ¼ãƒ‰é«˜ã•
    lane.style.marginBottom = extraH + 'px'; // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å°‘ã—ä¸‹ã’ã‚‹
  }

  deckBtn.onclick = (ev)=>{
    if(rest<=0){
      openOneMini(ev.clientX, ev.clientY, 'å±±æœ­ã‚’ä½œã‚‹', async ()=>{
        deck.splice(0, deck.length, ...MATERIALS.numbers.slice()); 
        shuffle(deck);
        rest = deck.length;
        restLbl.textContent = `æ®‹:${rest}`;
        deckBtn.style.backgroundImage = `url('./numberdeck.png')`;
        deckBtn.style.background = '';
        deckBtn.title = 'ã‚ãã‚‹';
        pile.innerHTML = '';
        pile.style.height = '48px';
        lane.style.marginBottom = '0px';
        NUMCARD_REG.clear();
      });
      return;
    }

    const n = deck.pop();
    rest--;
    restLbl.textContent = `æ®‹:${rest}`;
    addToPile(n);

    if(rest===0){
      deckBtn.style.background = `#fff url('${imgBack}') center/60% no-repeat`;
      deckBtn.title='å±±æœ­ã‚’ä½œã‚‹';
    }
  };

  return lane;
}

/* ãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼šãƒ‡ãƒƒã‚­ã‹ã‚‰næšâ†’ä¸¦ã¹ã‚‹ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ä¸‹ï¼‰ */
function buildDeckLaneP2(n=2){
  const lane = document.createElement('div'); lane.className='numlane';
  const deck = MATERIALS.numbers.slice(); shuffle(deck);
  const picks = deck.slice(0, n);
  picks.forEach(x=>{
    const nc = document.createElement('div'); nc.className='numcard'; nc.style.backgroundImage=`url('${imgNumber(x)}')`;
    lane.appendChild(nc);
  });
  return lane;
}

/* ãƒ‘ã‚¿ãƒ¼ãƒ³3ï¼šæŒ‡å®šã‚«ãƒ¼ãƒ‰ã‚’å›ºå®šä¸¦ã¹ï¼ˆå¿…è¦æ™‚ï¼‰ */
function buildFixedLane(list){
  return buildNumLaneDOM(list.map(n=>({kind:'num',img:imgNumber(n)})));
}


  
function missionInfo(id, opts={}){
  const mixLines = opts.mixLines || [];     // ä¾‹: ['èµ¤[1.5]', 'é»„[2.1][5.1]']
  const chooseLines = opts.chooseLines || [];// ä¾‹: ['èµ¤ã‚³ãƒ¼ãƒ‰[1.5] [3.5] ã®ã†ã¡1ã¤']
  const linesForMix = [...mixLines, ...chooseLines]; // è¡¨ç¤ºã®å…ˆé ­ã«å·®ã—è¾¼ã‚€

  switch(id){
    case 1:{ // èµ¤ã‚³ãƒ¼ãƒ‰1
      return {
        id:1, name:'#1 çˆ†å¼¾ï¼ˆèµ¤ã‚³ãƒ¼ãƒ‰ï¼‰', desc:'', 
        display: ['#1 çˆ†å¼¾ï¼ˆèµ¤ã‚³ãƒ¼ãƒ‰ï¼‰', ...linesForMix],
      };
    }
    case 2:{ // é»„ã‚³ãƒ¼ãƒ‰1
      return {
        id:2, name:'#2 é»„ã‚³ãƒ¼ãƒ‰', desc:'',
        display: ['#2 é»„ã‚³ãƒ¼ãƒ‰', ...linesForMix],
      };
    }
    case 3:{
      const list=[1.5,2.5,3.5,4.5,5.5,6.5,7.5,8.5,9.5,10.5,11.5]; shuffle(list);
      const pick=list.slice(0,3);
      return {
        id:3, name:'#3 ã•ã‚‰ã„çˆ†å¼¾', desc:'',
        display:[ '#3 ã•ã‚‰ã„çˆ†å¼¾', `${pick[0]} â€“ ${pick[1]} - ${pick[2]} ã®ã†ã¡1ã¤`, ...linesForMix ],
      };
    }

    /* === #9ã€œ#12ï¼ˆæŒ‡å®šã®å¼•ç”¨æ–‡ã¨èµ¤/é»„è¡¨ç¤ºã‚’åˆæˆï¼‰=== */
    case 9: {
      return {
        id:9, name:'#9 aaa', desc:'',
        display: [
          '#9 aaa',
          ...linesForMix, // â† èµ¤1ãƒ»é»„2ã®çµæœï¼ˆèµ¤[1.5] / é»„[2.1][â€¦] ãªã©ï¼‰
          'æœ€åˆã®å·¦ã«ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°ã€å³ã«ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã§ããªã„ã€‚',
          'æ‰‹ç•ªã«åˆ‡æ–­ã§ãã‚‹ã‚³ãƒ¼ãƒ‰ãŒãªã‘ã‚Œã°èµ·çˆ†ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’1é€²ã‚ã‚‹ã€‚'
        ],
        flags: { needsRuleRow:true, rule: { type:'R2with2', rightCount:2 } }
      };
    }
    case 10: {
      return {
        id:10, name:'#10 bbb', desc:'',
        display: [
          '#10 bbb',
          ...linesForMix,
          '15åˆ†ä»¥å†…ã«è§£é™¤ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼',
          'æ™‚è¨ˆå›ã‚Šã§ã¯ãªãã€æ‰‹ç•ªã‚’è¡Œã„ãŸã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã€Œãƒãƒ§ã‚­ãƒ³ï¼ã€ã¨è¨€ã£ã¦ã‹ã‚‰ã€åˆ‡æ–­ã‚’å®Ÿè¡Œã™ã‚‹ã€‚',
          '2äººã«ãªã£ãŸå ´åˆã‚’é™¤ã„ã¦ã€é€£ç¶šã§æ‰‹ç•ªã‚’ãƒ—ãƒ¬ã‚¤ã§ããªã„ã€‚'
        ],
        flags: { timed:true, freeTurnCall:true }
      };
    }
    case 11: {
      return {
        id:11, name:'#11 ccc', desc:'',
        display: [
          '#11 ccc',
          ...linesForMix,
          'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ã¯å…¨ã¦èµ¤ã‚³ãƒ¼ãƒ‰ã¨è¦‹ãªã•ã‚Œã‚‹ã€‚',
          'æ‰‹æœ­ãŒã“ã®ã‚³ãƒ¼ãƒ‰ã ã‘ã«ãªã£ãŸå ´åˆã€å…¬é–‹ã—ã¦æ‰‹ç•ªã‚’çµ‚ãˆã‚‰ã‚Œã‚‹ã€‚'
        ],
        flags: { numberAsRed:true, needsNumberLane:true, pattern:'P1' }
      };
    }
    case 12: {
      return {
        id:12, name:'#12', desc:'',
        display: [
          '#12',
          ...linesForMix,
          'ãã‚Œãã‚Œã®è£…å‚™ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«æ•°å€¤ã‚«ãƒ¼ãƒ‰ã‚’ç½®ãã€‚',
          'ãã®è£…å‚™ã‚’ä½¿ã†ã«ã¯ãã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã¨ã€è£…å‚™ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã‚’2æœ¬ãšã¤è§£é™¤ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚'
        ],
        flags: { needsNumberLane:true, pattern:'P2-eachItem' }
      };
    }
    case 13: {
      return {
        id:13, name:'#13', desc:'',
        display:[
          '#13',
          ...linesForMix,
          'èµ¤ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§3ã¤é¸ã³ã€éšŠé•·â†’æ¬¡â†’æ¬¡ã®3äººã«1ã¤ãšã¤é…å¸ƒã™ã‚‹ã€‚',
          'å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã®å³ã« 1~12 ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§1ã¤è¡¨ç¤ºã—ã€ãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã§åŒã˜æ•°å­—ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ãŒä½¿ç”¨ã•ã‚ŒãŸã‚‰æ¶ˆãˆã‚‹ã€‚',
          'ã€Œæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«1æšå¼•ã„ã¦ã‚³ãƒ¼ãƒ‰ã®å‰ã«ç½®ãã€ã€ŒéšŠé•·ã‹ã‚‰é †ã«èµ¤ã‚³ãƒ¼ãƒ‰ã‚’1æšãšã¤é…å¸ƒã€',
          'ã€Œèª°ã§ã‚‚èµ¤ã‚³ãƒ¼ãƒ‰ã®å ´æ‰€ã‚’3ã¤åŒæ™‚ã«æŒ‡æ‘˜ã—ã¦è§£é™¤ã§ãã‚‹ãŒã€é–“é•ãˆã‚‹ã¨çˆ†ç™ºã€ã€Œèµ¤ã‚³ãƒ¼ãƒ‰ã®åˆ‡æ–­ã«ã‚¢ã‚¤ãƒ†ãƒ ã¯ä½¿ç”¨ä¸å¯ã€'
        ],
        flags:{ m13_distributeRedToCaptain3:true, m13_headerRandomInfoToken:true, m13_autoHideHeaderToken:true }
      };
    }

    case 14: {
      return {
        id:14, name:'#14', desc:'',
        display:[
          '#14', ...linesForMix,
          'éšŠé•·ã‚«ãƒ¼ãƒ‰ã®æŒã¡ä¸»ã¯ã€Œæ–°äººã€ã¨ãªã‚‹ã€‚',
          'æ–°äººãŒåˆ‡æ–­ã«å¤±æ•—ã™ã‚‹ã¨çˆ†ç™ºã™ã‚‹ã€‚',
          'æ–°äººã¯ã€Œä¸‡èƒ½æ°·ã€ãŒä½¿ãˆãªã„ã€‚'
        ],
        flags:{ m14_rookieIsCaptain:true }
      };
    }

    case 15: {
      return {
        id:15, name:'#15', desc:'',
        display:[
          '#15', ...linesForMix,
          'æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®æ•°å­—ã¨åŒã˜æ•°å­—ã®ã‚³ãƒ¼ãƒ‰ã‚’4æœ¬åˆ‡æ–­ã—ãŸæ™‚ã€å³åº§ã«1æšç›®ã®è£…å‚™ã‚«ãƒ¼ãƒ‰ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚',
          'æ¬¡ã«ã‚ãã‚‹æ•°å€¤ãŒå…¨ã¦åˆ‡æ–­æ¸ˆã¿ãªã‚‰å¼•ãç›´ã™ã€‚'
        ],
        flags:{ itemsFaceDownStart:true, needsNumberLane:true, pattern:'P1' }
      };
    }

    case 16: {
      return {
        id:16, name:'#16', desc:'',
        display:[
          '#16', ...linesForMix,
          'å·¦å´ã®æ•°å€¤ã‚«ãƒ¼ãƒ‰ã¨åŒã˜æ•°å­—ã®ã‚³ãƒ¼ãƒ‰4æœ¬ã‚’åˆ‡æ–­ã—ãªã‘ã‚Œã°å³ã®æ•°å€¤ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡æ–­ã§ããªã„ã€',
          'æ‰‹ç•ªã«åˆ‡æ–­ã§ãã‚‹ã‚³ãƒ¼ãƒ‰ãŒãªã‘ã‚Œã°çˆ†ç™ºã™ã‚‹'
        ],
        flags:{ m16_ruleRight4With3:true }
      };
    }

    case 17: {
      return {
        id:17, name:'#17', desc:'',
        display:[
          '#17', ...linesForMix,
          'éšŠé•·ã‚«ãƒ¼ãƒ‰ã®æŒã¡ä¸»ã¯ã€Œã‚»ãƒ«ã‚¸ã‚ªãƒ»ã‚¨ãƒ«ãƒ»ãƒŸãƒˆãƒ¼ã€ã¨ãªã‚‹ã€‚',
          'ã€Œã‚»ãƒ«ã‚¸ã‚ªã€ã¯æœ€åˆã«èª¤ã£ãŸæƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’2æšç½®ãã€‚',ã€€ã€€
          'ã€Œã‚»ãƒ«ã‚¸ã‚ªã€ã¯ã€Œãƒ•ãƒ„ãƒ¼ãƒæ¢çŸ¥æ©Ÿã€ã‚„ä»–ã®è£…å‚™ãŒä½¿ãˆãªã„ã€‚'
        ],
        flags:{ m17_captainInverseNumberPop:true }
      };
    }

    case 18: {
      return {
        id:18, name:'#18', desc:'',
        display:[
          '#18', ...linesForMix,
          'ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç½®ã‹ãªã„',
          'â‘ æ‰‹ç•ªé–‹å§‹æ™‚ã«æ•°å€¤ã‚«ãƒ¼ãƒ‰ã®å±±æœ­ã‹ã‚‰1æšã‚ãã‚‹ã€‚',
          'â‘¡æ‰‹ç•ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ãã®æ•°å­—ã§ã€Œãªã‚“ã§ã‚‚ãƒ¬ãƒ¼ãƒ€ãƒ¼ã€ã‚’ä½¿ç”¨ã—ãŸå¾Œã€åˆ‡æ–­å½¹ã‚’æ±ºã‚ã‚‹ã€‚',
        ],
        flags:{ limitItemsTo:[8], needsNumberLane:true, pattern:'P1' }
      };
    }

    case 19: {
      return {
        id:19, name:'#19', desc:'',
        display:[ '#19', ...linesForMix, 'éŸ³å£°ã‚’èã“ã†ã€‚' ],
        flags:{}
      };
    }

    case 20: {
      return {
        id:20, name:'#20', desc:'',
        display:[
          '#20', ...linesForMix,
          'ãƒ©ãƒ³ãƒ€ãƒ ã®ã‚³ãƒ¼ãƒ‰ã‚’å³å´ã«é…ç½®ã™ã‚‹ã€‚',
          'âœ•ãƒˆãƒ¼ã‚¯ãƒ³ãŒç½®ã‹ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã«ã¯ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ç”¨ã§ããªã„ã€‚'
        ],
        flags:{ m20_rightmostX:true }
      };
    }

    case 21: {
      return {
        id:21, name:'#21', desc:'',
        display:[
          '#21', ...linesForMix,
          'æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã¯å¶æ•°ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ2/4ï¼‰ã‹å¥‡æ•°ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ1/3ï¼‰ã‚’ä½¿ã†ã€‚'
        ],
        flags:{ useParityToken:true }
      };
    }

    case 22: {
      return {
        id:22, name:'#22', desc:'',
        display:[
          '#22', ...linesForMix,
          'å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åå‰ã®ä¸‹ã«å°ã•ã„ç©ºãƒœã‚¿ãƒ³ãŒ3ã¤ã‚ã‚‹ã€‚è‡ªåˆ†ã®æ‰‹æœ­ã«ç„¡ã„æ•°å­—ã®ã¿é¸ã¹ã‚‹ï¼ˆæ¶ˆã™å¯ï¼‰ã€‚',
          'é»„ã‚«ãƒ¼ãƒ‰ãŒ2ç¨®é¡å…¬é–‹ã•ã‚ŒãŸç¬é–“ã€1~12ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨æ•°ã‚’é›†è¨ˆã—ã€2Ã—6è¡¨ã§ã€Œ0/1/2ã€ï¼ˆè¦å‰‡ä¸‹è¨˜ï¼‰ã‚’è¡¨ç¤ºã™ã‚‹ã€‚',
          'è¡¨ç¤ºè¦å‰‡ï¼šä½¿ç”¨1æšâ†’ã€Œ1ã€ã€ä½¿ç”¨2æšä»¥ä¸Šâ†’ã€Œ0ã€ã€ä½¿ç”¨0æšâ†’ã€Œ2ã€ã€‚è¡¨ã¯ã‚¿ãƒƒãƒ—â†’ã€Œéš ã™ã€ã§æ¶ˆãˆã‚‹ã€‚å³ä¸‹ã®è¨­å®šã‹ã‚‰å†è¡¨ç¤ºå¯ã€‚',
          'æŒ‡ç¤ºï¼šã€Œæ‰‹å…ƒã«ãªã„æ•°å­—ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‚’2æšé¸ã³ã€æ‰‹å…ƒã«ç½®ã„ã¦ãŠãã€ã€‚',
          'æŒ‡ç¤ºï¼šã€Œæœ€åˆã®2æœ¬ã®é»„ã‚³ãƒ¼ãƒ‰ãŒè§£é™¤ã•ã‚ŒãŸã‚‰ã€å…¨å“¡ãŒæœªä½¿ç”¨ã®æƒ…å ±ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰1æšé¸ã³ã€æ¬¡æ‰‹ç•ªã®äººã«ä½¿ã£ã¦ã‚‚ã‚‰ã†ï¼ˆå¯¾è±¡ã‚³ãƒ¼ãƒ‰ãŒç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼‰ã€ã€‚'
        ],
        flags:{
          m22_pick3:true,
          m22_showTableAfter2Yellows:true,
          m22_allowInfoTableFromMenu:true
        }
      };
    }



      
    case 42:{ return {id:42, name:'#42', desc:'', display:['#42', ...linesForMix, 'ç‰¹æ®Šãªã—']}; }
    case 43:{ return {id:43, name:'#43', desc:'', display:['#43', ...linesForMix, 'ç‰¹æ®Šãªã—']}; }
    default:  { return {id, name:`#${id}`, desc:'', display:[`#${id}`, ...linesForMix]}; }
  }
}


// ç”»é¢ã‚¿ãƒƒãƒ—ã§å„ç¨®ãƒãƒƒãƒ—ã¯å¤–å´ã‚¿ãƒƒãƒ—ã§æ¶ˆãˆã‚‹
 document.addEventListener('click',(e)=>{ if(!miniPop.contains(e.target)) H(miniPop,true); }, true);
</script>
</body>
</html>
